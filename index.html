<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 16px 35px rgba(15, 23, 42, 0.6);
      --blur-strong: blur(18px);

      --bg-gradient: radial-gradient(circle at top left, #0f172a 0, #020617 45%, #000000 100%);
      --card-bg: rgba(15, 23, 42, 0.94);
      --card-border: rgba(148, 163, 184, 0.4);
      --accent: #6366f1;
      --accent-soft: rgba(99, 102, 241, 0.12);
      --accent-2: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --chip-bg: rgba(15, 23, 42, 0.9);
    }

    :root[data-theme="light"] {
      --bg-gradient: radial-gradient(circle at top left, #e5f0ff 0, #f9fafb 40%, #e5e7eb 100%);
      --card-bg: #ffffff;
      --card-border: #d1d5db;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.06);
      --accent-2: #16a34a;
      --text-main: #111827;
      --text-muted: #6b7280;
      --chip-bg: #f3f4f6;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    .hidden { display: none; }

    /* ===== topbar ===== */
    .topbar {
      height: 56px;
      backdrop-filter: blur(18px);
      background: linear-gradient(to right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.8));
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 16px;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .topbar-logo {
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      border-radius: 10px;
      padding: 5px 9px;
      font-weight: 700;
      margin-right: 14px;
      font-size: 12px;
      cursor: pointer;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      box-shadow: 0 10px 24px rgba(22, 163, 74, 0.45);
    }
    .topbar-title {
      font-weight: 600;
      margin-right: 24px;
      font-size: 15px;
    }
    .topbar-nav {
      display: flex;
      gap: 10px;
      font-size: 13px;
    }
    .topbar-nav-item {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      padding: 4px 9px;
      border-radius: 999px;
      transition: 0.16s ease;
    }
    .topbar-nav-item:hover,
    .topbar-nav-item.active {
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
    }
    .topbar-nav-item span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .topbar-spacer {
      flex: 1;
    }

    .topbar-notifications {
      position: relative;
      margin-right: 8px;
    }
    .bell-btn {
      position: relative;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .bell-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 16px;
      padding: 0 4px;
      height: 16px;
      border-radius: 999px;
      background: #ef4444;
      color: #f9fafb;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .notifications-panel {
      position: absolute;
      top: 40px;
      right: 0;
      width: 280px;
      max-height: 320px;
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--card-border);
      box-shadow: 0 18px 40px rgba(15,23,42,0.7);
      padding: 8px;
      display: flex;
      flex-direction: column;
      font-size: 12px;
      z-index: 30;
    }
    .notifications-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .notifications-header span {
      font-weight: 600;
      font-size: 12px;
    }
    .notifications-actions {
      display: flex;
      gap: 4px;
      font-size: 11px;
    }
    .notif-chip-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.96);
      color: var(--text-muted);
      padding: 2px 6px;
      cursor: pointer;
    }
    .notifications-list {
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .notif-item {
      padding: 6px 6px;
      border-radius: 10px;
      border: 1px solid rgba(51,65,85,0.8);
      background: rgba(15,23,42,0.96);
      margin-bottom: 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .notif-item.new {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.3);
    }
    .notif-main {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .notif-text {
      font-size: 12px;
    }
    .notif-time {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    :root[data-theme="light"] .topbar {
      background: linear-gradient(to right, #ffffff, #e5edff);
      border-bottom-color: #d1d5db;
      color: #111827;
    }
    :root[data-theme="light"] #theme-toggle {
      background: #f3f4f6;
      color: #111827;
      border-color: #d1d5db;
    }
    :root[data-theme="light"] .topbar-right {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    :root[data-theme="light"] .bell-btn {
      background: #f9fafb;
      border-color: #d1d5db;
      color: #111827;
    }
    :root[data-theme="light"] .notifications-panel {
      background: #ffffff;
      border-color: #d1d5db;
      box-shadow: 0 18px 40px rgba(148,163,184,0.5);
    }
    :root[data-theme="light"] .notif-item {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .topbar-right {
      margin-left: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 12px;
    }
    .avatar-small {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      overflow: hidden;
      background: #1f2937;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }
    .avatar-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #theme-toggle {
      margin-left: 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      padding: 4px 9px;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* ===== layout ===== */
    .layout {
      display: flex;
      min-height: calc(100vh - 56px);
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 12px 24px;
      gap: 14px;
    }

    .sidebar {
      width: 210px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 14px 10px 12px;
      font-size: 14px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: var(--blur-strong);
    }
    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      padding: 6px;
      border-radius: var(--radius-md);
      transition: 0.16s ease;
    }
    .sidebar-user:hover { background: rgba(15, 23, 42, 0.96); }
    .avatar {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .sidebar-user-name { font-weight: 600; font-size: 14px; }
    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin: 8px 6px 4px;
      letter-spacing: 0.08em;
    }
    .sidebar-item {
      padding: 7px 8px;
      border-radius: 9px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-muted);
      transition: 0.16s ease;
      font-size: 13px;
    }
    .sidebar-item:hover { background: rgba(15, 23, 42, 0.96); color: #e5e7eb; }
    .sidebar-item.active {
      background: var(--accent-soft);
      border: 1px solid rgba(129, 140, 248, 0.7);
      color: #e5e7eb;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .panel {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: var(--blur-strong);
      font-size: 14px;
    }

    :root[data-theme="light"] .sidebar {
      background: #ffffff;
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.3);
    }
    :root[data-theme="light"] .panel {
      background: #ffffff;
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.3);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .panel-title { font-weight: 600; font-size: 15px; }
    .panel-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 3px; }

    .tabs {
      display: flex;
      border-bottom: 1px solid rgba(51, 65, 85, 0.7);
      margin-bottom: 10px;
      gap: 10px;
      font-size: 13px;
    }
    .tab {
      padding: 0 0 6px;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: 0.16s ease;
    }
    .tab.active {
      color: var(--text-main);
      border-color: var(--accent);
      font-weight: 500;
    }

    .quarter-switcher, .week-switcher {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .quarter-btn, .week-btn {
      font-size: 12px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-muted);
      cursor: pointer;
      transition: 0.15s ease;
    }
    .quarter-btn.active, .week-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #e5e7eb;
    }

    .day-block {
      margin-top: 10px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.9);
      padding: 8px 8px 6px;
      border: 1px dashed rgba(75, 85, 99, 0.85);
    }
    .day-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .day-icon {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: rgba(148, 163, 184, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    :root[data-theme="light"] .day-block {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .lesson-card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 11px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 7px 9px;
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .lesson-teacher {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      overflow: hidden;
      margin-right: 8px;
      flex-shrink: 0;
      background: #020617;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }
    .lesson-teacher img { width: 100%; height: 100%; object-fit: cover; }
    .lesson-main { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .lesson-subject { font-size: 13px; font-weight: 500; display:flex; align-items:center; gap:6px; }
    .lesson-type { font-size: 11px; color: var(--text-muted); }
    .lesson-more {
      font-size: 14px;
      color: rgba(148, 163, 184, 0.9);
      cursor: pointer;
      margin-left: 6px;
      padding: 3px;
      border-radius: 999px;
    }
    .lesson-more:hover {
      background: rgba(15, 23, 42, 0.96);
      color: #fecaca;
    }

    :root[data-theme="light"] .lesson-card {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    .badge {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:#0b1120;
    }
    .badge-math { background:#fbbf24; }
    .badge-ru   { background:#f97316; }
    .badge-eng  { background:#38bdf8; }
    .badge-it   { background:#22c55e; }
    .badge-sci  { background:#a855f7; }
    .badge-geo  { background:#2dd4bf; }
    .badge-hist { background:#f97373; }
    .badge-pe   { background:#4ade80; }
    .badge-other{ background:#e5e7eb; }

    .grade-form {
      margin-top: 12px;
      padding: 9px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.08), rgba(15, 23, 42, 0.96));
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 12px;
      border: 1px solid rgba(37, 99, 235, 0.5);
    }
    :root[data-theme="light"] .grade-form {
      background: #eef2ff;
      border-color: #c7d2fe;
    }
    .grade-form input,
    .grade-form select {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 12px;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      outline: none;
      min-width: 120px;
    }

    .btn {
      padding: 5px 11px;
      border-radius: var(--radius-pill);
      border: none;
      background: radial-gradient(circle at top left, #4f46e5, #1d4ed8);
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.55);
      white-space: nowrap;
    }
    .btn.secondary {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: none;
    }

    .profile-grid { display: grid; grid-template-columns: 210px 1fr; gap: 16px; }
    .profile-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 14px;
      text-align: center;
      box-shadow: var(--shadow-soft);
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 999px;
      overflow: hidden;
      margin: 0 auto 10px;
      background: #020617;
      border: 2px solid rgba(129, 140, 248, 0.9);
      box-shadow: 0 10px 26px rgba(79, 70, 229, 0.7);
    }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .profile-main {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 14px;
      font-size: 13px;
      box-shadow: var(--shadow-soft);
    }
    .profile-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
      font-size: 13px;
    }
    .profile-label { color: var(--text-muted); }
    .profile-form { margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(30, 41, 59, 0.9); }
    .profile-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
      font-size: 12px;
    }
    .profile-form input {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      font-size: 12px;
      min-width: 180px;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      outline: none;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
    th, td { border-bottom: 1px solid rgba(30, 41, 59, 0.95); padding: 6px 5px; text-align: left; }
    th {
      background: rgba(15, 23, 42, 0.98);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.08em;
    }

    .day-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .day-tab {
      font-size: 12px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.96);
      color: var(--text-muted);
      cursor: pointer;
      transition: 0.15s ease;
    }
    .day-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #e5e7eb;
    }

    :root[data-theme="light"] .day-tab {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #4b5563;
    }
    :root[data-theme="light"] .day-tab.active {
      background: #4f46e5;
      border-color: #4f46e5;
      color: #f9fafb;
    }

    .task-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 13px;
    }
    .task-row.done {
      opacity: 0.7;
      text-decoration: line-through;
      border-color: rgba(22, 163, 74, 0.9);
    }
    .task-row input[type="checkbox"] {
      margin-top: 2px;
      cursor: pointer;
    }
    .task-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    :root[data-theme="light"] .task-row {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    .tasks-filter {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      margin-bottom:8px;
    }
    .tasks-filter select {
      padding:4px 7px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.96);
      color:#e5e7eb;
      font-size:12px;
      outline:none;
    }
    :root[data-theme="light"] .tasks-filter select {
      background:#ffffff;
      border-color:#d1d5db;
      color:#111827;
    }

    #rating-history { margin-top: 12px; font-size: 12px; }

    /* auth panel */
    #auth-panel.panel {
      max-width: 360px;
      margin: 40px auto;
    }

    /* –í–µ—Ä—Ö–Ω–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä */
    .top-ad-banner {
      width: 100%;
      background: linear-gradient(90deg, #f97316, #ec4899);
      color: #f9fafb;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 13px;
      position: sticky;
      top: 0;
      z-index: 25;
      box-shadow: 0 8px 20px rgba(15,23,42,0.8);
    }
    .top-ad-text {
      max-width: 900px;
      text-align: center;
    }
    .top-ad-strong {
      font-weight: 600;
    }
    .top-ad-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    .top-ad-close {
      margin-left: 8px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.25);
      color: #f9fafb;
      cursor: pointer;
      font-size: 14px;
    }
    :root[data-theme="light"] .top-ad-banner {
      background: linear-gradient(90deg, #fed7aa, #f9a8d4);
      color: #111827;
    }
    :root[data-theme="light"] .top-ad-btn {
      background: #111827;
      color: #f9fafb;
    }
    :root[data-theme="light"] .top-ad-close {
      background: rgba(15,23,42,0.08);
      color: #111827;
    }

    /* TGK –±–∞–Ω–Ω–µ—Ä —Å–Ω–∏–∑—É */
    .tgk-banner {
      position: fixed;
      bottom: 16px;
      right: 16px;
      max-width: 320px;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.25), rgba(15,23,42,0.98));
      border-radius: 18px;
      border: 1px solid rgba(129,140,248,0.9);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      padding: 10px 12px 10px 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 50;
      color: #e5e7eb;
      backdrop-filter: blur(18px);
    }
    .tgk-banner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid rgba(34,197,94,0.85);
      flex-shrink: 0;
    }
    .tgk-banner-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .tgk-banner-body {
      flex: 1;
      font-size: 12px;
    }
    .tgk-banner-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 13px;
    }
    .tgk-banner-footer {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }
    .tgk-banner-pill {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }
    .tgk-banner-go {
      font-size: 12px;
      padding: 4px 9px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: #0b1120;
      font-weight: 600;
      cursor: pointer;
    }
    .tgk-banner-close {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 14px;
      flex-shrink: 0;
    }
    :root[data-theme="light"] .tgk-banner {
      background: radial-gradient(circle at top left, #e0f2fe, #eef2ff);
      border-color: #bfdbfe;
      color: #0f172a;
    }
    :root[data-theme="light"] .tgk-banner-pill {
      background:#ffffff;
      border-color:#cbd5f5;
      color:#0f172a;
    }
    :root[data-theme="light"] .tgk-banner-close {
      background:#ffffff;
      border-color:#e5e7eb;
      color:#111827;
    }

    /* responsive */
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .sidebar { width: 100%; display: flex; flex-wrap: wrap; gap: 6px; }
      .sidebar-section-title { width: 100%; }
      .topbar-spacer { display:none; }
    }
    @media (max-width: 640px) {
      .topbar-title { display: none; }
      .profile-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- –ë–æ–ª—å—à–æ–π –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä -->
  <div id="top-ad-banner" class="top-ad-banner">
    <div class="top-ad-text">
      <span class="top-ad-strong">–†–µ–∫–ª–∞–º–∞:</span>
      –£—Å—Ç–∞–ª –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –∏ –î–ó? –ü–æ–ø—Ä–æ–±—É–π ¬´TGK Premium¬ª ‚Äî –¥–Ω–µ–≤–Ω–∏–∫ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —Å –∫—Ä–∞—Å–∏–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –±–æ–Ω—É—Å–∞–º–∏.
    </div>
    <button id="top-ad-go-btn" class="top-ad-btn">–£–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    <button id="top-ad-close-btn" class="top-ad-close" title="–°–∫—Ä—ã—Ç—å –±–∞–Ω–Ω–µ—Ä">‚úï</button>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <section id="auth-panel" class="panel">
    <h2 style="margin-bottom:8px;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <p class="panel-subtitle" style="margin-bottom:10px;">
      –í–≤–µ–¥–∏ email –∏ –ø–∞—Ä–æ–ª—å. ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª —Å–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç, ¬´–í—Ö–æ–¥¬ª –ª–æ–≥–∏–Ω–∏—Ç, ¬´–í—ã–π—Ç–∏¬ª ‚Äî –≤—ã—Ö–æ–¥.
    </p>
    <div style="display:flex;flex-direction:column;gap:6px;font-size:13px;">
      <input id="auth-email" type="email" placeholder="Email"
             style="padding:6px 8px;border-radius:8px;border:1px solid rgba(55,65,81,0.9);">
      <input id="auth-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å"
             style="padding:6px 8px;border-radius:8px;border:1px solid rgba(55,65,81,0.9);">
      <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;">
        <button class="btn" id="auth-login-btn">–í—Ö–æ–¥</button>
        <button class="btn secondary" id="auth-signup-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button class="btn secondary" id="auth-logout-btn">–í—ã–π—Ç–∏</button>
      </div>
      <div id="auth-error" style="color:#f97373;font-size:12px;margin-top:4px;"></div>
    </div>
  </section>

  <!-- –í—Å—è –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —Å–∞–π—Ç–∞ -->
  <div id="app-root" class="hidden">
    <div class="topbar">
      <div class="topbar-logo" data-page="grades">—à–∫–æ–ª–∞</div>
      <div class="topbar-title" id="topbar-title">–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</div>

      <div class="topbar-nav">
        <div class="topbar-nav-item" data-page="schedule">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="topbar-nav-item" data-page="tasks">–ó–∞–¥–∞–Ω–∏—è</div>
        <div class="topbar-nav-item active" data-page="grades">
          –û—Ü–µ–Ω–∫–∏ <span class="dot"></span>
        </div>
        <div class="topbar-nav-item" data-page="rating">–†–µ–π—Ç–∏–Ω–≥</div>
      </div>

      <div class="topbar-spacer"></div>

      <!-- –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫ -->
      <div class="topbar-notifications">
        <button id="bell-btn" class="bell-btn" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
          üîî
          <span id="bell-badge" class="bell-badge hidden">0</span>
        </button>
        <div id="notifications-panel" class="notifications-panel hidden">
          <div class="notifications-header">
            <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            <div class="notifications-actions">
              <button id="notif-mark-read" class="notif-chip-btn">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å—ë</button>
              <button id="notif-clear" class="notif-chip-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
          </div>
          <div id="notifications-list" class="notifications-list"></div>
        </div>
      </div>

      <button id="theme-toggle">
        <span id="theme-toggle-icon">üåô</span>
        <span id="theme-toggle-text">–¢—ë–º–Ω–∞—è</span>
      </button>

      <div class="topbar-right" data-page="profile">
        <div class="avatar-small">
          <img id="avatar-small-img" src="teacher.jpg" alt="profile">
        </div>
        <div id="topbar-name">–í–µ–Ω–∏–∫ ‚ñæ</div>
      </div>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <div class="sidebar-user" data-page="profile">
          <div class="avatar">
            <img id="sidebar-avatar-img" src="teacher.jpg" alt="profile">
          </div>
          <div>
            <div class="sidebar-user-name" id="sidebar-name">–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</div>
            <div style="font-size:12px;color:var(--text-muted);" id="sidebar-class">8–ë –∫–ª–∞—Å—Å</div>
          </div>
        </div>

        <div class="sidebar-section-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="sidebar-item active" data-page="grades"><span>–¢–µ–∫—É—â–∏–µ –æ—Ü–µ–Ω–∫–∏</span></div>
        <div class="sidebar-item" data-page="schedule"><span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span></div>
        <div class="sidebar-item" data-page="tasks"><span>–î–æ–º–∞—à–∫–∞</span></div>
        <div class="sidebar-item" data-page="rating"><span>–†–µ–π—Ç–∏–Ω–≥</span></div>
        <div class="sidebar-item" data-page="profile"><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
      </aside>

      <main class="content">
        <!-- –û—Ü–µ–Ω–∫–∏ -->
        <section id="page-grades" class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">–¢–µ–∫—É—â–∏–µ –æ—Ü–µ–Ω–∫–∏</div>
              <div class="panel-subtitle">
                –ß–µ—Ç–≤–µ—Ä—Ç—å: <span id="current-quarter-label"></span>,
                –Ω–µ–¥–µ–ª—è: <span id="current-week-label"></span>
              </div>
            </div>
          </div>

          <div class="tabs">
            <div class="tab active" data-tab="by-date">–ü–æ –¥–Ω—è–º</div>
            <div class="tab" data-tab="by-subject">–ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</div>
          </div>

          <div id="tab-by-date">
            <div class="quarter-switcher">
              <button class="quarter-btn active" data-quarter="1">1 —á–µ—Ç–≤–µ—Ä—Ç—å</button>
              <button class="quarter-btn" data-quarter="2">2 —á–µ—Ç–≤–µ—Ä—Ç—å</button>
              <button class="quarter-btn" data-quarter="3">3 —á–µ—Ç–≤–µ—Ä—Ç—å</button>
              <button class="quarter-btn" data-quarter="4">4 —á–µ—Ç–≤–µ—Ä—Ç—å</button>
            </div>

            <div class="week-switcher">
              <button class="week-btn active" data-week="1">1 –Ω–µ–¥–µ–ª—è</button>
              <button class="week-btn" data-week="2">2 –Ω–µ–¥–µ–ª—è</button>
              <button class="week-btn" data-week="3">3 –Ω–µ–¥–µ–ª—è</button>
              <button class="week-btn" data-week="4">4 –Ω–µ–¥–µ–ª—è</button>
            </div>

            <section class="day-block" id="mon-block">
              <div class="day-title"><span class="day-icon">–ü–Ω</span>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</div>
            </section>
            <section class="day-block" id="tue-block">
              <div class="day-title"><span class="day-icon">–í—Ç</span>–í—Ç–æ—Ä–Ω–∏–∫</div>
            </section>
            <section class="day-block" id="wed-block">
              <div class="day-title"><span class="day-icon">–°—Ä</span>–°—Ä–µ–¥–∞</div>
            </section>
            <section class="day-block" id="thu-block">
              <div class="day-title"><span class="day-icon">–ß—Ç</span>–ß–µ—Ç–≤–µ—Ä–≥</div>
            </section>
            <section class="day-block" id="fri-block">
              <div class="day-title"><span class="day-icon">–ü—Ç</span>–ü—è—Ç–Ω–∏—Ü–∞</div>
            </section>
            <section class="day-block" id="sat-block">
              <div class="day-title"><span class="day-icon">–°–±</span>–°—É–±–±–æ—Ç–∞</div>
            </section>
            <section class="day-block" id="sun-block">
              <div class="day-title"><span class="day-icon">–í—Å</span>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</div>
            </section>

            <div class="grade-form">
              <span>–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É:</span>
              <select id="subject-input">
                <option value="–ê–ª–≥–µ–±—Ä–∞">–ê–ª–≥–µ–±—Ä–∞</option>
                <option value="–ë–∏–æ–ª–æ–≥–∏—è">–ë–∏–æ–ª–æ–≥–∏—è</option>
                <option value="–ì–µ–æ–≥—Ä–∞—Ñ–∏—è">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</option>
                <option value="–ì–µ–æ–º–µ—Ç—Ä–∏—è">–ì–µ–æ–º–µ—Ç—Ä–∏—è</option>
                <option value="–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                <option value="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
                <option value="–ò—Å—Ç–æ—Ä–∏—è">–ò—Å—Ç–æ—Ä–∏—è</option>
                <option value="–§–∏–∑–∏–∫–∞">–§–∏–∑–∏–∫–∞</option>
                <option value="–•–∏–º–∏—è">–•–∏–º–∏—è</option>
                <option value="–†—É—Å—Å–∫–∏–π —è–∑—ã–∫">–†—É—Å—Å–∫–∏–π</option>
              </select>
              <select id="day-select">
                <option value="mon">–ü–Ω</option>
                <option value="tue">–í—Ç</option>
                <option value="wed">–°—Ä</option>
                <option value="thu">–ß—Ç</option>
                <option value="fri">–ü—Ç</option>
                <option value="sat">–°–±</option>
                <option value="sun">–í—Å</option>
              </select>

              <input id="type-input" type="text" placeholder="–¢–∏–ø —Ä–∞–±–æ—Ç—ã">
              <input id="mark-input" type="number" min="1" max="5" style="width:50px" placeholder="–û—Ü–µ–Ω–∫–∞">
              <button class="btn" id="add-grade-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div id="tab-by-subject" class="hidden">
            <p class="panel-subtitle">
              –°–ø–∏—Å–æ–∫ –æ—Ü–µ–Ω–æ–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º (–¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ –∏ –Ω–µ–¥–µ–ª–∏).
            </p>
            <div id="subject-list"></div>
          </div>
        </section>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–µ–¥–Ω–∏—Ö -->
        <section id="page-subjects" class="panel hidden">
          <div class="panel-header">
            <div class="panel-title">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</div>
          </div>
          <table>
            <thead>
            <tr>
              <th>–ü—Ä–µ–¥–º–µ—Ç</th>
              <th>–û—Ü–µ–Ω–∫–∏</th>
              <th>–°—Ä–µ–¥–Ω–∏–π</th>
            </tr>
            </thead>
            <tbody id="subjects-table-body"></tbody>
          </table>
        </section>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <section id="page-profile" class="panel hidden">
          <div class="profile-grid">
            <div class="profile-card">
              <div class="profile-avatar">
                <img id="profile-avatar-img" src="teacher.jpg" alt="profile">
              </div>
              <div style="font-weight:600;margin-bottom:4px;" id="profile-name-display">–í–µ–Ω–∏–∫ –í–µ–Ω–∏–∫–æ–≤</div>
              <div style="font-size:12px;color:var(--text-muted);" id="profile-class-display">–£—á–µ–Ω–∏–∫ 8–ë –∫–ª–∞—Å—Å–∞</div>
            </div>

            <div class="profile-main">
              <h2 style="font-size:14px;margin-bottom:8px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
              <div class="profile-row">
                <span class="profile-label">–ò–º—è</span>
                <span id="profile-name-info">–í–µ–Ω–∏–∫ –í–µ–Ω–∏–∫–æ–≤</span>
              </div>
              <div class="profile-row">
                <span class="profile-label">–ü–æ—á—Ç–∞</span>
                <span id="profile-email-info">‚Äî</span>
              </div>
              <div class="profile-row">
                <span class="profile-label">–ì–æ—Ä–æ–¥</span>
                <span id="profile-city-info">–ü–æ–¥–æ–ª—å—Å–∫</span>
              </div>
              <div class="profile-row">
                <span class="profile-label">–ö–ª–∞—Å—Å</span>
                <span id="profile-class-info">8–ë</span>
              </div>
              <div class="profile-row">
                <span class="profile-label">–õ—é–±–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã</span>
                <span id="profile-fav-info">–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span>
              </div>

              <div class="profile-form">
                <h3 style="font-size:13px;margin-bottom:6px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h3>
                <div class="profile-form-row">
                  <span style="width:110px;">URL –∞–≤–∞—Ç–∞—Ä–∫–∏:</span>
                  <input id="profile-avatar-input" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É">
                </div>
                <div class="profile-form-row">
                  <span style="width:110px;">–ò–º—è:</span>
                  <input id="profile-name-input" type="text" placeholder="–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è">
                </div>
                <div class="profile-form-row">
                  <span style="width:110px;">–ì–æ—Ä–æ–¥:</span>
                  <input id="profile-city-input" type="text" placeholder="–ì–æ—Ä–æ–¥">
                </div>
                <div class="profile-form-row">
                  <span style="width:110px;">–ö–ª–∞—Å—Å:</span>
                  <input id="profile-class-input" type="text" placeholder="8–ë">
                </div>
                <div class="profile-form-row">
                  <span style="width:110px;">–õ—é–±–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:</span>
                  <input id="profile-fav-input" type="text" placeholder="–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
                </div>
                <button class="btn" id="profile-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </section>

        <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
        <section id="page-schedule" class="panel hidden">
          <div class="panel-header">
            <div>
              <div class="panel-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
              <div class="panel-subtitle">–í—ã–±–µ—Ä–∏ –¥–µ–Ω—å —Å–≤–µ—Ä—Ö—É, —á—Ç–æ–±—ã –Ω–µ –ª–∏—Å—Ç–∞—Ç—å –æ–≥—Ä–æ–º–Ω—ã–π —Å–ø–∏—Å–æ–∫.</div>
            </div>
          </div>

          <div class="day-tabs" id="schedule-day-tabs"></div>
          <div id="schedule-container"></div>
        </section>

        <!-- –î–æ–º–∞—à–∫–∞ -->
        <section id="page-tasks" class="panel hidden">
          <div class="panel-header">
            <div>
              <div class="panel-title">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
              <div class="panel-subtitle">
                –°–¥–µ–ª–∞–ª –î–ó ‚Äî –ø–æ—Å—Ç–∞–≤—å –≥–∞–ª–æ—á–∫—É, –º–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Å—Ç–∞—Ç—É—Å—É.
              </div>
            </div>
          </div>

          <div class="tasks-filter">
            <span>–ü–æ–∫–∞–∑–∞—Ç—å:</span>
            <select id="tasks-filter-select">
              <option value="all">–í—Å–µ</option>
              <option value="done">–¢–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
              <option value="todo">–¢–æ–ª—å–∫–æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
            </select>
          </div>

          <div class="day-tabs" id="tasks-day-tabs"></div>
          <div id="tasks-container"></div>
        </section>

        <!-- –†–µ–π—Ç–∏–Ω–≥ -->
        <section id="page-rating" class="panel hidden">
          <div class="panel-header">
            <div class="panel-title">–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∞—Å—Å–∞</div>
            <button class="btn secondary" id="rating-refresh-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <p class="panel-subtitle">
            –°—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –æ—Ü–µ–Ω–∫–∞–º –≤—ã–±—Ä–∞–Ω–Ω–æ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ –∏ –Ω–µ–¥–µ–ª–∏.
          </p>
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>–£—á–µ–Ω–∏–∫</th>
              <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
            </tr>
            </thead>
            <tbody id="rating-table-body"></tbody>
          </table>
          <div id="rating-history"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- TGK –±–∞–Ω–Ω–µ—Ä —Å–Ω–∏–∑—É -->
  <div id="tgk-banner" class="tgk-banner">
    <div class="tgk-banner-avatar">
      <img src="teacher.jpg" alt="tgk">
    </div>
    <div class="tgk-banner-body">
      <div class="tgk-banner-title">TGK Premium</div>
      <div>–£–±–µ—Ä–∏ —Ä–µ–∫–ª–∞–º—É –∏ –ø–æ–ª—É—á–∏ –µ—â—ë –±–æ–ª—å—à–µ —Ñ–∏—à–µ–∫ –¥–Ω–µ–≤–Ω–∏–∫–∞.</div>
      <div class="tgk-banner-footer">
        <span class="tgk-banner-pill">–í—Å–µ–≥–æ 99‚ÇΩ –≤ –º–µ—Å—è—Ü</span>
        <button class="tgk-banner-go" id="tgk-go-btn">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
    </div>
    <button class="tgk-banner-close" id="tgk-close-btn">‚úï</button>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π JS + Firebase Auth + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAFcX2I6lfzmxwEGEpOej-SqiG6-DFWSDc",
      authDomain: "venik-fa40b.firebaseapp.com",
      projectId: "venik-fa40b",
      storageBucket: "venik-fa40b.firebasestorage.app",
      messagingSenderId: "1049573809722",
      appId: "1:1049573809722:web:492952ba95624b8ac01f03",
      measurementId: "G-GMM29TBZ2K"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    const authPanel = document.getElementById('auth-panel');
    const appRoot = document.getElementById('app-root');
    const emailInput = document.getElementById('auth-email');
    const passInput = document.getElementById('auth-password');
    const loginBtn = document.getElementById('auth-login-btn');
    const signupBtn = document.getElementById('auth-signup-btn');
    const logoutBtn = document.getElementById('auth-logout-btn');
    const authError = document.getElementById('auth-error');

    function showError(msg) {
      authError.textContent = msg;
    }

    signupBtn.addEventListener('click', async () => {
      showError('');
      try {
        await createUserWithEmailAndPassword(auth, emailInput.value, passInput.value);
        addNotification('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç', 'auth-signup');
      } catch (e) {
        showError(e.code || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      }
    });

    loginBtn.addEventListener('click', async () => {
      showError('');
      try {
        await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
        addNotification('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'auth-login');
      } catch (e) {
        showError(e.code || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      addNotification('–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'auth-logout');
    });

    /* ===== –¢–µ–º–∞ ===== */
    const THEME_KEY = 'venik-theme';
    const themeToggleBtn = document.getElementById('theme-toggle');
    const themeToggleIcon = document.getElementById('theme-toggle-icon');
    const themeToggleText = document.getElementById('theme-toggle-text');

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      if (theme === 'light') {
        themeToggleIcon.textContent = '‚òÄÔ∏è';
        themeToggleText.textContent = '–°–≤–µ—Ç–ª–∞—è';
      } else {
        themeToggleIcon.textContent = 'üåô';
        themeToggleText.textContent = '–¢—ë–º–Ω–∞—è';
      }
    }
    function loadTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      const theme = saved === 'light' || saved === 'dark' ? saved : 'dark';
      applyTheme(theme);
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      localStorage.setItem(THEME_KEY, next);
    }
    themeToggleBtn.addEventListener('click', toggleTheme);

    /* ===== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===== */
    const NOTIF_KEY = 'venik-notifications';
    let notifications = [];
    let unreadCount = 0;

    const bellBtn = document.getElementById('bell-btn');
    const bellBadge = document.getElementById('bell-badge');
    const notifPanel = document.getElementById('notifications-panel');
    const notifList = document.getElementById('notifications-list');
    const notifMarkReadBtn = document.getElementById('notif-mark-read');
    const notifClearBtn = document.getElementById('notif-clear');

    function loadNotifications() {
      const raw = localStorage.getItem(NOTIF_KEY);
      notifications = raw ? JSON.parse(raw) : [];
      unreadCount = notifications.filter(n => !n.read).length;
      updateNotifUI();
    }
    function saveNotifications() {
      localStorage.setItem(NOTIF_KEY, JSON.stringify(notifications));
    }
    function formatTime(date) {
      const d = new Date(date);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return hh + ':' + mm;
    }
    function addNotification(text, type) {
      const newNotif = {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        text,
        type,
        createdAt: new Date().toISOString(),
        read: false
      };
      notifications.unshift(newNotif);
      unreadCount++;
      saveNotifications();
      updateNotifUI();
    }
    window.addNotification = addNotification;

    function updateNotifUI() {
      if (unreadCount > 0) {
        bellBadge.classList.remove('hidden');
        bellBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
      } else {
        bellBadge.classList.add('hidden');
      }

      notifList.innerHTML = '';
      if (!notifications.length) {
        const p = document.createElement('p');
        p.style.fontSize = '12px';
        p.style.color = 'var(--text-muted)';
        p.textContent = '–ü–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç.';
        notifList.appendChild(p);
        return;
      }
      notifications.forEach(n => {
        const item = document.createElement('div');
        item.className = 'notif-item' + (n.read ? '' : ' new');
        const main = document.createElement('div');
        main.className = 'notif-main';
        const txt = document.createElement('div');
        txt.className = 'notif-text';
        txt.textContent = n.text;
        const time = document.createElement('div');
        time.className = 'notif-time';
        time.textContent = formatTime(n.createdAt);
        main.appendChild(txt);
        main.appendChild(time);
        item.appendChild(main);
        notifList.appendChild(item);
      });
    }

    bellBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      notifPanel.classList.toggle('hidden');
    });

    notifMarkReadBtn.addEventListener('click', () => {
      notifications.forEach(n => n.read = true);
      unreadCount = 0;
      saveNotifications();
      updateNotifUI();
    });

    notifClearBtn.addEventListener('click', () => {
      notifications = [];
      unreadCount = 0;
      saveNotifications();
      updateNotifUI();
    });

    document.addEventListener('click', (e) => {
      if (!notifPanel.contains(e.target) && !bellBtn.contains(e.target)) {
        notifPanel.classList.add('hidden');
      }
    });

    /* ===== –í–µ—Ä—Ö–Ω–∏–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä ===== */
    const TOP_AD_KEY = 'venik-top-ad-closed';
    const topAdBanner = document.getElementById('top-ad-banner');
    const topAdGoBtn = document.getElementById('top-ad-go-btn');
    const topAdCloseBtn = document.getElementById('top-ad-close-btn');

    function loadTopAdState() {
      const closed = localStorage.getItem(TOP_AD_KEY) === '1';
      if (closed && topAdBanner) {
        topAdBanner.classList.add('hidden');
      }
    }

    function closeTopAd(permanent) {
      if (!topAdBanner) return;
      topAdBanner.classList.add('hidden');
      if (permanent) {
        localStorage.setItem(TOP_AD_KEY, '1');
      }
    }

    if (topAdGoBtn) {
      topAdGoBtn.addEventListener('click', () => {
        addNotification('TGK Premium: —Å–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∫–∏.', 'top-ad');
      });
    }
    if (topAdCloseBtn) {
      topAdCloseBtn.addEventListener('click', () => {
        closeTopAd(true);
      });
    }

    /* ===== TGK –±–∞–Ω–Ω–µ—Ä –ª–æ–≥–∏–∫–∞ (—Å–Ω–∏–∑—É) ===== */
    const TGK_KEY = 'venik-tgk-closed';
    const tgkBanner = document.getElementById('tgk-banner');
    const tgkGoBtn = document.getElementById('tgk-go-btn');
    const tgkCloseBtn = document.getElementById('tgk-close-btn');

    function loadTgkBannerState() {
      const closed = localStorage.getItem(TGK_KEY) === '1';
      if (closed) tgkBanner.classList.add('hidden');
    }
    function closeTgkBanner(permanent) {
      tgkBanner.classList.add('hidden');
      if (permanent) {
        localStorage.setItem(TGK_KEY, '1');
      }
    }
    tgkGoBtn.addEventListener('click', () => {
      addNotification('TGK Premium –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –Ω–æ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç!', 'tgk-go');
      closeTgkBanner(true);
    });
    tgkCloseBtn.addEventListener('click', () => {
      closeTgkBanner(true);
    });

    /* ===== –ü—Ä–æ—Ñ–∏–ª—å ===== */
    const PROFILE_KEY = 'venik-profile';
    let profile = {
      avatarUrl: '',
      name: '–í–µ–Ω–∏–∫ –í–µ–Ω–∏–∫–æ–≤',
      city: '–ü–æ–¥–æ–ª—å—Å–∫',
      className: '8–ë',
      favSubjects: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'
    };

    const avatarSmallImg = document.getElementById('avatar-small-img');
    const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
    const profileAvatarImg = document.getElementById('profile-avatar-img');

    const topbarTitle = document.getElementById('topbar-title');
    const topbarName = document.getElementById('topbar-name');
    const sidebarName = document.getElementById('sidebar-name');
    const sidebarClass = document.getElementById('sidebar-class');

    const profileNameDisplay = document.getElementById('profile-name-display');
    const profileClassDisplay = document.getElementById('profile-class-display');
    const profileNameInfo = document.getElementById('profile-name-info');
    const profileEmailInfo = document.getElementById('profile-email-info');
    const profileCityInfo = document.getElementById('profile-city-info');
    const profileClassInfo = document.getElementById('profile-class-info');
    const profileFavInfo = document.getElementById('profile-fav-info');

    const avatarInput = document.getElementById('profile-avatar-input');
    const nameInput = document.getElementById('profile-name-input');
    const cityInput = document.getElementById('profile-city-input');
    const classInput = document.getElementById('profile-class-input');
    const favInput = document.getElementById('profile-fav-input');
    const profileSaveBtn = document.getElementById('profile-save-btn');

    function applyProfileToUI() {
      const avatar = profile.avatarUrl || 'teacher.jpg';
      avatarSmallImg.src = avatar;
      sidebarAvatarImg.src = avatar;
      profileAvatarImg.src = avatar;

      topbarTitle.textContent = '–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞';
      sidebarName.textContent = '–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞';

      topbarName.textContent = (profile.name || '–ü—Ä–æ—Ñ–∏–ª—å') + ' ‚ñæ';
      sidebarClass.textContent = profile.className + ' –∫–ª–∞—Å—Å';

      profileNameDisplay.textContent = profile.name;
      profileClassDisplay.textContent = `–£—á–µ–Ω–∏–∫ ${profile.className} –∫–ª–∞—Å—Å–∞`;
      profileNameInfo.textContent = profile.name;
      profileCityInfo.textContent = profile.city;
      profileClassInfo.textContent = profile.className;
      profileFavInfo.textContent = profile.favSubjects;

      avatarInput.value = profile.avatarUrl;
      nameInput.value = profile.name;
      cityInput.value = profile.city;
      classInput.value = profile.className;
      favInput.value = profile.favSubjects;
    }

    async function loadProfile() {
      const raw = localStorage.getItem(PROFILE_KEY);
      if (raw) {
        try { profile = Object.assign(profile, JSON.parse(raw)); } catch(e){}
      }
      if (currentUser) {
        const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
        profile = Object.assign(profile, data.profile || {});
      }
    }
    async function saveProfile() {
      localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
      if (!currentUser) return;
      await saveUserQuarterDoc(currentUser.uid, currentQuarter);
    }

    profileSaveBtn.addEventListener('click', async () => {
      profile.avatarUrl = avatarInput.value.trim();
      profile.name = nameInput.value.trim() || '–ë–µ–∑ –∏–º–µ–Ω–∏';
      profile.city = cityInput.value.trim() || '–ì–æ—Ä–æ–¥';
      profile.className = classInput.value.trim() || '–ö–ª–∞—Å—Å';
      profile.favSubjects = favInput.value.trim() || '–ù–µ—Ç';
      await saveProfile();
      applyProfileToUI();
      renderAllByDate();
      addNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'profile');
      alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    });

    /* ===== –°—Ç—Ä–∞–Ω–∏—Ü—ã ===== */
    const pageSections = document.querySelectorAll('[id^="page-"]');
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    const topbarNavItems = document.querySelectorAll('.topbar-nav-item');

    function showPage(pageName) {
      pageSections.forEach(sec => {
        sec.classList.toggle('hidden', sec.id !== 'page-' + pageName);
      });
      sidebarItems.forEach(i => i.classList.toggle('active', i.dataset.page === pageName));
      topbarNavItems.forEach(i => i.classList.toggle('active', i.dataset.page === pageName));

      if (pageName === 'schedule') renderSchedule();
      if (pageName === 'tasks') renderTasksForDay(currentTasksDay);
      if (pageName === 'rating') { renderRating(); renderRatingHistory(); }
      if (pageName === 'subjects') renderSubjectsTable();
    }
    document.querySelectorAll('[data-page]').forEach(el => {
      el.addEventListener('click', () => {
        const page = el.dataset.page;
        if (page) showPage(page);
      });
    });

    /* ===== –í–∫–ª–∞–¥–∫–∏ –æ—Ü–µ–Ω–æ–∫ ===== */
    const tabs = document.querySelectorAll('.tab');
    const tabByDate = document.getElementById('tab-by-date');
    const tabBySubject = document.getElementById('tab-by-subject');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        if (tab.dataset.tab === 'by-date') {
          tabByDate.classList.remove('hidden');
          tabBySubject.classList.add('hidden');
        } else {
          tabByDate.classList.add('hidden');
          tabBySubject.classList.remove('hidden');
          renderSubjectList();
        }
      });
    });

    /* ===== –ß–µ—Ç–≤–µ—Ä—Ç–∏ –∏ –Ω–µ–¥–µ–ª–∏ ===== */
    const GRADES_PREFIX = 'venik-grades-q';
    let currentQuarter = 1;
    let currentWeek = 1;
    let grades = [];

    const quarterBtns = document.querySelectorAll('.quarter-btn');
    const weekBtns = document.querySelectorAll('.week-btn');
    const currentQuarterLabel = document.getElementById('current-quarter-label');
    const currentWeekLabel = document.getElementById('current-week-label');

    function storageKeyFor(quarter, week) {
      return `${GRADES_PREFIX}${quarter}-w${week}`;
    }

    async function loadUserQuarterDoc(uid, quarter) {
      const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        return {
          grades_w1: [],
          grades_w2: [],
          grades_w3: [],
          grades_w4: [],
          profile,
          tasksDone,
          ratingHistory: loadRatingHistory()
        };
      }
      const data = snap.data();
      return {
        grades_w1: data.grades_w1 || [],
        grades_w2: data.grades_w2 || [],
        grades_w3: data.grades_w3 || [],
        grades_w4: data.grades_w4 || [],
        profile: data.profile || profile,
        tasksDone: data.tasksDone || tasksDone,
        ratingHistory: data.ratingHistory || []
      };
    }

    async function saveUserQuarterDoc(uid, quarter) {
      const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
      const payload = {
        grades_w1: [],
        grades_w2: [],
        grades_w3: [],
        grades_w4: [],
        profile,
        tasksDone,
        ratingHistory: loadRatingHistory()
      };
      payload['grades_w' + currentWeek] = grades;
      await setDoc(ref, payload, { merge: true });
    }

    async function loadGrades() {
      if (!currentUser) {
        const raw = localStorage.getItem(storageKeyFor(currentQuarter, currentWeek));
        grades = raw ? JSON.parse(raw) : [];
        return;
      }
      const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
      grades = data['grades_w' + currentWeek] || [];
    }

    async function saveGrades() {
      localStorage.setItem(storageKeyFor(currentQuarter, currentWeek), JSON.stringify(grades));
      if (!currentUser) return;
      await saveUserQuarterDoc(currentUser.uid, currentQuarter);
    }

    async function switchQuarter(q) {
      currentQuarter = q;
      quarterBtns.forEach(b => b.classList.toggle('active', Number(b.dataset.quarter) === q));
      currentQuarterLabel.textContent = q + ' —á–µ—Ç–≤–µ—Ä—Ç—å';
      await switchWeek(1);
    }
    async function switchWeek(w) {
      currentWeek = w;
      weekBtns.forEach(b => b.classList.toggle('active', Number(b.dataset.week) === w));
      currentWeekLabel.textContent = w + ' –Ω–µ–¥–µ–ª—è';
      await loadGrades();
      renderAllByDate();
      renderSubjectsTable();
      renderSubjectList();
      renderRating();
      renderRatingHistory();
    }
    quarterBtns.forEach(btn => btn.addEventListener('click', () => switchQuarter(Number(btn.dataset.quarter))));
    weekBtns.forEach(btn => btn.addEventListener('click', () => switchWeek(Number(btn.dataset.week))));

    /* ===== –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ü–µ–Ω–æ–∫ ===== */
    const dayBlocksMap = {
      mon: document.getElementById('mon-block'),
      tue: document.getElementById('tue-block'),
      wed: document.getElementById('wed-block'),
      thu: document.getElementById('thu-block'),
      fri: document.getElementById('fri-block'),
      sat: document.getElementById('sat-block'),
      sun: document.getElementById('sun-block'),
    };
    function blockByDay(day) {
      return dayBlocksMap[day] || dayBlocksMap.mon;
    }
    function clearDayBlocks() {
      Object.values(dayBlocksMap).forEach(block => {
        block.querySelectorAll('.lesson-card').forEach(c => c.remove());
      });
    }

    function subjectBadgeClass(subject) {
      if (/–∞–ª–≥–µ–±—Ä–∞|–≥–µ–æ–º–µ—Ç—Ä–∏—è|—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫/i.test(subject)) return 'badge-math';
      if (/—Ä—É—Å—Å–∫–∏–π/i.test(subject)) return 'badge-ru';
      if (/–∞–Ω–≥–ª–∏–π/i.test(subject)) return 'badge-eng';
      if (/–∏–Ω—Ñ–æ—Ä–º–∞—Ç|–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç/i.test(subject)) return 'badge-it';
      if (/—Ñ–∏–∑–∏–∫–∞|—Ö–∏–º–∏—è|–±–∏–æ–ª–æ–≥/i.test(subject)) return 'badge-sci';
      if (/–≥–µ–æ–≥—Ä–∞—Ñ/i.test(subject)) return 'badge-geo';
      if (/–∏—Å—Ç–æ—Ä|–æ–±—â–µ/i.test(subject)) return 'badge-hist';
      if (/—Ñ–∏–∑–∏—á–µ—Å–∫/i.test(subject)) return 'badge-pe';
      return 'badge-other';
    }

    /* ===== –û—Ü–µ–Ω–∫–∏: –∫–∞—Ä—Ç–æ—á–∫–∏ ===== */
    function createLessonCard(grade) {
      const card = document.createElement('article');
      card.className = 'lesson-card';
      card.dataset.id = grade.id;
      const badgeClass = subjectBadgeClass(grade.subject);
      card.innerHTML = `
        <div class="lesson-teacher">
          <img src="${profile.avatarUrl || 'teacher.jpg'}" alt="teacher">
        </div>
        <div class="lesson-main">
          <div class="lesson-subject">
            <span>${grade.subject} ‚Äî ${grade.mark}</span>
            <span class="badge ${badgeClass}">–æ—Ü–µ–Ω–∫–∞</span>
          </div>
          <div class="lesson-type">${grade.type}</div>
        </div>
        <div class="lesson-more" title="–£–¥–∞–ª–∏—Ç—å">‚úï</div>
      `;
      card.querySelector('.lesson-more').addEventListener('click', async () => {
        grades = grades.filter(g => g.id !== grade.id);
        await saveGrades();
        card.remove();
        renderSubjectsTable();
        renderSubjectList();
        renderRating();
        saveRatingHistoryEntry();
        addNotification(`–£–¥–∞–ª–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞ ${grade.mark} –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${grade.subject}`, 'grade-delete');
      });
      return card;
    }
    function renderAllByDate() {
      clearDayBlocks();
      grades.forEach(g => {
        const block = blockByDay(g.day);
        block.appendChild(createLessonCard(g));
      });
    }

    /* ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ ===== */
    const subjectSelect = document.getElementById('subject-input');
    const typeInput = document.getElementById('type-input');
    const daySelect = document.getElementById('day-select');
    const markInput = document.getElementById('mark-input');
    const addBtn = document.getElementById('add-grade-btn');

    addBtn.addEventListener('click', async () => {
      const subject = subjectSelect.value;
      const type = typeInput.value.trim();
      const mark = Number(markInput.value) || 0;
      const day = daySelect.value;
      if (!mark || mark < 1 || mark > 5) {
        alert('–í–≤–µ–¥–∏ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5');
        return;
      }
      const newGrade = {
        id: Date.now().toString() + '-' + Math.random().toString(16).slice(2),
        subject,
        type: type || '–†–∞–±–æ—Ç–∞',
        mark,
        day,
        quarter: currentQuarter,
        week: currentWeek
      };
      grades.push(newGrade);
      await saveGrades();
      blockByDay(day).appendChild(createLessonCard(newGrade));
      markInput.value = '';
      typeInput.value = '';
      renderSubjectsTable();
      renderSubjectList();
      renderRating();
      saveRatingHistoryEntry();
      addNotification(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞ ${newGrade.mark} –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${newGrade.subject}`, 'grade-add');
    });

    /* ===== –°—Ä–µ–¥–Ω–∏–µ –∏ —Å–ø–∏—Å–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ ===== */
    const subjectsTableBody = document.getElementById('subjects-table-body');
    const subjectListDiv = document.getElementById('subject-list');

    function calcAverage(arr) {
      if (!arr.length) return 0;
      const sum = arr.reduce((a, b) => a + b, 0);
      return sum / arr.length;
    }
    function groupBySubject() {
      const map = {};
      grades.forEach(g => {
        if (!map[g.subject]) map[g.subject] = [];
        map[g.subject].push(g.mark);
      });
      return map;
    }
    function renderSubjectsTable() {
      const groups = groupBySubject();
      subjectsTableBody.innerHTML = '';
      Object.keys(groups).forEach(subj => {
        const marks = groups[subj];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${subj}</td>
          <td>${marks.join(', ')}</td>
          <td>${calcAverage(marks).toFixed(2)}</td>
        `;
        subjectsTableBody.appendChild(tr);
      });
    }
    function renderSubjectList() {
      const groups = groupBySubject();
      subjectListDiv.innerHTML = '';
      const keys = Object.keys(groups);
      if (!keys.length) {
        subjectListDiv.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫ –¥–ª—è —ç—Ç–æ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ –∏ –Ω–µ–¥–µ–ª–∏.';
        return;
      }
      keys.forEach(subj => {
        const marks = groups[subj];
        const p = document.createElement('p');
        p.textContent = `${subj}: ${marks.join(', ')} (—Å—Ä. ${calcAverage(marks).toFixed(2)})`;
        subjectListDiv.appendChild(p);
      });
    }
    function getMyAverage() {
      const marks = grades.map(g => g.mark).filter(m => m > 0);
      return calcAverage(marks) || 0;
    }

    /* ===== –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –î–ó ===== */
    const SCHEDULE = {
      '–ü–Ω': [
        { id: 'mon-1', num: 1, time: '08:30 - 09:00', subject: '–†–∞–∑–≥–æ–≤–æ—Ä—ã –æ –≤–∞–∂–Ω–æ–º', room: '–î–ë / –∫–æ—Ä–ø—É—Å 1' },
        { id: 'mon-2', num: 2, time: '09:10 - 09:55', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 28' },
        { id: 'mon-3', num: 3, time: '10:05 - 10:50', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 28' },
        { id: 'mon-4', num: 4, time: '11:05 - 11:50', subject: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', room: '–∫–∞–±. 38' },
        { id: 'mon-5', num: 5, time: '‚Äî', subject: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', room: '–∫–∞–±. 59' },
        { id: 'mon-6', num: 6, time: '13:00 - 13:45', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 27' },
        { id: 'mon-7', num: 7, time: '14:00 - 14:40', subject: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç', room: '–∫–∞–±. 48' }
      ],
      '–í—Ç': [
        { id: 'tue-1', num: 1, time: '08:30 - 09:15', subject: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', room: '–∫–∞–±. 38' },
        { id: 'tue-2', num: 2, time: '09:25 - 10:10', subject: '–ê–ª–≥–µ–±—Ä–∞', room: '–∫–∞–±. 38' },
        { id: 'tue-3', num: 3, time: '10:20 - 11:05', subject: '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', room: '–∫–∞–±. 53' },
        { id: 'tue-4', num: 4, time: '11:20 - 12:05', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 49' },
        { id: 'tue-5', num: 5, time: '12:15 - 13:00', subject: '–ò—Å—Ç–æ—Ä–∏—è', room: '–∫–∞–±. 32' },
        { id: 'tue-6', num: 6, time: '13:15 - 13:55', subject: '–§–∏–∑–∏–∫–∞', room: '–∫–∞–±. 49' }
      ],
      '–°—Ä': [
        { id: 'wed-1', num: 1, time: '08:30 - 09:15', subject: '–ë–∏–æ–ª–æ–≥–∏—è', room: '–∫–∞–±. 55' },
        { id: 'wed-2', num: 2, time: '09:25 - 10:10', subject: '–ë–∏–æ–ª–æ–≥–∏—è', room: '–∫–∞–±. 28' },
        { id: 'wed-3', num: 3, time: '10:20 - 11:05', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 59' },
        { id: 'wed-4', num: 4, time: '11:20 - 12:05', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 38' },
        { id: 'wed-5', num: 5, time: '12:15 - 13:00', subject: '–ê–ª–≥–µ–±—Ä–∞', room: '–∫–∞–±. 38' }
      ],
      '–ß—Ç': [
        { id: 'thu-1', num: 1, time: '08:30 - 09:00', subject: '–†–û–°–°–ò–Ø ‚Äî –ú–û–ò –ì–û–†–ò–ó–û–ù–¢–´', room: '–î–ë / –≤–Ω–µ—É—Ä–æ—á–Ω–∞—è' },
        { id: 'thu-2', num: 2, time: '09:10 - 09:55', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 53' },
        { id: 'thu-3', num: 3, time: '10:05 - 10:50', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 49' },
        { id: 'thu-4', num: 4, time: '11:05 - 11:50', subject: '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ', room: '–∫–∞–±. 59' },
        { id: 'thu-5', num: 5, time: '12:00 - 12:45', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 12' }
      ],
      '–ü—Ç': [
        { id: 'fri-1', num: 1, time: '08:30 - 09:15', subject: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞', room: '—Å–ø–æ—Ä—Ç–∑–∞–ª' },
        { id: 'fri-2', num: 2, time: '09:25 - 10:10', subject: '–§–∏–∑–∏–∫–∞', room: '–∫–∞–±. 12' },
        { id: 'fri-3', num: 3, time: '10:20 - 11:05', subject: '–ú—É–∑—ã–∫–∞', room: '–∫–∞–±. 32' },
        { id: 'fri-4', num: 4, time: '11:20 - 12:05', subject: '–¢—Ä—É–¥ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è)', room: '–∫–∞–±. 55' }
      ]
    };

    const HOMEWORK_TEMPLATES = {
      '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫': [
        '–≤—ã—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏ —Å–¥–µ–ª–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è 1‚Äì3',
        '–Ω–∞–ø–∏—Å–∞—Ç—å –º–∏–Ω–∏-—Å–æ—á–∏–Ω–µ–Ω–∏–µ (80‚Äì100 —Å–ª–æ–≤)'
      ],
      '–ê–ª–≥–µ–±—Ä–∞': [
        '—Ä–µ—à–∏—Ç—å –Ω–æ–º–µ—Ä–∞ 101‚Äì105',
        '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π, —Ä–µ—à–∏—Ç—å 5 –∑–∞–¥–∞—á'
      ],
      '–ì–µ–æ–º–µ—Ç—Ä–∏—è': [
        '–ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–∞—Ä–∞–≥—Ä–∞—Ñ –∏ —Ä–µ—à–∏—Ç—å 3 –∑–∞–¥–∞—á–∏',
        '–¥–æ–∫–∞–∑–∞—Ç—å —Ç–µ–æ—Ä–µ–º—É –∏–∑ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞'
      ],
      '–§–∏–∑–∏–∫–∞': [
        '—Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞, —Ä–µ—à–∏—Ç—å 4 –∑–∞–¥–∞—á–∏',
        '—Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏'
      ],
      '–•–∏–º–∏—è': [
        '—Å–æ—Å—Ç–∞–≤–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π, –≤—ã—É—á–∏—Ç—å —Ñ–æ—Ä–º—É–ª—ã',
        '—Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞—Å—Å–æ–≤—É—é –¥–æ–ª—é'
      ],
      '–ë–∏–æ–ª–æ–≥–∏—è': [
        '–≤—ã—É—á–∏—Ç—å —Ç–µ—Ä–º–∏–Ω—ã –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É',
        '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ç–µ–º–µ'
      ],
      '–ò—Å—Ç–æ—Ä–∏—è': [
        '–≤—ã—É—á–∏—Ç—å –¥–∞—Ç—ã –∏ —Å–æ–±—ã—Ç–∏—è –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞',
        '—Å–¥–µ–ª–∞—Ç—å –ø–ª–∞–Ω –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞'
      ],
      '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è': [
        '–∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ–Ω—Ç—É—Ä–Ω—É—é –∫–∞—Ä—Ç—É',
        '–æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–µ—Ç—Ä–∞–¥–∏'
      ],
      '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫': [
        '–≤—ã—É—á–∏—Ç—å 15 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤ –∏ —Å–¥–µ–ª–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
        '–Ω–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ (80‚Äì100 —Å–ª–æ–≤)'
      ],
      '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞': [
        '–Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ –æ–±—Ä–∞–∑—Ü—É',
        '—Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –∞–ª–≥–æ—Ä–∏—Ç–º—ã'
      ],
      '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç': [
        '–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ –ø–æ —Ç–µ–º–µ –∏ –∑–∞–ø–∏—Å–∞—Ç—å 5 —Ñ–∞–∫—Ç–æ–≤',
        '–ø—Ä–∏–¥—É–º–∞—Ç—å –∏–¥–µ—é –ø—Ä–æ–µ–∫—Ç–∞ —Å –ò–ò'
      ],
      '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ': [
        '–æ—Ç–≤–µ—Ç–∏—Ç—å –ø–∏—Å—å–º–µ–Ω–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞',
        '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∫ –ø–æ–Ω—è—Ç–∏—è–º'
      ],
      '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞': [
        '–≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–º–∞ –∫–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π',
        '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–∏–¥–µ —Å–ø–æ—Ä—Ç–∞'
      ],
      '–¢—Ä—É–¥ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è)': [
        '–∑–∞–∫–æ–Ω—á–∏—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ä–∞–±–æ—Ç—É',
        '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è'
      ],
      '–ú—É–∑—ã–∫–∞': [
        '–ø–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤',
        '–≤—ã—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏'
      ]
    };

    function getRandomHomework(subject) {
      const list = HOMEWORK_TEMPLATES[subject];
      if (!list || !list.length) return '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª —É—Ä–æ–∫–∞.';
      const i = Math.floor(Math.random() * list.length);
      return list[i];
    }

    /* ===== –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –¥–Ω—è–º ===== */
    const scheduleDayTabs = document.getElementById('schedule-day-tabs');
    const scheduleContainer = document.getElementById('schedule-container');
    const dayKeys = Object.keys(SCHEDULE);
    let currentScheduleDay = dayKeys[0];

    function renderScheduleTabs() {
      scheduleDayTabs.innerHTML = '';
      dayKeys.forEach(dayName => {
        const btn = document.createElement('button');
        btn.className = 'day-tab' + (dayName === currentScheduleDay ? ' active' : '');
        btn.textContent = dayName;
        btn.addEventListener('click', () => {
          currentScheduleDay = dayName;
          renderSchedule();
        });
        scheduleDayTabs.appendChild(btn);
      });
    }

    function renderSchedule() {
      renderScheduleTabs();
      scheduleContainer.innerHTML = '';
      const block = document.createElement('div');
      block.className = 'day-block';
      const title = document.createElement('div');
      title.className = 'day-title';
      title.innerHTML = `<span class="day-icon">${currentScheduleDay}</span>${currentScheduleDay} —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ`;
      block.appendChild(title);

      SCHEDULE[currentScheduleDay].forEach(lesson => {
        const card = document.createElement('div');
        card.className = 'lesson-card';

        const avatar = document.createElement('div');
        avatar.className = 'lesson-teacher';
        avatar.innerHTML = `<img src="${profile.avatarUrl || 'teacher.jpg'}" alt="teacher">`;

        const main = document.createElement('div');
        main.className = 'lesson-main';
        const badgeClass = subjectBadgeClass(lesson.subject);
        const line1 = document.createElement('div');
        line1.className = 'lesson-subject';
        line1.innerHTML = `<span>${lesson.num} —É—Ä–æ–∫ ¬∑ ${lesson.subject}</span><span class="badge ${badgeClass}">—É—Ä–æ–∫</span>`;
        const line2 = document.createElement('div');
        line2.className = 'lesson-type';
        line2.textContent = `${lesson.time}${lesson.room ? ' ¬∑ ' + lesson.room : ''}`;
        main.appendChild(line1);
        main.appendChild(line2);

        card.appendChild(avatar);
        card.appendChild(main);
        block.appendChild(card);
      });

      scheduleContainer.appendChild(block);
    }

    /* ===== –î–æ–º–∞—à–∫–∞: —á–µ–∫–±–æ–∫—Å—ã + —Ñ–∏–ª—å—Ç—Ä + Firestore ===== */
    const TASKS_DONE_KEY = 'venik-tasks-done';
    let tasksDone = {};

    async function loadTasksDone() {
      const raw = localStorage.getItem(TASKS_DONE_KEY);
      tasksDone = raw ? JSON.parse(raw) : {};
      if (currentUser) {
        const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
        tasksDone = data.tasksDone || tasksDone;
      }
    }
    async function saveTasksDone() {
      localStorage.setItem(TASKS_DONE_KEY, JSON.stringify(tasksDone));
      if (!currentUser) return;
      await saveUserQuarterDoc(currentUser.uid, currentQuarter);
    }

    const tasksDayTabs = document.getElementById('tasks-day-tabs');
    const tasksContainer = document.getElementById('tasks-container');
    const tasksFilterSelect = document.getElementById('tasks-filter-select');
    let currentTasksDay = dayKeys[0];
    let currentTasksFilter = 'all';

    tasksFilterSelect.addEventListener('change', () => {
      currentTasksFilter = tasksFilterSelect.value;
      renderTasksForDay(currentTasksDay);
    });

    function renderTasksTabs() {
      tasksDayTabs.innerHTML = '';
      dayKeys.forEach(dayName => {
        const btn = document.createElement('button');
        btn.className = 'day-tab' + (dayName === currentTasksDay ? ' active' : '');
        btn.textContent = dayName;
        btn.addEventListener('click', () => {
          currentTasksDay = dayName;
          renderTasksForDay(currentTasksDay);
        });
        tasksDayTabs.appendChild(btn);
      });
    }

    function shouldShowTask(lessonId) {
      const done = !!tasksDone[lessonId];
      if (currentTasksFilter === 'done') return done;
      if (currentTasksFilter === 'todo') return !done;
      return true;
    }

    function renderTasksForDay(dayName) {
      renderTasksTabs();
      tasksContainer.innerHTML = '';
      const block = document.createElement('div');
      block.className = 'day-block';
      const title = document.createElement('div');
      title.className = 'day-title';
      title.innerHTML = `<span class="day-icon">${dayName}</span>${dayName} –¥–æ–º–∞—à–∫–∞`;
      block.appendChild(title);

      SCHEDULE[dayName].forEach(lesson => {
        if (!shouldShowTask(lesson.id)) return;

        const row = document.createElement('div');
        row.className = 'task-row';
        row.dataset.id = lesson.id;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!tasksDone[lesson.id];

        const content = document.createElement('div');
        const line1 = document.createElement('div');
        line1.textContent = `${lesson.subject} ‚Äî –î–ó: ${getRandomHomework(lesson.subject)}`;
        const line2 = document.createElement('div');
        line2.className = 'task-meta';
        line2.textContent = `${lesson.num} —É—Ä–æ–∫ ¬∑ ${lesson.time}${lesson.room ? ' ¬∑ ' + lesson.room : ''}`;

        content.appendChild(line1);
        content.appendChild(line2);

        if (checkbox.checked) row.classList.add('done');

        checkbox.addEventListener('change', async () => {
          tasksDone[lesson.id] = checkbox.checked;
          await saveTasksDone();
          if (checkbox.checked) {
            row.classList.add('done');
            addNotification(`–û—Ç–º–µ—á–µ–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –î–ó –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${lesson.subject}`, 'hw-done');
          } else {
            row.classList.remove('done');
            addNotification(`–°–Ω—è—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${lesson.subject}`, 'hw-undo');
          }
        });

        row.appendChild(checkbox);
        row.appendChild(content);
        block.appendChild(row);
      });

      tasksContainer.appendChild(block);
    }

    /* ===== –†–µ–π—Ç–∏–Ω–≥ ===== */
    const ratingTableBody = document.getElementById('rating-table-body');
    const ratingRefreshBtn = document.getElementById('rating-refresh-btn');
    const CLASSMATES = [
      '–ú–∞—Ç–≤–µ–π –ò–≤–∞–Ω–æ–≤','–î–µ–Ω–∏—Å –ß–µ—Ä–Ω–æ–±–∞–π','–ú–∞—Ç–≤–µ–π –ö–æ–∑–ª–æ–≤',
      '–ö–∞–º–∏–ª–ª–∞ –ó–∞–π–Ω—É–¥–∏–Ω–æ–≤–∞','–õ–µ–æ–Ω–∏–¥ –°–∏–Ω–∞–Ω–Ω–∏','–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ù–æ–≤–∏–∫–æ–≤–∞(–ü–æ—Å–º–µ—Ä—Ç–Ω–æ)',
      '–¢–∏–º–æ—Ñ–µ–π –ú–æ—Ä–æ–∑–æ–≤','–ü–æ–ª–∏–Ω–∞ –ö–µ–∫–∫–∏','–ê—Ä—Ç—ë–º –°—É—Ö–æ–≤','–ê–ª–µ–∫—Å–µ–π –ë–∏–±–∏–∫–æ–≤',
      '–¢–∏—Ö–æ–Ω–æ–≤ –¢–∏—Ö–æ–Ω','–ö–∏—Ä–∏–ª–ª –ï—Ñ–∞–Ω–æ–≤','–ö—Å–µ–Ω–∏—è –¢–æ–Ω–∫–æ–Ω–æ–≥–æ–≤–∞','–ê—Ä—Ç—ë–º –ö—É—Ö–∞—Ä–µ–≤',
      '–ê—Ä—Ç—ë–º –í–∞—Å–∏–ª—å–µ–≤','–ì–µ—Ä—ã—á','–õ–∞—Ä–∏–Ω –ú–∞–∫—Å–∏–º','–°–ª—É–≥–∏–Ω –ì–æ—Ä–¥–µ–π','–ú—É—Ö–∞–Ω–æ–≤ –ì–ª–µ–±',
      '–ê—Ä—Å–µ–Ω–∏–π –ë–æ—Ä–∏—Å–æ–≤','–†–∏—Ç–∞ –ë–∞—Ä–æ–Ω–∫–∏–Ω–∞','–ê–Ω–∞—Å—Ç–∞—Å–∏—è –¢—Ä–æ—Ö–æ–Ω–∞','–Ø—Ä–æ—Å–ª–∞–≤ –°—É–ª–∏–º–æ–≤',
      '–õ—é–±–æ–≤—å –ú—Ö—á—è–Ω','–ê–Ω–∞—Å—Ç–∞—Å–∏—è –ü–æ–Ω–∞—Å—É—Ç–∫–∏–Ω–∞','–õ—é–±–æ–≤—å –î–∞–Ω–∏–ª–æ–≤–∞','–°–∞–≤–µ–ª–∏–π –•–æ–¥—ã–∫–∏–Ω','–ö–ª–∏–º–µ–Ω—Ç–∏–π'
    ];
    function generateRandomMark() { return (3 + Math.random() * 2).toFixed(2); }
    function buildRatingData() {
      const myAvg = getMyAverage();
      const myName = profile.name || '–¢—ã';
      const list = CLASSMATES.map(name => ({ name, avg: Number(generateRandomMark()) }));
      list.push({ name: myName + ' (—Ç—ã)', avg: Number(myAvg.toFixed(2)) });
      list.sort((a, b) => b.avg - a.avg);
      return list;
    }
    function renderRating() {
      const data = buildRatingData();
      ratingTableBody.innerHTML = '';
      data.forEach((item, index) => {
        const tr = document.createElement('tr');
        const isMe = item.name.includes('(—Ç—ã)');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.name}</td>
          <td>${item.avg.toFixed(2)}</td>
        `;
        if (isMe) {
          tr.style.fontWeight = '600';
          tr.style.background = 'rgba(30, 64, 175, 0.4)';
        }
        ratingTableBody.appendChild(tr);
      });
      saveRatingHistoryEntry(data);
    }
    ratingRefreshBtn.addEventListener('click', () => {
      renderRating();
      addNotification('–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∞—Å—Å–∞ –æ–±–Ω–æ–≤–ª—ë–Ω', 'rating');
    });

    /* ===== –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ ===== */
    const RATING_HISTORY_KEY = 'venik-rating-history';
    const ratingHistoryDiv = document.getElementById('rating-history');
    function loadRatingHistory() {
      const raw = localStorage.getItem(RATING_HISTORY_KEY);
      return raw ? JSON.parse(raw) : [];
    }
    function saveRatingHistory(history) {
      localStorage.setItem(RATING_HISTORY_KEY, JSON.stringify(history));
    }
    function getTodayKey() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }
    function saveRatingHistoryEntry(latestData) {
      const data = latestData || buildRatingData();
      const myName = (profile.name || '–¢—ã') + ' (—Ç—ã)';
      const myPos = data.findIndex(x => x.name === myName) + 1;
      const myAvg = getMyAverage().toFixed(2);
      const history = loadRatingHistory();
      const today = getTodayKey();
      const key = `${today}-q${currentQuarter}-w${currentWeek}`;
      const existing = history.find(h => h.key === key);
      if (existing) {
        existing.position = myPos;
        existing.avg = myAvg;
      } else {
        history.push({ key, date: today, quarter: currentQuarter, week: currentWeek, position: myPos, avg: myAvg });
      }
      saveRatingHistory(history);
      if (currentUser) {
        saveUserQuarterDoc(currentUser.uid, currentQuarter);
      }
    }
    function renderRatingHistory() {
      const history = loadRatingHistory().filter(h => h.quarter === currentQuarter && h.week === currentWeek);
      ratingHistoryDiv.innerHTML = '<h4 style="margin-bottom:4px;">–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ (—ç—Ç–∞ —á–µ—Ç–≤–µ—Ä—Ç—å –∏ –Ω–µ–¥–µ–ª—è)</h4>';
      if (!history.length) {
        ratingHistoryDiv.innerHTML += '<p>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è.</p>';
        return;
      }
      const list = document.createElement('ul');
      history.sort((a, b) => a.date.localeCompare(b.date)).forEach(h => {
        const li = document.createElement('li');
        li.textContent = `${h.date}: –º–µ—Å—Ç–æ ${h.position}, —Å—Ä. –±–∞–ª–ª ${h.avg}`;
        list.appendChild(li);
      });
      ratingHistoryDiv.appendChild(list);
    }

    /* ===== Auth state ‚Üí Firestore, –ø–æ—á—Ç–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ ===== */
    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;

      if (user) {
        authPanel.classList.add('hidden');
        appRoot.classList.remove('hidden');

        if (profileEmailInfo) {
          profileEmailInfo.textContent = user.email || '–±–µ–∑ –ø–æ—á—Ç—ã';
        }

        await loadProfile();
        applyProfileToUI();
        await loadTasksDone();
        await loadGrades();
        renderAllByDate();
        renderSubjectsTable();
        renderSubjectList();
        renderSchedule();
        renderTasksForDay(currentTasksDay);
        renderRating();
        renderRatingHistory();
        addNotification('–î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞', 'cloud-load');
      } else {
        appRoot.classList.add('hidden');
        authPanel.classList.remove('hidden');

        if (profileEmailInfo) {
          profileEmailInfo.textContent = '‚Äî';
        }
      }
    });

    /* ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */
    loadTheme();
    loadNotifications();
    loadTgkBannerState();
    loadTopAdState();
    switchQuarter(1);
    renderSchedule();
    renderTasksForDay(currentTasksDay);
    showPage('grades');
  </script>
</body>
</html>
