<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg-main: #020617;
      --bg-elevated: #020617;
      --bg-soft: #020617;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --border-strong: rgba(148, 163, 184, 0.55);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --accent-strong: #0ea5e9;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.1);
      --success: #4ade80;
      --success-soft: rgba(74, 222, 128, 0.12);
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 10px;
      --radius-pill: 999px;
      --blur-bg: blur(16px);
    }

    [data-theme="light"] {
      --bg-main: #e5f3ff;
      --bg-elevated: rgba(255, 255, 255, 0.92);
      --bg-soft: rgba(255, 255, 255, 0.82);
      --border-subtle: rgba(148, 163, 184, 0.45);
      --border-strong: rgba(30, 64, 175, 0.6);
      --accent: #0f766e;
      --accent-soft: rgba(15, 118, 110, 0.08);
      --accent-strong: #0d9488;
      --text-main: #020617;
      --text-muted: #4b5563;
      --text-soft: #6b7280;
      --danger: #dc2626;
      --danger-soft: rgba(220, 38, 38, 0.08);
      --success: #16a34a;
      --success-soft: rgba(22, 163, 74, 0.08);
      --shadow-soft: 0 18px 50px rgba(15, 23, 42, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0f172a 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    #auth-panel {
      max-width: 380px;
      width: 100%;
      margin: 40px auto;
      padding: 24px 22px 22px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #auth-panel input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
    }

    #auth-panel input:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    #auth-panel button {
      padding: 9px 12px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    #auth-login-btn {
      background: linear-gradient(to right, #0f766e, #0ea5e9);
      color: white;
    }

    #auth-signup-btn {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    #auth-logout-btn {
      background: transparent;
      color: var(--text-soft);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      margin-top: 4px;
    }

    #auth-error {
      font-size: 12px;
      color: var(--danger);
      min-height: 16px;
    }

    .hidden {
      display: none !important;
    }

    #app-root {
      display: flex;
      width: 100%;
      max-width: 1300px;
      margin: 24px auto;
      padding: 16px 14px;
      gap: 14px;
    }

    .sidebar {
      width: 250px;
      flex-shrink: 0;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      box-shadow: 0 20px 55px rgba(15, 23, 42, 0.95);
      padding: 14px 13px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 7px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%), rgba(15, 23, 42, 0.95);
    }

    .sidebar-header img {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      object-fit: cover;
      border: 1.2px solid rgba(56, 189, 248, 0.6);
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9);
    }

    #sidebar-name {
      font-weight: 600;
      font-size: 15px;
      letter-spacing: 0.01em;
    }

    #sidebar-class {
      font-size: 12px;
      color: var(--text-muted);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      padding: 7px 9px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.16s ease-out;
      border: 1px solid transparent;
    }

    .sidebar-item:hover {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-main);
    }

    .sidebar-item.active {
      background: rgba(15, 23, 42, 0.95);
      color: #f9fafb;
      border-color: rgba(56, 189, 248, 0.8);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.15);
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      margin-bottom: 10px;
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%), rgba(15, 23, 42, 0.96);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(16px);
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #topbar-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notif-bell {
      position: relative;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.18), transparent 60%), rgba(15, 23, 42, 0.96);
    }

    #bell-badge {
      position: absolute;
      top: -3px;
      right: -3px;
      min-width: 17px;
      height: 17px;
      padding: 0 4px;
      border-radius: 999px;
      background: #f97316;
      color: white;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .topbar-user {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px 4px 4px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: rgba(15, 23, 42, 0.96);
      cursor: pointer;
      transition: all 0.16s ease-out;
    }

    .topbar-user:hover {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.15);
    }

    #avatar-small-img {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      object-fit: cover;
      flex-shrink: 0;
    }

    #topbar-name {
      font-size: 13px;
      color: var(--text-main);
    }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      padding: 7px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .btn.primary {
      background: linear-gradient(to right, #0f766e, #0ea5e9);
      color: white;
      border: 1px solid rgba(15, 23, 42, 0.9);
    }

    .btn.secondary {
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .btn.secondary:hover {
      border-color: rgba(56, 189, 248, 0.8);
    }

    main {
      flex: 1;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.11), transparent 60%), rgba(15, 23, 42, 0.97);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.96);
      padding: 14px 14px 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      font-size: 13px;
      color: var(--text-muted);
    }

    .controls button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 2px;
    }

    .controls button.active {
      background: rgba(56, 189, 248, 0.12);
      border-color: rgba(56, 189, 248, 0.9);
      color: #e5faff;
    }

    .add-grade {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      padding: 7px;
      border-radius: 18px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
    }

    .add-grade select,
    .add-grade input {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 13px;
      padding: 5px 9px;
      outline: none;
    }

    .add-grade select:focus,
    .add-grade input:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
    }

    .week-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(175px, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    .day-block {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      padding: 6px;
      min-height: 70px;
    }

    .day-block h3 {
      margin: 0 0 4px;
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .lesson-card {
      display: flex;
      align-items: flex-start;
      gap: 7px;
      padding: 6px;
      margin-bottom: 4px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.98);
    }

    .lesson-teacher img {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      object-fit: cover;
    }

    .lesson-main {
      flex: 1;
    }

    .lesson-subject {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 13px;
    }

    .lesson-type {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .lesson-more {
      font-size: 16px;
      color: var(--text-soft);
      cursor: pointer;
      padding: 0 4px;
    }

    .badge {
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      white-space: nowrap;
    }

    .badge-math { border-color:#eab308; color:#eab308; background:rgba(234,179,8,.12); }
    .badge-ru   { border-color:#f97316; color:#f97316; background:rgba(249,115,22,.12); }
    .badge-eng  { border-color:#22c55e; color:#22c55e; background:rgba(34,197,94,.12); }
    .badge-it   { border-color:#38bdf8; color:#38bdf8; background:rgba(56,189,248,.12); }
    .badge-sci  { border-color:#a855f7; color:#a855f7; background:rgba(168,85,247,.12); }
    .badge-geo  { border-color:#22c55e; color:#22c55e; background:rgba(34,197,94,.12); }
    .badge-hist { border-color:#f97316; color:#f97316; background:rgba(249,115,22,.12); }
    .badge-pe   { border-color:#facc15; color:#facc15; background:rgba(250,204,21,.12); }
    .badge-other{ border-color:#6b7280; color:#9ca3af; background:rgba(148,163,184,.14); }

    .subjects-summary table,
    #page-rating table,
    #page-admin table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }

    table thead {
      background: rgba(15, 23, 42, 0.98);
    }

    table th, table td {
      border: 1px solid rgba(148, 163, 184, 0.65);
      padding: 5px 6px;
      text-align: left;
    }

    table th {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 12px;
    }

    #subject-list {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .tabs-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .day-tab {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
    }

    .day-tab.active {
      background: rgba(56, 189, 248, 0.15);
      border-color: rgba(56, 189, 248, 0.9);
      color: #e5faff;
    }

    .day-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--text-muted);
    }

    .day-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .tasks-controls {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .tasks-controls select {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 12px;
      padding: 3px 8px;
      margin-left: 4px;
    }

    .task-row {
      display: flex;
      gap: 6px;
      align-items: flex-start;
      padding: 5px 6px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.98);
      margin-bottom: 4px;
      font-size: 12px;
    }

    .task-row input[type="checkbox"] {
      margin-top: 3px;
    }

    .task-row.done {
      background: var(--success-soft);
      border-color: var(--success);
    }

    .task-meta {
      margin-top: 2px;
      color: var(--text-soft);
      font-size: 11px;
    }

    .chat-layout {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 10px;
      height: 100%;
      min-height: 320px;
    }

    .chat-sidebar {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      padding: 8px 7px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .chat-sidebar h3 {
      margin: 0 0 4px;
      font-size: 14px;
      color: var(--text-muted);
    }

    #chat-dialogs-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 2px;
    }

    .chat-dialog-item {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 5px 6px;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.14s ease-out;
    }

    .chat-dialog-item:hover {
      background: rgba(30, 64, 175, 0.25);
    }

    .chat-dialog-item.active {
      background: rgba(56, 189, 248, 0.18);
      border: 1px solid rgba(56, 189, 248, 0.8);
    }

    .chat-dialog-avatar img {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      object-fit: cover;
    }

    .chat-dialog-name {
      font-size: 13px;
    }

    .chat-dialog-last {
      font-size: 11px;
      color: var(--text-soft);
      margin-left: auto;
    }

    .chat-main {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      display: flex;
      flex-direction: column;
      padding: 6px;
    }

    .chat-header {
      padding: 4px 4px 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    #chat-current-name {
      font-size: 14px;
      font-weight: 500;
    }

    .chat-status {
      font-size: 11px;
      color: var(--text-soft);
    }

    #chat-messages {
      flex: 1;
      padding: 6px 4px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .chat-message {
      max-width: 70%;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 7px;
      background: rgba(15, 23, 42, 0.96);
    }

    .chat-message.me {
      margin-left: auto;
      background: rgba(56, 189, 248, 0.15);
      border-color: rgba(56, 189, 248, 0.9);
    }

    .chat-message-meta {
      margin-top: 2px;
      font-size: 10px;
      color: var(--text-soft);
      text-align: right;
    }

    .chat-input-row {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    #chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 13px;
      padding: 6px 10px;
      outline: none;
    }

    #chat-input:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 7px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
    }

    #profile-avatar-img {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: 1.5px solid rgba(56, 189, 248, 0.8);
      object-fit: cover;
    }

    #profile-name-display {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    #profile-class-display {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--text-soft);
    }

    .profile-info {
      margin-top: 8px;
      padding: 8px 8px 9px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.98);
      font-size: 13px;
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(170px,1fr));
      gap: 6px;
    }

    .profile-form {
      margin-top: 8px;
      padding: 8px;
      border-radius: 18px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .profile-form label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .profile-form input {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 13px;
      padding: 5px 9px;
      outline: none;
    }

    #page-notifications .notif-controls {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    #notifications-list {
      margin-top: 4px;
      max-height: 260px;
      overflow-y: auto;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.98);
      padding: 6px;
      font-size: 12px;
    }

    .notif-item {
      padding: 5px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.96);
      margin-bottom: 4px;
    }

    .notif-item.new {
      border-color: rgba(56, 189, 248, 0.9);
      background: rgba(56, 189, 248, 0.12);
    }

    .notif-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .notif-text {
      font-size: 12px;
    }

    .notif-time {
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    #page-admin table {
      font-size: 11px;
    }

    @media (max-width: 960px) {
      #app-root {
        flex-direction: column;
        padding: 10px;
      }
      .sidebar {
        position: static;
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        overflow-x: auto;
      }
      .sidebar-header {
        flex-shrink: 0;
      }
      .sidebar-nav {
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .chat-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      main {
        padding: 10px;
      }
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .add-grade {
        flex-direction: column;
      }
    }
  </style>
</head>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy,
    limit,
    deleteDoc,
    collectionGroup,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"; /* [web:505][web:570] */

  const firebaseConfig = {
    apiKey: "AIzaSyAFcX2I6lfzmxwEGEpOej-SqiG6-DFWSDc",
    authDomain: "venik-fa40b.firebaseapp.com",
    projectId: "venik-fa40b",
    storageBucket: "venik-fa40b.firebasestorage.app",
    messagingSenderId: "1049573809722",
    appId: "1:1049573809722:web:492952ba95624b8ac01f03",
    measurementId: "G-GMM29TBZ2K"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ADMIN_EMAIL = 'alex.bibikov082011@yandex.ru';

  // --- DOM ---
  const authPanel = document.getElementById('auth-panel');
  const appRoot = document.getElementById('app-root');
  const emailInput = document.getElementById('auth-email');
  const passInput = document.getElementById('auth-password');
  const loginBtn = document.getElementById('auth-login-btn');
  const signupBtn = document.getElementById('auth-signup-btn');
  const logoutBtn = document.getElementById('auth-logout-btn');
  const authError = document.getElementById('auth-error');

  const themeToggleBtn = document.getElementById('theme-toggle');
  const themeToggleIcon = document.getElementById('theme-toggle-icon');
  const themeToggleText = document.getElementById('theme-toggle-text');

  const avatarSmallImg = document.getElementById('avatar-small-img');
  const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
  const topbarTitle = document.getElementById('topbar-title');
  const topbarName = document.getElementById('topbar-name');
  const sidebarName = document.getElementById('sidebar-name');
  const sidebarClass = document.getElementById('sidebar-class');

  const profileAvatarImg = document.getElementById('profile-avatar-img');
  const profileNameDisplay = document.getElementById('profile-name-display');
  const profileClassDisplay = document.getElementById('profile-class-display');
  const profileNameInfo = document.getElementById('profile-name-info');
  const profileEmailInfo = document.getElementById('profile-email-info');
  const profileCityInfo = document.getElementById('profile-city-info');
  const profileClassInfo = document.getElementById('profile-class-info');
  const profileFavInfo = document.getElementById('profile-fav-info');

  const avatarInput = document.getElementById('profile-avatar-input');
  const nameInput = document.getElementById('profile-name-input');
  const cityInput = document.getElementById('profile-city-input');
  const classInput = document.getElementById('profile-class-input');
  const favInput = document.getElementById('profile-fav-input');
  const profileSaveBtn = document.getElementById('profile-save-btn');
  const profileMessageBtn = document.getElementById('profile-message-btn');

  const bellBadge = document.getElementById('bell-badge');
  const notifList = document.getElementById('notifications-list');
  const notifMarkReadBtn = document.getElementById('notif-mark-read');
  const notifClearBtn = document.getElementById('notif-clear');
  const sidebarNotifItem = document.getElementById('sidebar-notif-item');

  const pageSections = document.querySelectorAll('[id^="page-"]');
  const sidebarItems = document.querySelectorAll('.sidebar-item');

  const subjectsTableBody = document.getElementById('subjects-table-body');
  const subjectListDiv = document.getElementById('subject-list');

  const ratingTableBody = document.getElementById('rating-table-body');
  const ratingRefreshBtn = document.getElementById('rating-refresh-btn');
  const ratingHistoryDiv = document.getElementById('rating-history');

  const adminVisitsBody = document.getElementById('admin-visits-body');
  const adminWarning = document.getElementById('admin-warning');

  const subjectSelect = document.getElementById('subject-input');
  const typeInput = document.getElementById('type-input');
  const daySelect = document.getElementById('day-select');
  const markInput = document.getElementById('mark-input');
  const addBtn = document.getElementById('add-grade-btn');

  const scheduleDayTabs = document.getElementById('schedule-day-tabs');
  const scheduleContainer = document.getElementById('schedule-container');

  const tasksDayTabs = document.getElementById('tasks-day-tabs');
  const tasksContainer = document.getElementById('tasks-container');
  const tasksFilterSelect = document.getElementById('tasks-filter-select');

  // --- Theme ---
  const THEME_KEY = 'venik-theme';
  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    if (theme === 'light') {
      themeToggleIcon.textContent = '‚òÄÔ∏è';
      themeToggleText.textContent = '–°–≤–µ—Ç–ª–∞—è';
    } else {
      themeToggleIcon.textContent = 'üåô';
      themeToggleText.textContent = '–¢—ë–º–Ω–∞—è';
    }
  }
  function loadTheme() {
    const saved = localStorage.getItem(THEME_KEY);
    const theme = saved === 'light' || saved === 'dark' ? saved : 'dark';
    applyTheme(theme);
  }
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    localStorage.setItem(THEME_KEY, next);
  }
  themeToggleBtn.addEventListener('click', toggleTheme);

  // --- Notifications ---
  const NOTIF_KEY = 'venik-notifications';
  let notifications = [];
  let unreadCount = 0;

  function loadNotifications() {
    const raw = localStorage.getItem(NOTIF_KEY);
    notifications = raw ? JSON.parse(raw) : [];
    unreadCount = notifications.filter(n => !n.read).length;
    updateNotifUI();
  }
  function saveNotifications() {
    localStorage.setItem(NOTIF_KEY, JSON.stringify(notifications));
  }
  function formatTime(date) {
    const d = new Date(date);
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return hh + ':' + mm;
  }
  function addNotification(text, type) {
    const newNotif = {
      id: Date.now().toString() + Math.random().toString(16).slice(2),
      text,
      type,
      createdAt: new Date().toISOString(),
      read: false
    };
    notifications.unshift(newNotif);
    unreadCount++;
    saveNotifications();
    updateNotifUI();
  }
  window.addNotification = addNotification;

  function updateNotifUI() {
    if (unreadCount > 0) {
      bellBadge.classList.remove('hidden');
      bellBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
    } else {
      bellBadge.classList.add('hidden');
    }

    notifList.innerHTML = '';
    if (!notifications.length) {
      const p = document.createElement('p');
      p.style.fontSize = '12px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–ü–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç.';
      notifList.appendChild(p);
      return;
    }
    notifications.forEach(n => {
      const item = document.createElement('div');
      item.className = 'notif-item' + (n.read ? '' : ' new');
      const main = document.createElement('div');
      main.className = 'notif-main';
      const txt = document.createElement('div');
      txt.className = 'notif-text';
      txt.textContent = n.text;
      const time = document.createElement('div');
      time.className = 'notif-time';
      time.textContent = formatTime(n.createdAt);
      main.appendChild(txt);
      main.appendChild(time);
      item.appendChild(main);
      notifList.appendChild(item);
    });
  }

  notifMarkReadBtn.addEventListener('click', () => {
    notifications.forEach(n => n.read = true);
    unreadCount = 0;
    saveNotifications();
    updateNotifUI();
  });
  notifClearBtn.addEventListener('click', () => {
    notifications = [];
    unreadCount = 0;
    saveNotifications();
    updateNotifUI();
  });

  if (sidebarNotifItem) {
    sidebarNotifItem.addEventListener('click', () => {
      showPage('notifications');
    });
  }

  // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è ---
  function showPage(pageName) {
    pageSections.forEach(sec => {
      sec.classList.toggle('hidden', sec.id !== 'page-' + pageName);
    });
    sidebarItems.forEach(i => {
      const isNotif = pageName === 'notifications' && i.id === 'sidebar-notif-item';
      i.classList.toggle('active', i.dataset.page === pageName || isNotif);
    });

    if (pageName === 'schedule') renderSchedule();
    if (pageName === 'tasks') renderTasksForDay(currentTasksDay);
    if (pageName === 'rating') { renderRating(); renderRatingHistory(); }
    if (pageName === 'admin') loadAdminVisits();
  }

  document.querySelectorAll('[data-page]').forEach(el => {
    el.addEventListener('click', () => {
      const page = el.dataset.page;
      if (!page) return;
      if (page === 'profile') {
        viewedProfileUid = null;
        applyProfileToUI();
      }
      showPage(page);
    });
  });

  // --- –ü—Ä–æ—Ñ–∏–ª—å ---
  const PROFILE_KEY = 'venik-profile';
  let profile = {
    avatarUrl: '',
    name: '–í–µ–Ω–∏–∫ –í–µ–Ω–∏–∫–æ–≤',
    city: '–ü–æ–¥–æ–ª—å—Å–∫',
    className: '8–ë',
    favSubjects: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'
  };
  let currentUser = null;
  let viewedProfileUid = null;

  function validateName(raw) {
    const name = (raw || '').trim();
    if (name.length < 2 || name.length > 24) {
      return { ok: false, reason: '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 24 —Å–∏–º–≤–æ–ª–æ–≤.' };
    }
    const allowedRe = /^[A-Za-z–ê-–Ø–∞-—è–Å—ë \-]+$/u;
    if (!allowedRe.test(name)) {
      return { ok: false, reason: '–ò–º—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª –∏ –¥–µ—Ñ–∏—Å.' };
    }
    const badWords = [
      '—Ö—É–π','—Ö—É–µ','—Ö–µ—Ä','–ø–∏–∑–¥','–µ–±–∞','–µ–±–ª','–º—É–¥–∞–∫','—Å—É–∫–∞','–±–ª—è–¥','–ª–æ—Ö',
      'idiot','fuck','shit','bitch','asshole'
    ];
    const lower = name.toLowerCase();
    if (badWords.some(w => lower.includes(w))) {
      return { ok: false, reason: '–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –º–∞—Ç –≤ –∏–º–µ–Ω–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.' };
    }
    return { ok: true, reason: '' };
  }

  function applyProfileToUI() {
    const isOwn = !viewedProfileUid || !currentUser || viewedProfileUid === currentUser.uid;
    const avatar = profile.avatarUrl || 'teacher.jpg';

    avatarSmallImg.src = avatar;
    sidebarAvatarImg.src = avatar;
    if (isOwn) profileAvatarImg.src = avatar;

    topbarTitle.textContent = '–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞';
    sidebarName.textContent = '–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞';

    topbarName.textContent = (profile.name || '–ü—Ä–æ—Ñ–∏–ª—å') + ' ‚ñæ';
    sidebarClass.textContent = profile.className + ' –∫–ª–∞—Å—Å';

    if (isOwn) {
      profileNameDisplay.textContent = profile.name;
      profileClassDisplay.textContent = `–£—á–µ–Ω–∏–∫ ${profile.className} –∫–ª–∞—Å—Å–∞`;
      profileNameInfo.textContent = profile.name;
      profileCityInfo.textContent = profile.city;
      profileClassInfo.textContent = profile.className;
      profileFavInfo.textContent = profile.favSubjects;
      profileEmailInfo.textContent = currentUser ? (currentUser.email || '–±–µ–∑ –ø–æ—á—Ç—ã') : '‚Äî';
    }

    avatarInput.value = profile.avatarUrl;
    nameInput.value = profile.name;
    cityInput.value = profile.city;
    classInput.value = profile.className;
    favInput.value = profile.favSubjects;

    const profileForm = document.querySelector('.profile-form');
    if (profileForm) profileForm.style.display = isOwn ? 'block' : 'none';

    if (profileMessageBtn) {
      profileMessageBtn.style.display = (!isOwn && currentUser) ? 'inline-flex' : 'none';
    }
  }
  window.applyProfileToUI = applyProfileToUI;

  async function loadUserQuarterDoc(uid, quarter) {
    const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      return {
        grades_w1: [],
        grades_w2: [],
        grades_w3: [],
        grades_w4: [],
        profile,
        tasksDone,
        ratingHistory: loadRatingHistory(),
        avgByWeek: {}
      };
    }
    const data = snap.data();
    return {
      grades_w1: data.grades_w1 || [],
      grades_w2: data.grades_w2 || [],
      grades_w3: data.grades_w3 || [],
      grades_w4: data.grades_w4 || [],
      profile: data.profile || profile,
      tasksDone: data.tasksDone || tasksDone,
      ratingHistory: data.ratingHistory || [],
      avgByWeek: data.avgByWeek || {}
    };
  }

  async function saveUserQuarterDoc(uid, quarter) {
    const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
    const avgThisWeek = getMyAverage();
    const payload = {
      profile,
      tasksDone,
      ratingHistory: loadRatingHistory(),
      avgByWeek: {
        [currentWeek]: avgThisWeek || 0
      }
    };
    payload['grades_w' + currentWeek] = grades;
    await setDoc(ref, payload, { merge: true });
  }

  async function loadProfile() {
    const raw = localStorage.getItem(PROFILE_KEY);
    if (raw) {
      try { profile = Object.assign(profile, JSON.parse(raw)); } catch(e){}
    }
    if (currentUser) {
      const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
      profile = Object.assign(profile, data.profile || {});
    }
    if (currentUser) {
      await setDoc(doc(db, 'users', currentUser.uid), {
        uid: currentUser.uid,
        email: currentUser.email || null,
        name: profile.name,
        avatarUrl: profile.avatarUrl || '',
        className: profile.className || '',
        city: profile.city || ''
      }, { merge: true }); /* [web:568] */
    }
  }
  async function saveProfile() {
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    if (!currentUser) return;
    await saveUserQuarterDoc(currentUser.uid, currentQuarter);
    await setDoc(doc(db, 'users', currentUser.uid), {
      uid: currentUser.uid,
      email: currentUser.email || null,
      name: profile.name,
      avatarUrl: profile.avatarUrl || '',
      className: profile.className || '',
      city: profile.city || ''
    }, { merge: true });
  }

  profileSaveBtn.addEventListener('click', async () => {
    const rawName = nameInput.value.trim();
    const check = validateName(rawName);
    if (!check.ok) {
      alert(check.reason);
      return;
    }
    profile.avatarUrl = avatarInput.value.trim();
    profile.name = rawName;
    profile.city = cityInput.value.trim() || '–ì–æ—Ä–æ–¥';
    profile.className = classInput.value.trim() || '–ö–ª–∞—Å—Å';
    profile.favSubjects = favInput.value.trim() || '–ù–µ—Ç';

    await saveProfile();
    applyProfileToUI();
    renderAllByDate();
    addNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'profile');
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  });

  async function loadProfileOfUser(uid, quarter) {
    const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
    const snap = await getDoc(ref);
    if (!snap.exists()) return null;
    const data = snap.data() || {};
    const prof = data.profile || {};
    return {
      profile: {
        avatarUrl: prof.avatarUrl || 'teacher.jpg',
        name: prof.name || '–£—á–µ–Ω–∏–∫',
        city: prof.city || '–ì–æ—Ä–æ–¥',
        className: prof.className || '–ö–ª–∞—Å—Å',
        favSubjects: prof.favSubjects || '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'
      }
    };
  }

  async function openProfileForUser(uid) {
    if (!uid || !currentUser) return;
    viewedProfileUid = uid;
    const foreign = await loadProfileOfUser(uid, currentQuarter);
    if (!foreign) {
      alert('–ü—Ä–æ—Ñ–∏–ª—å —ç—Ç–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –µ—â—ë –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω.');
      return;
    }
    const p = foreign.profile;
    const avatar = p.avatarUrl || 'teacher.jpg';
    profileAvatarImg.src = avatar;
    profileNameDisplay.textContent = p.name;
    profileClassDisplay.textContent = `–£—á–µ–Ω–∏–∫ ${p.className} –∫–ª–∞—Å—Å–∞`;
    profileNameInfo.textContent = p.name;
    profileCityInfo.textContent = p.city;
    profileClassInfo.textContent = p.className;
    profileFavInfo.textContent = p.favSubjects;
    profileEmailInfo.textContent = (currentUser && uid === currentUser.uid)
      ? (currentUser.email || '–±–µ–∑ –ø–æ—á—Ç—ã')
      : '–°–∫—Ä—ã—Ç–æ';

    const profileForm = document.querySelector('.profile-form');
    if (profileForm) {
      profileForm.style.display = (currentUser && uid === currentUser.uid) ? 'block' : 'none';
    }

    if (profileMessageBtn) {
      const isOwn = currentUser && uid === currentUser.uid;
      profileMessageBtn.style.display = (!isOwn && currentUser) ? 'inline-flex' : 'none';
      profileMessageBtn.onclick = () => {
        if (!currentUser) return;
        if (typeof window.openChatForUid === 'function') {
          window.openChatForUid(uid);
        }
        showPage('chat');
      };
    }

    showPage('profile');
  }
  window.openProfileForUser = openProfileForUser;

  // --- –û—Ü–µ–Ω–∫–∏ / —á–µ—Ç–≤–µ—Ä—Ç–∏ / –Ω–µ–¥–µ–ª–∏ ---
  const GRADES_PREFIX = 'venik-grades-q';
  let currentQuarter = 1;
  let currentWeek = 1;
  let grades = [];

  const quarterBtns = document.querySelectorAll('.quarter-btn');
  const weekBtns = document.querySelectorAll('.week-btn');
  const currentQuarterLabel = document.getElementById('current-quarter-label');
  const currentWeekLabel = document.getElementById('current-week-label');

  function storageKeyFor(quarter, week) {
    return `${GRADES_PREFIX}${quarter}-w${week}`;
  }

  async function loadGrades() {
    if (!currentUser) {
      const raw = localStorage.getItem(storageKeyFor(currentQuarter, currentWeek));
      grades = raw ? JSON.parse(raw) : [];
      return;
    }
    const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
    grades = data['grades_w' + currentWeek] || [];
  }
  window.loadGrades = loadGrades;

  async function saveGrades() {
    localStorage.setItem(storageKeyFor(currentQuarter, currentWeek), JSON.stringify(grades));
    if (!currentUser) return;
    await saveUserQuarterDoc(currentUser.uid, currentQuarter);
  }
  window.saveGrades = saveGrades;

  async function switchQuarter(q) {
    currentQuarter = q;
    quarterBtns.forEach(b => b.classList.toggle('active', Number(b.dataset.quarter) === q));
    currentQuarterLabel.textContent = q + ' —á–µ—Ç–≤–µ—Ä—Ç—å';
    await switchWeek(1);
  }
  async function switchWeek(w) {
    currentWeek = w;
    weekBtns.forEach(b => b.classList.toggle('active', Number(b.dataset.week) === w));
    currentWeekLabel.textContent = w + ' –Ω–µ–¥–µ–ª—è';
    await loadGrades();
    renderAllByDate();
    renderSubjectsTable();
    renderSubjectList();
    await renderRating();
    renderRatingHistory();
  }
  window.switchQuarter = switchQuarter;
  window.switchWeek = switchWeek;

  quarterBtns.forEach(btn => btn.addEventListener('click', () => switchQuarter(Number(btn.dataset.quarter))));
  weekBtns.forEach(btn => btn.addEventListener('click', () => switchWeek(Number(btn.dataset.week))));

  const dayBlocksMap = {
    mon: document.getElementById('mon-block'),
    tue: document.getElementById('tue-block'),
    wed: document.getElementById('wed-block'),
    thu: document.getElementById('thu-block'),
    fri: document.getElementById('fri-block'),
    sat: document.getElementById('sat-block'),
    sun: document.getElementById('sun-block'),
  };
  function blockByDay(day) {
    return dayBlocksMap[day] || dayBlocksMap.mon;
  }
  function clearDayBlocks() {
    Object.values(dayBlocksMap).forEach(block => {
      block.querySelectorAll('.lesson-card').forEach(c => c.remove());
    });
  }

  function subjectBadgeClass(subject) {
    if (/–∞–ª–≥–µ–±—Ä–∞|–≥–µ–æ–º–µ—Ç—Ä–∏—è|—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫/i.test(subject)) return 'badge-math';
    if (/—Ä—É—Å—Å–∫–∏–π/i.test(subject)) return 'badge-ru';
    if (/–∞–Ω–≥–ª–∏–π/i.test(subject)) return 'badge-eng';
    if (/–∏–Ω—Ñ–æ—Ä–º–∞—Ç|–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç/i.test(subject)) return 'badge-it';
    if (/—Ñ–∏–∑–∏–∫–∞|—Ö–∏–º–∏—è|–±–∏–æ–ª–æ–≥/i.test(subject)) return 'badge-sci';
    if (/–≥–µ–æ–≥—Ä–∞—Ñ/i.test(subject)) return 'badge-geo';
    if (/–∏—Å—Ç–æ—Ä|–æ–±—â–µ/i.test(subject)) return 'badge-hist';
    if (/—Ñ–∏–∑–∏—á–µ—Å–∫/i.test(subject)) return 'badge-pe';
    return 'badge-other';
  }

  function createLessonCard(grade) {
    const card = document.createElement('article');
    card.className = 'lesson-card';
    card.dataset.id = grade.id;
    const badgeClass = subjectBadgeClass(grade.subject);
    card.innerHTML = `
      <div class="lesson-teacher">
        <img src="${profile.avatarUrl || 'teacher.jpg'}" alt="teacher">
      </div>
      <div class="lesson-main">
        <div class="lesson-subject">
          <span>${grade.subject} ‚Äî ${grade.mark}</span>
          <span class="badge ${badgeClass}">–æ—Ü–µ–Ω–∫–∞</span>
        </div>
        <div class="lesson-type">${grade.type}</div>
      </div>
      <div class="lesson-more" title="–£–¥–∞–ª–∏—Ç—å">‚úï</div>
    `;
    card.querySelector('.lesson-more').addEventListener('click', async () => {
      grades = grades.filter(g => g.id !== grade.id);
      await saveGrades();
      card.remove();
      renderSubjectsTable();
      renderSubjectList();
      await renderRating();
      saveRatingHistoryEntry();
      addNotification(`–£–¥–∞–ª–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞ ${grade.mark} –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${grade.subject}`, 'grade-delete');
    });
    return card;
  }
  function renderAllByDate() {
    clearDayBlocks();
    grades.forEach(g => {
      const block = blockByDay(g.day);
      block.appendChild(createLessonCard(g));
    });
  }
  window.renderAllByDate = renderAllByDate;

  addBtn.addEventListener('click', async () => {
    const subject = subjectSelect.value;
    const type = typeInput.value.trim();
    const mark = Number(markInput.value) || 0;
    const day = daySelect.value;
    if (!mark || mark < 1 || mark > 5) {
      alert('–í–≤–µ–¥–∏ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5');
      return;
    }
    const newGrade = {
      id: Date.now().toString() + '-' + Math.random().toString(16).slice(2),
      subject,
      type: type || '–†–∞–±–æ—Ç–∞',
      mark,
      day,
      quarter: currentQuarter,
      week: currentWeek
    };
    grades.push(newGrade);
    await saveGrades();
    blockByDay(day).appendChild(createLessonCard(newGrade));
    markInput.value = '';
    typeInput.value = '';
    renderSubjectsTable();
    renderSubjectList();
    await renderRating();
    saveRatingHistoryEntry();
    addNotification(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞ ${newGrade.mark} –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${newGrade.subject}`, 'grade-add');
  });

  // --- –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º ---
  function calcAverage(arr) {
    if (!arr.length) return 0;
    const sum = arr.reduce((a, b) => a + b, 0);
    return sum / arr.length;
  }
  function groupBySubject() {
    const map = {};
    grades.forEach(g => {
      if (!map[g.subject]) map[g.subject] = [];
      map[g.subject].push(g.mark);
    });
    return map;
  }
  function renderSubjectsTable() {
    const groups = groupBySubject();
    subjectsTableBody.innerHTML = '';
    Object.keys(groups).forEach(subj => {
      const marks = groups[subj];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${subj}</td>
        <td>${marks.join(', ')}</td>
        <td>${calcAverage(marks).toFixed(2)}</td>
      `;
      subjectsTableBody.appendChild(tr);
    });
  }
  window.renderSubjectsTable = renderSubjectsTable;

  function renderSubjectList() {
    const groups = groupBySubject();
    subjectListDiv.innerHTML = '';
    const keys = Object.keys(groups);
    if (!keys.length) {
      subjectListDiv.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫ –¥–ª—è —ç—Ç–æ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ –∏ –Ω–µ–¥–µ–ª–∏.';
      return;
    }
    keys.forEach(subj => {
      const marks = groups[subj];
      const p = document.createElement('p');
      p.textContent = `${subj}: ${marks.join(', ')} (—Å—Ä. ${calcAverage(marks).toFixed(2)})`;
      subjectListDiv.appendChild(p);
    });
  }
  window.renderSubjectList = renderSubjectList;

  function getMyAverage() {
    const marks = grades.map(g => g.mark).filter(m => m > 0);
    return calcAverage(marks) || 0;
  }
  window.getMyAverage = getMyAverage;

  // --- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ + –î–ó ---
  const SCHEDULE = {
    '–ü–Ω': [
      { id: 'mon-1', num: 1, time: '08:30 - 09:00', subject: '–†–∞–∑–≥–æ–≤–æ—Ä—ã –æ –≤–∞–∂–Ω–æ–º', room: '–î–ë / –∫–æ—Ä–ø—É—Å 1' },
      { id: 'mon-2', num: 2, time: '09:10 - 09:55', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 28' },
      { id: 'mon-3', num: 3, time: '10:05 - 10:50', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 28' },
      { id: 'mon-4', num: 4, time: '11:05 - 11:50', subject: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', room: '–∫–∞–±. 38' },
      { id: 'mon-5', num: 5, time: '‚Äî', subject: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', room: '–∫–∞–±. 59' },
      { id: 'mon-6', num: 6, time: '13:00 - 13:45', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 27' },
      { id: 'mon-7', num: 7, time: '14:00 - 14:40', subject: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç', room: '–∫–∞–±. 48' }
    ],
    '–í—Ç': [
      { id: 'tue-1', num: 1, time: '08:30 - 09:15', subject: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', room: '–∫–∞–±. 38' },
      { id: 'tue-2', num: 2, time: '09:25 - 10:10', subject: '–ê–ª–≥–µ–±—Ä–∞', room: '–∫–∞–±. 38' },
      { id: 'tue-3', num: 3, time: '10:20 - 11:05', subject: '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', room: '–∫–∞–±. 53' },
      { id: 'tue-4', num: 4, time: '11:20 - 12:05', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 49' },
      { id: 'tue-5', num: 5, time: '12:15 - 13:00', subject: '–ò—Å—Ç–æ—Ä–∏—è', room: '–∫–∞–±. 32' },
      { id: 'tue-6', num: 6, time: '13:15 - 13:55', subject: '–§–∏–∑–∏–∫–∞', room: '–∫–∞–±. 49' }
    ],
    '–°—Ä': [
      { id: 'wed-1', num: 1, time: '08:30 - 09:15', subject: '–ë–∏–æ–ª–æ–≥–∏—è', room: '–∫–∞–±. 55' },
      { id: 'wed-2', num: 2, time: '09:25 - 10:10', subject: '–ë–∏–æ–ª–æ–≥–∏—è', room: '–∫–∞–±. 28' },
      { id: 'wed-3', num: 3, time: '10:20 - 11:05', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 59' },
      { id: 'wed-4', num: 4, time: '11:20 - 12:05', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 38' },
      { id: 'wed-5', num: 5, time: '12:15 - 13:00', subject: '–ê–ª–≥–µ–±—Ä–∞', room: '–∫–∞–±. 38' }
    ],
    '–ß—Ç': [
      { id: 'thu-1', num: 1, time: '08:30 - 09:00', subject: '–†–û–°–°–ò–Ø ‚Äî –ú–û–ò –ì–û–†–ò–ó–û–ù–¢–´', room: '–î–ë / –≤–Ω–µ—É—Ä–æ—á–Ω–∞—è' },
      { id: 'thu-2', num: 2, time: '09:10 - 09:55', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 53' },
      { id: 'thu-3', num: 3, time: '10:05 - 10:50', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 49' },
      { id: 'thu-4', num: 4, time: '11:20 - 12:05', subject: '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ', room: '–∫–∞–±. 59' },
      { id: 'thu-5', num: 5, time: '12:00 - 12:45', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 12' }
    ],
    '–ü—Ç': [
      { id: 'fri-1', num: 1, time: '08:30 - 09:15', subject: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞', room: '—Å–ø–æ—Ä—Ç–∑–∞–ª' },
      { id: 'fri-2', num: 2, time: '09:25 - 10:10', subject: '–§–∏–∑–∏–∫–∞', room: '–∫–∞–±. 12' },
      { id: 'fri-3', num: 3, time: '10:20 - 11:05', subject: '–ú—É–∑—ã–∫–∞', room: '–∫–∞–±. 32' },
      { id: 'fri-4', num: 4, time: '11:20 - 12:05', subject: '–¢—Ä—É–¥ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è)', room: '–∫–∞–±. 55' }
    ]
  };

  const HOMEWORK_TEMPLATES = {
    '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫': [
      '–≤—ã—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏ —Å–¥–µ–ª–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è 1‚Äì3',
      '–Ω–∞–ø–∏—Å–∞—Ç—å –º–∏–Ω–∏-—Å–æ—á–∏–Ω–µ–Ω–∏–µ (80‚Äì100 —Å–ª–æ–≤)'
    ],
    '–ê–ª–≥–µ–±—Ä–∞': [
      '—Ä–µ—à–∏—Ç—å –Ω–æ–º–µ—Ä–∞ 101‚Äì105',
      '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π, —Ä–µ—à–∏—Ç—å 5 –∑–∞–¥–∞—á'
    ],
    '–ì–µ–æ–º–µ—Ç—Ä–∏—è': [
      '–ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–∞—Ä–∞–≥—Ä–∞—Ñ –∏ —Ä–µ—à–∏—Ç—å 3 –∑–∞–¥–∞—á–∏',
      '–¥–æ–∫–∞–∑–∞—Ç—å —Ç–µ–æ—Ä–µ–º—É –∏–∑ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞'
    ],
    '–§–∏–∑–∏–∫–∞': [
      '—Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞, —Ä–µ—à–∏—Ç—å 4 –∑–∞–¥–∞—á–∏',
      '—Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏'
    ],
    '–•–∏–º–∏—è': [
      '—Å–æ—Å—Ç–∞–≤–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π, –≤—ã—É—á–∏—Ç—å —Ñ–æ—Ä–º—É–ª—ã',
      '—Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞—Å—Å–æ–≤—É—é –¥–æ–ª—é'
    ],
    '–ë–∏–æ–ª–æ–≥–∏—è': [
      '–≤—ã—É—á–∏—Ç—å —Ç–µ—Ä–º–∏–Ω—ã –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É',
      '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —Ç–µ–º–µ'
    ],
    '–ò—Å—Ç–æ—Ä–∏—è': [
      '–≤—ã—É—á–∏—Ç—å –¥–∞—Ç—ã –∏ —Å–æ–±—ã—Ç–∏—è –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞',
      '—Å–¥–µ–ª–∞—Ç—å –ø–ª–∞–Ω –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞'
    ],
    '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è': [
      '–∑–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ–Ω—Ç—É—Ä–Ω—É—é –∫–∞—Ä—Ç—É',
      '–æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≤ —Ç–µ—Ç—Ä–∞–¥–∏'
    ],
    '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫': [
      '–≤—ã—É—á–∏—Ç—å 15 –Ω–æ–≤—ã—Ö —Å–ª–æ–≤ –∏ —Å–¥–µ–ª–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è',
      '–Ω–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ (80‚Äì100 —Å–ª–æ–≤)'
    ],
    '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞': [
      '–Ω–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ –æ–±—Ä–∞–∑—Ü—É',
      '—Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –∞–ª–≥–æ—Ä–∏—Ç–º—ã'
    ],
    '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç': [
      '–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ –ø–æ —Ç–µ–º–µ –∏ –∑–∞–ø–∏—Å–∞—Ç—å 5 —Ñ–∞–∫—Ç–æ–≤',
      '–ø—Ä–∏–¥—É–º–∞—Ç—å –∏–¥–µ—é –ø—Ä–æ–µ–∫—Ç–∞ —Å –ò–ò'
    ],
    '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ': [
      '–æ—Ç–≤–µ—Ç–∏—Ç—å –ø–∏—Å—å–º–µ–Ω–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞',
      '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∫ –ø–æ–Ω—è—Ç–∏—è–º'
    ],
    '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞': [
      '–≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–º–∞ –∫–æ–º–ø–ª–µ–∫—Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π',
      '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–∏–¥–µ —Å–ø–æ—Ä—Ç–∞'
    ],
    '–¢—Ä—É–¥ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è)': [
      '–∑–∞–∫–æ–Ω—á–∏—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ä–∞–±–æ—Ç—É',
      '–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è'
    ],
    '–ú—É–∑—ã–∫–∞': [
      '–ø–æ—Å–ª—É—à–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤',
      '–≤—ã—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏'
    ]
  };

  function getRandomHomework(subject) {
    const list = HOMEWORK_TEMPLATES[subject];
    if (!list || !list.length) return '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª —É—Ä–æ–∫–∞.';
    const i = Math.floor(Math.random() * list.length);
    return list[i];
  }

  const dayKeys = Object.keys(SCHEDULE);
  let currentScheduleDay = dayKeys[0];

  function renderScheduleTabs() {
    scheduleDayTabs.innerHTML = '';
    dayKeys.forEach(dayName => {
      const btn = document.createElement('button');
      btn.className = 'day-tab' + (dayName === currentScheduleDay ? ' active' : '');
      btn.textContent = dayName;
      btn.addEventListener('click', () => {
        currentScheduleDay = dayName;
        renderSchedule();
      });
      scheduleDayTabs.appendChild(btn);
    });
  }

  function renderSchedule() {
    renderScheduleTabs();
    scheduleContainer.innerHTML = '';
    const block = document.createElement('div');
    block.className = 'day-block';
    const title = document.createElement('div');
    title.className = 'day-title';
    title.innerHTML = `<span class="day-icon">${currentScheduleDay}</span>${currentScheduleDay} —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ`;
    block.appendChild(title);

    SCHEDULE[currentScheduleDay].forEach(lesson => {
      const card = document.createElement('div');
      card.className = 'lesson-card';

      const avatar = document.createElement('div');
      avatar.className = 'lesson-teacher';
      avatar.innerHTML = `<img src="${profile.avatarUrl || 'teacher.jpg'}" alt="teacher">`;

      const main = document.createElement('div');
      main.className = 'lesson-main';
      const badgeClass = subjectBadgeClass(lesson.subject);
      const line1 = document.createElement('div');
      line1.className = 'lesson-subject';
      line1.innerHTML = `<span>${lesson.num} —É—Ä–æ–∫ ¬∑ ${lesson.subject}</span><span class="badge ${badgeClass}">—É—Ä–æ–∫</span>`;
      const line2 = document.createElement('div');
      line2.className = 'lesson-type';
      line2.textContent = `${lesson.time}${lesson.room ? ' ¬∑ ' + lesson.room : ''}`;
      main.appendChild(line1);
      main.appendChild(line2);

      card.appendChild(avatar);
      card.appendChild(main);
      block.appendChild(card);
    });

    scheduleContainer.appendChild(block);
  }
  window.renderSchedule = renderSchedule;

  // --- –î–æ–º–∞—à–∫–∞ ---
  const TASKS_DONE_KEY = 'venik-tasks-done';
  let tasksDone = {};
  let currentTasksDay = dayKeys[0];
  let currentTasksFilter = 'all';

  async function loadTasksDone() {
    const raw = localStorage.getItem(TASKS_DONE_KEY);
    tasksDone = raw ? JSON.parse(raw) : {};
    if (currentUser) {
      const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
      tasksDone = data.tasksDone || tasksDone;
    }
  }
  async function saveTasksDone() {
    localStorage.setItem(TASKS_DONE_KEY, JSON.stringify(tasksDone));
    if (!currentUser) return;
    await saveUserQuarterDoc(currentUser.uid, currentQuarter);
  }
  window.tasksDone = tasksDone;

  tasksFilterSelect.addEventListener('change', () => {
    currentTasksFilter = tasksFilterSelect.value;
    renderTasksForDay(currentTasksDay);
  });

  function renderTasksTabs() {
    tasksDayTabs.innerHTML = '';
    dayKeys.forEach(dayName => {
      const btn = document.createElement('button');
      btn.className = 'day-tab' + (dayName === currentTasksDay ? ' active' : '');
      btn.textContent = dayName;
      btn.addEventListener('click', () => {
        currentTasksDay = dayName;
        renderTasksForDay(currentTasksDay);
      });
      tasksDayTabs.appendChild(btn);
    });
  }

  function shouldShowTask(lessonId) {
    const done = !!tasksDone[lessonId];
    if (currentTasksFilter === 'done') return done;
    if (currentTasksFilter === 'todo') return !done;
    return true;
  }

  function renderTasksForDay(dayName) {
    renderTasksTabs();
    tasksContainer.innerHTML = '';
    const block = document.createElement('div');
    block.className = 'day-block';
    const title = document.createElement('div');
    title.className = 'day-title';
    title.innerHTML = `<span class="day-icon">${dayName}</span>${dayName} –¥–æ–º–∞—à–∫–∞`;
    block.appendChild(title);

    SCHEDULE[dayName].forEach(lesson => {
      if (!shouldShowTask(lesson.id)) return;

      const row = document.createElement('div');
      row.className = 'task-row';
      row.dataset.id = lesson.id;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = !!tasksDone[lesson.id];

      const content = document.createElement('div');
      const line1 = document.createElement('div');
      line1.textContent = `${lesson.subject} ‚Äî –î–ó: ${getRandomHomework(lesson.subject)}`;
      const line2 = document.createElement('div');
      line2.className = 'task-meta';
      line2.textContent = `${lesson.num} —É—Ä–æ–∫ ¬∑ ${lesson.time}${lesson.room ? ' ¬∑ ' + lesson.room : ''}`;

      content.appendChild(line1);
      content.appendChild(line2);

      if (checkbox.checked) row.classList.add('done');

      checkbox.addEventListener('change', async () => {
        tasksDone[lesson.id] = checkbox.checked;
        await saveTasksDone();
        if (checkbox.checked) {
          row.classList.add('done');
          addNotification(`–û—Ç–º–µ—á–µ–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –î–ó –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${lesson.subject}`, 'hw-done');
        } else {
          row.classList.remove('done');
          addNotification(`–°–Ω—è—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${lesson.subject}`, 'hw-undo');
        }
      });

      row.appendChild(checkbox);
      row.appendChild(content);
      block.appendChild(row);
    });

    tasksContainer.appendChild(block);
  }
  window.renderTasksForDay = renderTasksForDay;

  // --- –†–µ–π—Ç–∏–Ω–≥ (—Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) ---
  function loadRatingHistory() {
    const raw = localStorage.getItem('venik-rating-history');
    return raw ? JSON.parse(raw) : [];
  }
  function saveRatingHistory(history) {
    localStorage.setItem('venik-rating-history', JSON.stringify(history));
  }
  window.loadRatingHistory = loadRatingHistory;
  window.saveRatingHistory = saveRatingHistory;

  function saveRatingHistoryEntry() {
    const history = loadRatingHistory();
    const avg = getMyAverage();
    if (!avg) return;
    history.push({
      ts: new Date().toISOString(),
      quarter: currentQuarter,
      week: currentWeek,
      avg
    });
    saveRatingHistory(history);
  }
  window.saveRatingHistoryEntry = saveRatingHistoryEntry;

  function renderRatingHistory() {
    const history = loadRatingHistory();
    if (!history.length) {
      ratingHistoryDiv.textContent = '';
      return;
    }
    const last = history.slice(-5).reverse();
    ratingHistoryDiv.innerHTML = '<div style="margin-top:8px;font-size:12px;color:var(--text-muted);">–¢–≤–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∞–ª–ª–∞:</div>';
    last.forEach(h => {
      const p = document.createElement('div');
      p.style.fontSize = '12px';
      const d = new Date(h.ts);
      p.textContent = `${d.toLocaleString()} ¬∑ ${h.quarter} —á–µ—Ç–≤, ${h.week} –Ω–µ–¥–µ–ª—è: ${h.avg.toFixed(2)}`;
      ratingHistoryDiv.appendChild(p);
    });
  }
  window.renderRatingHistory = renderRatingHistory;

  async function getAllUsersAverages() {
    const result = [];
    try {
      const cg = collectionGroup(db, 'quarters');
      const qSnap = await getDocs(cg);
      qSnap.forEach(docSnap => {
        const data = docSnap.data();
        const avgByWeek = data.avgByWeek || {};
        const avg = Number(avgByWeek[currentWeek] || 0);
        if (!avg || avg <= 0) return;

        const prof = data.profile || {};
        const name = prof.name || '–£—á–µ–Ω–∏–∫';
        const avatarUrl = prof.avatarUrl || 'teacher.jpg';

        const refPath = docSnap.ref.path; // users/{uid}/quarters/qN
        const uid = refPath.split('/')[1] || null;

        result.push({ uid, name, avatarUrl, avg });
      });
    } catch (e) {
      console.error('getAllUsersAverages error', e);
    }
    return result;
  }

  async function buildRatingData() {
    const myAvg = getMyAverage();
    const fromCloud = await getAllUsersAverages();
    const all = [...fromCloud];
    all.sort((a, b) => b.avg - a.avg);
    const rated = all.map((item, index) => ({
      place: index + 1,
      ...item
    }));
    return { rated, myAvg };
  }

  async function renderRating() {
    const { rated } = await buildRatingData();
    ratingTableBody.innerHTML = '';
    rated.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.place}</td>
        <td>
          <div style="display:flex;align-items:center;gap:6px;">
            <div style="width:26px;height:26px;border-radius:999px;overflow:hidden;border:1px solid rgba(148,163,184,0.7);flex-shrink:0;">
              <img src="${row.avatarUrl || 'teacher.jpg'}" alt="" style="width:100%;height:100%;object-fit:cover;">
            </div>
            <span>${row.name}</span>
          </div>
        </td>
        <td>${row.avg.toFixed(2)}</td>
      `;
      tr.addEventListener('click', () => {
        if (row.uid) openProfileForUser(row.uid);
      });
      ratingTableBody.appendChild(tr);
    });
  }
  window.renderRating = renderRating;

  ratingRefreshBtn.addEventListener('click', () => {
    renderRating();
  });

  // --- –ê–¥–º–∏–Ω –≤–∏–∑–∏—Ç—ã ---
  async function logVisit(user) {
    try {
      await addDoc(collection(db, 'visits'), {
        uid: user ? user.uid : null,
        email: user ? user.email : null,
        userAgent: navigator.userAgent,
        language: navigator.language,
        screen: `${window.screen.width}x${window.screen.height}`,
        createdAt: serverTimestamp()
      });
    } catch (e) {
      console.error('logVisit error', e);
    }
  }

  async function loadAdminVisits() {
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) {
      adminWarning.textContent = '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.';
      adminVisitsBody.innerHTML = '';
      return;
    }
    adminWarning.textContent = '';
    const qRef = query(collection(db, 'visits'), orderBy('createdAt', 'desc'), limit(50));
    const snap = await getDocs(qRef);
    adminVisitsBody.innerHTML = '';
    let i = 1;
    snap.forEach(docSnap => {
      const v = docSnap.data();
      const tr = document.createElement('tr');
      const dt = v.createdAt && v.createdAt.toDate ? v.createdAt.toDate() : null;
      tr.innerHTML = `
        <td>${i++}</td>
        <td>${dt ? dt.toLocaleString() : '-'}</td>
        <td>${v.uid || '-'}<br>${v.email || '-'}</td>
        <td style="max-width:220px;word-break:break-all;">${v.userAgent || '-'}</td>
        <td>${v.language || '-'}</td>
        <td>${v.screen || '-'}</td>
        <td><button class="btn secondary" data-id="${docSnap.id}">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;
      tr.querySelector('button').addEventListener('click', async () => {
        await deleteDoc(doc(db, 'visits', docSnap.id));
        loadAdminVisits();
      });
      adminVisitsBody.appendChild(tr);
    });
  }
  window.loadAdminVisits = loadAdminVisits;

  // --- Auth (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –≤—Ö–æ–¥ / –≤—ã—Ö–æ–¥) ---
  function showError(msg) { authError.textContent = msg; }

  signupBtn.addEventListener('click', async () => {
    showError('');
    try {
      await createUserWithEmailAndPassword(auth, emailInput.value, passInput.value);
      addNotification('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç', 'auth-signup');
    } catch (e) {
      console.error(e);
      showError(e.code || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
    }
  });

  loginBtn.addEventListener('click', async () => {
    showError('');
    try {
      await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
      addNotification('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'auth-login');
    } catch (e) {
      console.error(e);
      showError(e.code || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
    }
  });

  logoutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
      addNotification('–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'auth-logout');
    } catch (e) {
      console.error(e);
    }
  });

  // --- onAuthStateChanged + init ---
  loadTheme();
  loadNotifications();

  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;

    if (!user) {
      authPanel.classList.remove('hidden');
      appRoot.classList.add('hidden');
      return;
    }

    authPanel.classList.add('hidden');
    appRoot.classList.remove('hidden');

    await loadProfile();
    applyProfileToUI();
    await loadTasksDone();
    await switchQuarter(1);
    renderSchedule();
    renderTasksForDay(currentTasksDay);
    renderRating();
    renderRatingHistory();
    await logVisit(user);
  });

  window.profile = profile;
  window.currentQuarter = currentQuarter;
  window.currentWeek = currentWeek;
  window.currentTasksDay = currentTasksDay;
</script>
<script type="module">
  import {
    collection,
    doc,
    setDoc,
    addDoc,
    getDoc,
    getDocs,
    query,
    where,
    orderBy,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"; /* [web:579] */

  const auth = getAuth();
  const db = getFirestore();

  // DOM –¥–ª—è —á–∞—Ç–∞
  const chatDialogsList = document.getElementById('chat-dialogs-list');
  const chatMessagesDiv = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const chatCurrentName = document.getElementById('chat-current-name');
  const chatCurrentStatus = document.getElementById('chat-current-status');

  let chatUnsubMessages = null;
  let currentChatId = null;
  let currentChatPartner = null;

  // ========== –í–°–ü–û–ú–û–ì–ê–Æ–©–ò–ï –§–£–ù–ö–¶–ò–ò ==========

  function getCurrentUser() {
    return auth.currentUser || null;
  }

  function normalizeChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
  }

  function formatTimeShort(ts) {
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return hh + ':' + mm;
  }

  function clearMessages() {
    chatMessagesDiv.innerHTML = '';
  }

  function appendMessage(msg, isMine) {
    const bubble = document.createElement('div');
    bubble.className = 'chat-message' + (isMine ? ' me' : '');
    const textDiv = document.createElement('div');
    textDiv.textContent = msg.text;
    const metaDiv = document.createElement('div');
    metaDiv.className = 'chat-message-meta';
    metaDiv.textContent = formatTimeShort(msg.createdAt);
    bubble.appendChild(textDiv);
    bubble.appendChild(metaDiv);
    chatMessagesDiv.appendChild(bubble);
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
  }

  function setChatEnabled(enabled) {
    chatInput.disabled = !enabled;
    chatSendBtn.disabled = !enabled;
  }

  // ========== –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –î–õ–Ø –ß–ê–¢–ê ==========

  async function loadChatUsersList() {
    const me = getCurrentUser();
    chatDialogsList.innerHTML = '';

    if (!me) {
      const p = document.createElement('p');
      p.style.fontSize = '12px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤.';
      chatDialogsList.appendChild(p);
      setChatEnabled(false);
      return;
    }

    // —Ç—è–Ω–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users, –∫—Ä–æ–º–µ —Å–µ–±—è
    const usersSnap = await getDocs(collection(db, 'users'));
    const items = [];
    usersSnap.forEach(uDoc => {
      const data = uDoc.data();
      if (!data.uid || data.uid === me.uid) return;
      items.push({
        uid: data.uid,
        name: data.name || '–£—á–µ–Ω–∏–∫',
        avatarUrl: data.avatarUrl || 'teacher.jpg',
        className: data.className || ''
      });
    });

    if (!items.length) {
      const p = document.createElement('p');
      p.style.fontSize = '12px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ó–∞–π–¥–∏ –ø–æ–¥ –¥—Ä—É–≥–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∞—Ç.';
      chatDialogsList.appendChild(p);
      setChatEnabled(false);
      return;
    }

    items.forEach(user => {
      const item = document.createElement('div');
      item.className = 'chat-dialog-item';
      item.dataset.uid = user.uid;

      const av = document.createElement('div');
      av.className = 'chat-dialog-avatar';
      av.innerHTML = `<img src="${user.avatarUrl}" alt="">`;

      const nameDiv = document.createElement('div');
      nameDiv.className = 'chat-dialog-name';
      nameDiv.textContent = user.name;

      const lastDiv = document.createElement('div');
      lastDiv.className = 'chat-dialog-last';
      lastDiv.textContent = '';

      item.appendChild(av);
      item.appendChild(nameDiv);
      item.appendChild(lastDiv);

      item.addEventListener('click', () => {
        document.querySelectorAll('.chat-dialog-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        openChatWith(user);
      });

      chatDialogsList.appendChild(item);
    });

    setChatEnabled(false);
    chatCurrentName.textContent = '–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–ª–µ–≤–∞';
    chatCurrentStatus.textContent = '';
  }
  window.loadChatUsersList = loadChatUsersList;

  // ========== –û–¢–ö–†–´–¢–ò–ï/–°–û–ó–î–ê–ù–ò–ï –ß–ê–¢–ê ==========

  async function ensureChatDocument(uid1, uid2) {
    const chatId = normalizeChatId(uid1, uid2);
    const ref = doc(db, 'chats', chatId);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        users: [uid1, uid2],
        createdAt: serverTimestamp(),
        lastMessageAt: serverTimestamp()
      });
    }
    return { chatId, ref };
  }

  async function openChatWith(user) {
    const me = getCurrentUser();
    if (!me) return;

    // –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞
    if (chatUnsubMessages) {
      chatUnsubMessages();
      chatUnsubMessages = null;
    }

    const { chatId, ref } = await ensureChatDocument(me.uid, user.uid);
    currentChatId = chatId;
    currentChatPartner = user;

    chatCurrentName.textContent = user.name;
    chatCurrentStatus.textContent = user.className ? `–ö–ª–∞—Å—Å: ${user.className}` : '';
    setChatEnabled(true);
    clearMessages();

    // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    const messagesRef = collection(ref, 'messages');
    const qRef = query(messagesRef, orderBy('createdAt', 'asc'));
    chatUnsubMessages = onSnapshot(qRef, (snapshot) => {
      clearMessages();
      snapshot.forEach(docSnap => {
        const m = docSnap.data();
        appendMessage(m, m.from === me.uid);
      });
    });

    // –ø–æ–¥–∑–∞–≥—Ä—É–∑–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç –≤ —Å–ø–∏—Å–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤ (lastMessage)
    updateLastMessageForDialog(user.uid);
  }
  window.openChatWith = openChatWith;

  async function updateLastMessageForDialog(partnerUid) {
    try {
      const me = getCurrentUser();
      if (!me) return;
      const chatId = normalizeChatId(me.uid, partnerUid);
      const ref = doc(db, 'chats', chatId);
      const messagesRef = collection(ref, 'messages');
      const qRef = query(messagesRef, orderBy('createdAt', 'desc'));
      const snap = await getDocs(qRef);
      let lastText = '';
      if (!snap.empty) {
        const m = snap.docs[0].data();
        lastText = (m.text || '').slice(0, 24);
      }

      const item = chatDialogsList.querySelector(`.chat-dialog-item[data-uid="${partnerUid}"]`);
      if (item) {
        const lastDiv = item.querySelector('.chat-dialog-last');
        if (lastDiv) lastDiv.textContent = lastText;
      }
    } catch (e) {
      console.error('updateLastMessageForDialog error', e);
    }
  }

  // ========== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ==========

  async function sendMessage() {
    const me = getCurrentUser();
    if (!me || !currentChatId || !currentChatPartner) return;
    const text = chatInput.value.trim();
    if (!text) return;

    try {
      const chatRef = doc(db, 'chats', currentChatId);
      const messagesRef = collection(chatRef, 'messages');
      await addDoc(messagesRef, {
        from: me.uid,
        to: currentChatPartner.uid,
        text,
        createdAt: serverTimestamp()
      });
      await setDoc(chatRef, {
        lastMessageAt: serverTimestamp()
      }, { merge: true });

      chatInput.value = '';
      updateLastMessageForDialog(currentChatPartner.uid);
    } catch (e) {
      console.error('sendMessage error', e);
    }
  }

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ========== –ê–í–¢–û-–û–¢–ö–†–´–¢–ò–ï –ß–ê–¢–ê –ò–ó –ü–†–û–§–ò–õ–Ø ==========

  window.openChatForUid = async function (uid) {
    const me = getCurrentUser();
    if (!me || me.uid === uid) return;

    const uRef = doc(db, 'users', uid);
    const snap = await getDoc(uRef);
    if (!snap.exists()) {
      alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.');
      return;
    }
    const data = snap.data();
    const user = {
      uid: data.uid || uid,
      name: data.name || '–£—á–µ–Ω–∏–∫',
      avatarUrl: data.avatarUrl || 'teacher.jpg',
      className: data.className || ''
    };

    await loadChatUsersList();
    const item = chatDialogsList.querySelector(`.chat-dialog-item[data-uid="${user.uid}"]`);
    if (item) {
      document.querySelectorAll('.chat-dialog-item').forEach(el => el.classList.remove('active'));
      item.classList.add('active');
    }
    await openChatWith(user);
  };

  // ========== –†–ï–ê–ö–¶–ò–Ø –ù–ê –í–•–û–î/–í–´–•–û–î –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"; /* [web:522] */

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–ª–∏—Å—å
      if (chatUnsubMessages) {
        chatUnsubMessages();
        chatUnsubMessages = null;
      }
      currentChatId = null;
      currentChatPartner = null;
      chatDialogsList.innerHTML = '';
      clearMessages();
      setChatEnabled(false);
      chatCurrentName.textContent = '–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–ª–µ–≤–∞';
      chatCurrentStatus.textContent = '';
      return;
    }

    // –≤–æ—à–ª–∏ ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —á–∞—Ç–∞
    await loadChatUsersList();
  });
</script>

<body>

  <!-- –ü–ê–ù–ï–õ–¨ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
  <div id="auth-panel">
    <h2 style="margin:0 0 6px;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="auth-email" type="email" placeholder="Email">
    <input id="auth-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="auth-login-btn">–í–æ–π—Ç–∏</button>
    <button id="auth-signup-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button id="auth-logout-btn">–í—ã–π—Ç–∏</button>
    <div id="auth-error"></div>
  </div>

  <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
  <div id="app-root" class="hidden">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img id="sidebar-avatar-img" src="teacher.jpg" alt="">
        <div>
          <div id="sidebar-name">–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</div>
          <div id="sidebar-class">8–ë –∫–ª–∞—Å—Å</div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-item active" data-page="journal">–î–Ω–µ–≤–Ω–∏–∫</div>
        <div class="sidebar-item" data-page="schedule">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="sidebar-item" data-page="tasks">–î–æ–º–∞—à–∫–∞</div>
        <div class="sidebar-item" data-page="rating">–†–µ–π—Ç–∏–Ω–≥</div>
        <div class="sidebar-item" data-page="chat">–ß–∞—Ç</div>
        <div class="sidebar-item" data-page="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="sidebar-item" id="sidebar-notif-item" data-page="notifications">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div class="sidebar-item" data-page="admin">–ê–¥–º–∏–Ω</div>
      </nav>
    </aside>

    <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
      <header class="topbar">
        <div class="topbar-left">
          <div id="topbar-title">–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</div>
        </div>
        <div class="topbar-right">
          <button id="theme-toggle" class="btn secondary">
            <span id="theme-toggle-icon">üåô</span>
            <span id="theme-toggle-text">–¢—ë–º–Ω–∞—è</span>
          </button>
          <div class="notif-bell" data-page="notifications">
            üîî
            <span id="bell-badge" class="hidden">0</span>
          </div>
          <div class="topbar-user" data-page="profile">
            <img id="avatar-small-img" src="teacher.jpg" alt="">
            <span id="topbar-name">–ü—Ä–æ—Ñ–∏–ª—å ‚ñæ</span>
          </div>
        </div>
      </header>

      <!-- –°–¢–†–ê–ù–ò–¶–´ -->
      <main id="page-journal">
        <section class="controls">
          <div>
            –ß–µ—Ç–≤–µ—Ä—Ç—å:
            <button class="quarter-btn active" data-quarter="1">1</button>
            <button class="quarter-btn" data-quarter="2">2</button>
            <button class="quarter-btn" data-quarter="3">3</button>
            <button class="quarter-btn" data-quarter="4">4</button>
            <span id="current-quarter-label">1 —á–µ—Ç–≤–µ—Ä—Ç—å</span>
          </div>
          <div>
            –ù–µ–¥–µ–ª—è:
            <button class="week-btn active" data-week="1">1</button>
            <button class="week-btn" data-week="2">2</button>
            <button class="week-btn" data-week="3">3</button>
            <button class="week-btn" data-week="4">4</button>
            <span id="current-week-label">1 –Ω–µ–¥–µ–ª—è</span>
          </div>
        </section>

        <section class="add-grade">
          <select id="subject-input">
            <option>–ê–ª–≥–µ–±—Ä–∞</option>
            <option>–ì–µ–æ–º–µ—Ç—Ä–∏—è</option>
            <option>–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
            <option>–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫</option>
            <option>–§–∏–∑–∏–∫–∞</option>
            <option>–•–∏–º–∏—è</option>
            <option>–ë–∏–æ–ª–æ–≥–∏—è</option>
            <option>–ò—Å—Ç–æ—Ä–∏—è</option>
            <option>–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</option>
            <option>–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
            <option>–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç</option>
            <option>–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ</option>
            <option>–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞</option>
            <option>–¢—Ä—É–¥ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è)</option>
            <option>–ú—É–∑—ã–∫–∞</option>
          </select>
          <input id="type-input" type="text" placeholder="–¢–∏–ø —Ä–∞–±–æ—Ç—ã (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è, –î–ó...)">
          <select id="day-select">
            <option value="mon">–ü–Ω</option>
            <option value="tue">–í—Ç</option>
            <option value="wed">–°—Ä</option>
            <option value="thu">–ß—Ç</option>
            <option value="fri">–ü—Ç</option>
            <option value="sat">–°–±</option>
            <option value="sun">–í—Å</option>
          </select>
          <input id="mark-input" type="number" min="1" max="5" placeholder="–û—Ü–µ–Ω–∫–∞">
          <button id="add-grade-btn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </section>

        <section class="week-grid">
          <div id="mon-block" class="day-block"><h3>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</h3></div>
          <div id="tue-block" class="day-block"><h3>–í—Ç–æ—Ä–Ω–∏–∫</h3></div>
          <div id="wed-block" class="day-block"><h3>–°—Ä–µ–¥–∞</h3></div>
          <div id="thu-block" class="day-block"><h3>–ß–µ—Ç–≤–µ—Ä–≥</h3></div>
          <div id="fri-block" class="day-block"><h3>–ü—è—Ç–Ω–∏—Ü–∞</h3></div>
          <div id="sat-block" class="day-block"><h3>–°—É–±–±–æ—Ç–∞</h3></div>
          <div id="sun-block" class="day-block"><h3>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</h3></div>
        </section>

        <section class="subjects-summary">
          <h3 style="margin:6px 0 4px;font-size:14px;">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h3>
          <table>
            <thead>
              <tr>
                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                <th>–û—Ü–µ–Ω–∫–∏</th>
                <th>–°—Ä–µ–¥–Ω–∏–π</th>
              </tr>
            </thead>
            <tbody id="subjects-table-body"></tbody>
          </table>
          <div id="subject-list"></div>
        </section>
      </main>

      <main id="page-schedule" class="hidden">
        <h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
        <div id="schedule-day-tabs" class="tabs-row"></div>
        <div id="schedule-container"></div>
      </main>

      <main id="page-tasks" class="hidden">
        <h2>–î–æ–º–∞—à–∫–∞</h2>
        <div class="tasks-controls">
          <label>–ü–æ–∫–∞–∑–∞—Ç—å:
            <select id="tasks-filter-select">
              <option value="all">–í—Å–µ</option>
              <option value="todo">–¢–æ–ª—å–∫–æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
              <option value="done">–¢–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
            </select>
          </label>
        </div>
        <div id="tasks-day-tabs" class="tabs-row"></div>
        <div id="tasks-container"></div>
      </main>

      <main id="page-rating" class="hidden">
        <h2>–†–µ–π—Ç–∏–Ω–≥ –∫–ª–∞—Å—Å–∞</h2>
        <button id="rating-refresh-btn" class="btn secondary">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <table>
          <thead>
          <tr>
            <th>–ú–µ—Å—Ç–æ</th>
            <th>–£—á–µ–Ω–∏–∫</th>
            <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
          </tr>
          </thead>
          <tbody id="rating-table-body"></tbody>
        </table>
        <div id="rating-history" style="margin-top:6px;font-size:12px;color:var(--text-muted);"></div>
      </main>

      <main id="page-chat" class="hidden">
        <section class="chat-layout">
          <div class="chat-sidebar">
            <h3>–ß–∞—Ç—ã</h3>
            <div id="chat-dialogs-list"></div>
          </div>
          <div class="chat-main">
            <div class="chat-header">
              <div>
                <div id="chat-current-name">–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–ª–µ–≤–∞</div>
                <div id="chat-current-status" class="chat-status"></div>
              </div>
            </div>
            <div id="chat-messages"></div>
            <div class="chat-input-row">
              <input id="chat-input" type="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
              <button id="chat-send-btn" class="btn primary" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        </section>
      </main>

      <main id="page-profile" class="hidden">
        <section class="profile-header">
          <img id="profile-avatar-img" src="teacher.jpg" alt="">
          <div>
            <h2 id="profile-name-display">–í–µ–Ω–∏–∫ –í–µ–Ω–∏–∫–æ–≤</h2>
            <p id="profile-class-display">–£—á–µ–Ω–∏–∫ 8–ë –∫–ª–∞—Å—Å–∞</p>
          </div>
          <button id="profile-message-btn" class="btn primary" style="margin-left:auto;display:none;">–ù–∞–ø–∏—Å–∞—Ç—å</button>
        </section>

        <section class="profile-info">
          <div><strong>–ò–º—è:</strong> <span id="profile-name-info"></span></div>
          <div><strong>Email:</strong> <span id="profile-email-info"></span></div>
          <div><strong>–ì–æ—Ä–æ–¥:</strong> <span id="profile-city-info"></span></div>
          <div><strong>–ö–ª–∞—Å—Å:</strong> <span id="profile-class-info"></span></div>
          <div><strong>–õ—é–±–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:</strong> <span id="profile-fav-info"></span></div>
        </section>

        <section class="profile-form">
          <h3 style="margin:0 0 4px;font-size:14px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä:
            <input id="profile-avatar-input" type="text">
          </label>
          <label>–ò–º—è:
            <input id="profile-name-input" type="text">
          </label>
          <label>–ì–æ—Ä–æ–¥:
            <input id="profile-city-input" type="text">
          </label>
          <label>–ö–ª–∞—Å—Å:
            <input id="profile-class-input" type="text">
          </label>
          <label>–õ—é–±–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:
            <input id="profile-fav-input" type="text">
          </label>
          <button id="profile-save-btn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </section>
      </main>

      <main id="page-notifications" class="hidden">
        <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        <div class="notif-controls">
          <button id="notif-mark-read" class="btn secondary">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</button>
          <button id="notif-clear" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="notifications-list"></div>
      </main>

      <main id="page-admin" class="hidden">
        <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <div id="admin-warning" style="color:#f97316;font-size:13px;"></div>
        <table>
          <thead>
          <tr>
            <th>#</th>
            <th>–ö–æ–≥–¥–∞</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>User‚ÄëAgent</th>
            <th>–Ø–∑—ã–∫</th>
            <th>–≠–∫—Ä–∞–Ω</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
          </thead>
          <tbody id="admin-visits-body"></tbody>
        </table>
      </main>
    </div>
  </div>
