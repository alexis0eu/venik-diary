<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg-main: #020617;
      --bg-elevated: #020617;
      --bg-soft: #020617;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --border-strong: rgba(148, 163, 184, 0.55);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --accent-strong: #0ea5e9;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.1);
      --success: #4ade80;
      --success-soft: rgba(74, 222, 128, 0.12);
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 10px;
      --radius-pill: 999px;
      --blur-bg: blur(16px);
    }

    [data-theme="light"] {
      --bg-main: #e5f3ff;
      --bg-elevated: rgba(255, 255, 255, 0.92);
      --bg-soft: rgba(255, 255, 255, 0.82);
      --border-subtle: rgba(148, 163, 184, 0.45);
      --border-strong: rgba(30, 64, 175, 0.6);
      --accent: #0f766e;
      --accent-soft: rgba(15, 118, 110, 0.08);
      --accent-strong: #0d9488;
      --text-main: #020617;
      --text-muted: #4b5563;
      --text-soft: #6b7280;
      --danger: #dc2626;
      --danger-soft: rgba(220, 38, 38, 0.08);
      --success: #16a34a;
      --success-soft: rgba(22, 163, 74, 0.08);
      --shadow-soft: 0 18px 50px rgba(15, 23, 42, 0.15);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0f172a 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .hidden { display: none !important; }

    /* AUTH */

    #auth-panel {
      max-width: 380px;
      width: 100%;
      margin: 40px auto;
      padding: 24px 22px 22px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #auth-panel input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 14px;
      outline: none;
    }

    #auth-panel input:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    #auth-panel button {
      padding: 9px 12px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    #auth-login-btn {
      background: linear-gradient(to right, #0f766e, #0ea5e9);
      color: white;
    }

    #auth-signup-btn {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    #auth-logout-btn {
      background: transparent;
      color: var(--text-soft);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      margin-top: 4px;
    }

    #auth-error {
      font-size: 12px;
      color: var(--danger);
      min-height: 16px;
    }

    /* LAYOUT */

    #app-root {
      display: flex;
      width: 100%;
      max-width: 1300px;
      margin: 24px auto;
      padding: 16px 14px;
      gap: 14px;
    }

    .sidebar {
      width: 250px;
      flex-shrink: 0;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      box-shadow: 0 20px 55px rgba(15, 23, 42, 0.95);
      padding: 14px 13px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: sticky;
      top: 16px;
      height: fit-content;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 7px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), transparent 55%), rgba(15, 23, 42, 0.95);
    }

    .sidebar-header img {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      object-fit: cover;
      border: 1.2px solid rgba(56, 189, 248, 0.6);
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9);
    }

    #sidebar-name {
      font-weight: 600;
      font-size: 15px;
      letter-spacing: 0.01em;
    }

    #sidebar-class {
      font-size: 12px;
      color: var(--text-muted);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      padding: 7px 9px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.16s ease-out;
      border: 1px solid transparent;
    }

    .sidebar-item:hover {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
      color: var(--text-main);
    }

    .sidebar-item.active {
      background: rgba(15, 23, 42, 0.95);
      color: #f9fafb;
      border-color: rgba(56, 189, 248, 0.8);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.15);
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      margin-bottom: 10px;
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%), rgba(15, 23, 42, 0.96);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(16px);
    }

    .topbar-left { display: flex; flex-direction: column; gap: 2px; }
    #topbar-title { font-size: 15px; font-weight: 600; letter-spacing: 0.02em; }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notif-bell {
      position: relative;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.18), transparent 60%), rgba(15, 23, 42, 0.96);
    }

    #bell-badge {
      position: absolute;
      top: -3px;
      right: -3px;
      min-width: 17px;
      height: 17px;
      padding: 0 4px;
      border-radius: 999px;
      background: #f97316;
      color: white;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .topbar-user {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px 4px 4px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: rgba(15, 23, 42, 0.96);
      cursor: pointer;
      transition: all 0.16s ease-out;
    }

    .topbar-user:hover {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.15);
    }

    #avatar-small-img {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      object-fit: cover;
      flex-shrink: 0;
    }

    #topbar-name { font-size: 13px; color: var(--text-main); }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      padding: 7px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .btn.primary {
      background: linear-gradient(to right, #0f766e, #0ea5e9);
      color: white;
      border: 1px solid rgba(15, 23, 42, 0.9);
    }

    .btn.secondary {
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .btn.secondary:hover { border-color: rgba(56, 189, 248, 0.8); }

    main {
      flex: 1;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.11), transparent 60%), rgba(15, 23, 42, 0.97);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.96);
      padding: 14px 14px 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    h2 { margin: 0 0 8px; font-size: 18px; }

    /* –¥–∞–ª—å—à–µ —Ç—É—Ç –±—É–¥—É—Ç —Å—Ç–∏–ª–∏ JOURNAL/SCHEDULE/TASKS/CHAT/PROFILE/NOTIFS/ADMIN,
       –∫–æ—Ç–æ—Ä—ã–µ —è —É–∂–µ —Ç–µ–±–µ —Å–∫–∏–Ω—É–ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —á–∞—Å—Ç—è—Ö ‚Äî –∏—Ö –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ—à—å —Ç–∞–∫–∏–º–∏ –∂–µ */

    @media (max-width: 960px) {
      #app-root {
        flex-direction: column;
        padding: 10px;
      }
      .sidebar {
        position: static;
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 10px;
        overflow-x: auto;
      }
      .sidebar-header { flex-shrink: 0; }
      .sidebar-nav {
        flex-direction: row;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .chat-layout { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      main { padding: 10px; }
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .add-grade { flex-direction: column; }
    }
  </style>
</head>
<body>

  <!-- AUTH -->
  <div id="auth-panel">
    <h2 style="margin:0 0 6px;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <input id="auth-email" type="email" placeholder="Email">
    <input id="auth-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="auth-login-btn">–í–æ–π—Ç–∏</button>
    <button id="auth-signup-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button id="auth-logout-btn">–í—ã–π—Ç–∏</button>
    <div id="auth-error"></div>
  </div>

  <!-- APP WRAPPER -->
  <div id="app-root" class="hidden">
     <!-- APP WRAPPER -->
  <div id="app-root" class="hidden">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img id="sidebar-avatar-img" src="teacher.jpg" alt="">
        <div>
          <div id="sidebar-name">–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</div>
          <div id="sidebar-class">8–ë –∫–ª–∞—Å—Å</div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-item active" data-page="journal">–î–Ω–µ–≤–Ω–∏–∫</div>
        <div class="sidebar-item" data-page="schedule">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="sidebar-item" data-page="tasks">–î–æ–º–∞—à–∫–∞</div>
        <div class="sidebar-item" data-page="rating">–†–µ–π—Ç–∏–Ω–≥</div>
        <div class="sidebar-item" data-page="chat">–ß–∞—Ç</div>
        <div class="sidebar-item" data-page="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="sidebar-item" id="sidebar-notif-item" data-page="notifications">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div class="sidebar-item" data-page="admin">–ê–¥–º–∏–Ω</div>
      </nav>
    </aside>

    <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
      <header class="topbar">
        <div class="topbar-left">
          <div id="topbar-title">–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞</div>
        </div>
        <div class="topbar-right">
          <button id="theme-toggle" class="btn secondary">
            <span id="theme-toggle-icon">üåô</span>
            <span id="theme-toggle-text">–¢—ë–º–Ω–∞—è</span>
          </button>
          <div class="notif-bell" data-page="notifications">
            üîî
            <span id="bell-badge" class="hidden">0</span>
          </div>
          <div class="topbar-user" data-page="profile">
            <img id="avatar-small-img" src="teacher.jpg" alt="">
            <span id="topbar-name">–ü—Ä–æ—Ñ–∏–ª—å ‚ñæ</span>
          </div>
        </div>
      </header>

      <!-- –ñ–£–†–ù–ê–õ -->
      <main id="page-journal">
        <h2>–î–Ω–µ–≤–Ω–∏–∫</h2>

        <section class="controls">
          <div>
            –ß–µ—Ç–≤–µ—Ä—Ç—å:
            <button class="quarter-btn active" data-quarter="1">1</button>
            <button class="quarter-btn" data-quarter="2">2</button>
            <button class="quarter-btn" data-quarter="3">3</button>
            <button class="quarter-btn" data-quarter="4">4</button>
            <span id="current-quarter-label" style="margin-left:6px;color:var(--text-soft);">1 —á–µ—Ç–≤–µ—Ä—Ç—å</span>
          </div>
          <div>
            –ù–µ–¥–µ–ª—è:
            <button class="week-btn active" data-week="1">1</button>
            <button class="week-btn" data-week="2">2</button>
            <button class="week-btn" data-week="3">3</button>
            <button class="week-btn" data-week="4">4</button>
            <span id="current-week-label" style="margin-left:6px;color:var(--text-soft);">1 –Ω–µ–¥–µ–ª—è</span>
          </div>
        </section>

        <section class="add-grade">
          <select id="subject-input">
            <option>–ê–ª–≥–µ–±—Ä–∞</option>
            <option>–ì–µ–æ–º–µ—Ç—Ä–∏—è</option>
            <option>–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</option>
            <option>–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫</option>
            <option>–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
            <option>–§–∏–∑–∏–∫–∞</option>
            <option>–•–∏–º–∏—è</option>
            <option>–ë–∏–æ–ª–æ–≥–∏—è</option>
            <option>–ò—Å—Ç–æ—Ä–∏—è</option>
            <option>–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ</option>
            <option>–ì–µ–æ–≥—Ä–∞—Ñ–∏—è</option>
            <option>–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞</option>
            <option>–î—Ä—É–≥–æ–π –ø—Ä–µ–¥–º–µ—Ç</option>
          </select>
          <input id="type-input" type="text" placeholder="–¢–∏–ø —Ä–∞–±–æ—Ç—ã (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è, –î–ó...)">
          <select id="day-select">
            <option value="mon">–ü–Ω</option>
            <option value="tue">–í—Ç</option>
            <option value="wed">–°—Ä</option>
            <option value="thu">–ß—Ç</option>
            <option value="fri">–ü—Ç</option>
            <option value="sat">–°–±</option>
            <option value="sun">–í—Å</option>
          </select>
          <input id="mark-input" type="number" min="1" max="5" placeholder="–û—Ü–µ–Ω–∫–∞">
          <button id="add-grade-btn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </section>

        <section class="week-grid">
          <div class="day-block" id="mon-block">
            <h3>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</h3>
          </div>
          <div class="day-block" id="tue-block">
            <h3>–í—Ç–æ—Ä–Ω–∏–∫</h3>
          </div>
          <div class="day-block" id="wed-block">
            <h3>–°—Ä–µ–¥–∞</h3>
          </div>
          <div class="day-block" id="thu-block">
            <h3>–ß–µ—Ç–≤–µ—Ä–≥</h3>
          </div>
          <div class="day-block" id="fri-block">
            <h3>–ü—è—Ç–Ω–∏—Ü–∞</h3>
          </div>
          <div class="day-block" id="sat-block">
            <h3>–°—É–±–±–æ—Ç–∞</h3>
          </div>
          <div class="day-block" id="sun-block">
            <h3>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</h3>
          </div>
        </section>

        <section class="subjects-summary">
          <h3 style="margin:8px 0 4px;font-size:14px;">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h3>
          <table>
            <thead>
            <tr>
              <th>–ü—Ä–µ–¥–º–µ—Ç</th>
              <th>–û—Ü–µ–Ω–∫–∏</th>
              <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
            </tr>
            </thead>
            <tbody id="subjects-table-body"></tbody>
          </table>
          <div id="subject-list"></div>
        </section>
      </main>
      <!-- –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
      <main id="page-schedule" class="hidden">
        <h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2>
        <section class="schedule-header">
          <p style="margin:0 0 6px;font-size:13px;color:var(--text-muted);">
            –ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç–≤–æ–µ–≥–æ –∫–ª–∞—Å—Å–∞. –ú–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫–∞–∫–∏–µ —É—Ä–æ–∫–∏ –∏ –≤ –∫–∞–∫–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.
          </p>
          <div id="schedule-day-tabs" class="day-tabs"></div>
        </section>
        <section id="schedule-container"></section>
      </main>

      <!-- –î–ó -->
      <main id="page-tasks" class="hidden">
        <h2>–î–æ–º–∞—à–∫–∞</h2>
        <section class="tasks-header">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <div id="tasks-day-tabs" class="day-tabs"></div>
            <div>
              –§–∏–ª—å—Ç—Ä:
              <select id="tasks-filter-select">
                <option value="all">–í—Å–µ</option>
                <option value="todo">–¢–æ–ª—å–∫–æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
                <option value="done">–¢–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
              </select>
            </div>
          </div>
          <p style="margin:6px 0 0;font-size:12px;color:var(--text-soft);">
            –û—Ç–º–µ—á–∞–π –≥–∞–ª–æ—á–∫–æ–π, —á—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–ª ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ –∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.
          </p>
        </section>
        <section id="tasks-container"></section>
      </main>

      <!-- –†–ï–ô–¢–ò–ù–ì -->
      <main id="page-rating" class="hidden">
        <h2>–†–µ–π—Ç–∏–Ω–≥</h2>
        <section>
          <p style="margin:0 0 6px;font-size:13px;color:var(--text-muted);">
            –ó–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–≤–æ–π —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ —Ç–µ–∫—É—â–µ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ –∏ –Ω–µ–¥–µ–ª–µ. –ü–æ—Ç–æ–º —Å—é–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–æ–≤.
          </p>
          <button id="rating-refresh-btn" class="btn secondary" style="margin-bottom:6px;">–û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥</button>
          <table>
            <thead>
            <tr>
              <th>#</th>
              <th>–£—á–µ–Ω–∏–∫</th>
              <th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th>
            </tr>
            </thead>
            <tbody id="rating-table-body"></tbody>
          </table>
          <div id="rating-history" style="margin-top:6px;font-size:12px;color:var(--text-soft);"></div>
        </section>
      </main>
      <!-- –ß–ê–¢ -->
      <main id="page-chat" class="hidden">
        <h2>–ß–∞—Ç</h2>
        <section class="chat-layout">
          <aside class="chat-sidebar">
            <div class="chat-sidebar-header">
              <div class="chat-sidebar-title">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫–∏</div>
            </div>
            <div id="chat-dialogs-list" class="chat-dialogs-list"></div>
          </aside>
          <section class="chat-main">
            <header class="chat-header">
              <div>
                <div id="chat-current-name">–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–ª–µ–≤–∞</div>
                <div id="chat-current-status"></div>
              </div>
            </header>
            <div id="chat-messages" class="chat-messages"></div>
            <footer class="chat-input-area">
              <textarea id="chat-input" rows="1" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled></textarea>
              <button id="chat-send-btn" class="btn primary" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </footer>
          </section>
        </section>
      </main>

      <!-- –ü–†–û–§–ò–õ–¨ -->
      <main id="page-profile" class="hidden">
        <section class="profile-header">
          <img id="profile-avatar-img" src="teacher.jpg" alt="">
          <div>
            <h2 id="profile-name-display">–í–µ–Ω–∏–∫ –í–µ–Ω–∏–∫–æ–≤</h2>
            <p id="profile-class-display">–£—á–µ–Ω–∏–∫ 8–ë –∫–ª–∞—Å—Å–∞</p>
          </div>
          <button id="profile-message-btn" class="btn primary" style="margin-left:auto;display:none;">–ù–∞–ø–∏—Å–∞—Ç—å</button>
        </section>

        <section class="profile-info">
          <div><strong>–ò–º—è:</strong> <span id="profile-name-info"></span></div>
          <div><strong>Email:</strong> <span id="profile-email-info"></span></div>
          <div><strong>–ì–æ—Ä–æ–¥:</strong> <span id="profile-city-info"></span></div>
          <div><strong>–ö–ª–∞—Å—Å:</strong> <span id="profile-class-info"></span></div>
          <div><strong>–õ—é–±–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:</strong> <span id="profile-fav-info"></span></div>
        </section>

        <section class="profile-form">
          <h3 style="margin:0 0 4px;font-size:14px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h3>
          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è GIF):
            <input id="profile-avatar-input" type="text">
          </label>
          <label>–ò–º—è:
            <input id="profile-name-input" type="text">
          </label>
          <label>–ì–æ—Ä–æ–¥:
            <input id="profile-city-input" type="text">
          </label>
          <label>–ö–ª–∞—Å—Å:
            <input id="profile-class-input" type="text">
          </label>
          <label>–õ—é–±–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:
            <input id="profile-fav-input" type="text">
          </label>
          <button id="profile-save-btn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </section>
      </main>

      <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
      <main id="page-notifications" class="hidden">
        <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        <section class="notif-header">
          <p style="margin:0 0 6px;font-size:13px;color:var(--text-muted);">
            –ó–¥–µ—Å—å —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: –Ω–æ–≤—ã–µ –æ—Ü–µ–Ω–∫–∏, –ø—Ä–∞–≤–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏ —Ç.–ø.
          </p>
          <div>
            <button id="notif-mark-read" class="btn secondary" style="margin-right:6px;">–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏</button>
            <button id="notif-clear" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </section>
        <section id="notifications-list" class="notifications-list"></section>
      </main>

      <!-- –ê–î–ú–ò–ù -->
      <main id="page-admin" class="hidden">
        <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

        <div id="admin-stats" style="margin:6px 0 10px; font-size:13px; display:flex; flex-direction:column; gap:4px;">
          <div><strong>–°–µ–≥–æ–¥–Ω—è:</strong> <span id="admin-stats-today"></span></div>
          <div><strong>–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å:</strong> <span id="admin-stats-online"></span></div>
          <div><strong>–ü–µ—Ä–∏–æ–¥:</strong> <span id="admin-stats-week"></span></div>
          <div><strong>–¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö:</strong> <span id="admin-stats-top-users"></span></div>
          <div><strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —è–∑—ã–∫–∏:</strong> <span id="admin-stats-devices"></span></div>
          <div id="admin-stats-alerts" style="margin-top:4px; color:#f97316;"></div>
        </div>

        <div id="admin-filters" style="margin:6px 0 8px; font-size:12px; display:flex; flex-wrap:wrap; gap:6px;">
          <div>
            –ü–µ—Ä–∏–æ–¥:
            <select id="admin-period-select">
              <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="yesterday">–í—á–µ—Ä–∞</option>
              <option value="7d" selected>7 –¥–Ω–µ–π</option>
              <option value="30d">30 –¥–Ω–µ–π</option>
            </select>
          </div>
          <div>
            –ö–ª–∞—Å—Å:
            <input id="admin-class-filter" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 8–ë" style="width:70px;">
          </div>
          <div>
            Email:
            <input id="admin-email-filter" type="text" placeholder="—á–∞—Å—Ç—å email" style="width:120px;">
          </div>
          <button id="admin-apply-filters" class="btn secondary" style="padding:4px 10px;font-size:12px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        <div id="admin-warning" style="color:#f97316;font-size:13px;"></div>

        <table>
          <thead>
          <tr>
            <th>#</th>
            <th>–ö–æ–≥–¥–∞</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
            <th>–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
            <th>–Ø–∑—ã–∫</th>
            <th>–≠–∫—Ä–∞–Ω</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
          </thead>
          <tbody id="admin-visits-body"></tbody>
        </table>
      </main>
    </div> <!-- /right column -->
  </div> <!-- /app-root -->

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAFcX2I6lfzmxwEGEpOej-SqiG6-DFWSDc",
    authDomain: "venik-fa40b.firebaseapp.com",
    projectId: "venik-fa40b",
    storageBucket: "venik-fa40b.firebasestorage.app",
    messagingSenderId: "1049573809722",
    appId: "1:1049573809722:web:492952ba95624b8ac01f03",
    measurementId: "G-GMM29TBZ2K"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ADMIN_EMAIL = 'alex.bibikov082011@yandex.ru';

  // --- DOM ---
  const authPanel = document.getElementById('auth-panel');
  const appRoot = document.getElementById('app-root');
  const emailInput = document.getElementById('auth-email');
  const passInput = document.getElementById('auth-password');
  const loginBtn = document.getElementById('auth-login-btn');
  const signupBtn = document.getElementById('auth-signup-btn');
  const logoutBtn = document.getElementById('auth-logout-btn');
  const authError = document.getElementById('auth-error');

  const themeToggleBtn = document.getElementById('theme-toggle');
  const themeToggleIcon = document.getElementById('theme-toggle-icon');
  const themeToggleText = document.getElementById('theme-toggle-text');

  const avatarSmallImg = document.getElementById('avatar-small-img');
  const sidebarAvatarImg = document.getElementById('sidebar-avatar-img');
  const topbarTitle = document.getElementById('topbar-title');
  const topbarName = document.getElementById('topbar-name');
  const sidebarName = document.getElementById('sidebar-name');
  const sidebarClass = document.getElementById('sidebar-class');

  const profileAvatarImg = document.getElementById('profile-avatar-img');
  const profileNameDisplay = document.getElementById('profile-name-display');
  const profileClassDisplay = document.getElementById('profile-class-display');
  const profileNameInfo = document.getElementById('profile-name-info');
  const profileEmailInfo = document.getElementById('profile-email-info');
  const profileCityInfo = document.getElementById('profile-city-info');
  const profileClassInfo = document.getElementById('profile-class-info');
  const profileFavInfo = document.getElementById('profile-fav-info');

  const avatarInput = document.getElementById('profile-avatar-input');
  const nameInput = document.getElementById('profile-name-input');
  const cityInput = document.getElementById('profile-city-input');
  const classInput = document.getElementById('profile-class-input');
  const favInput = document.getElementById('profile-fav-input');
  const profileSaveBtn = document.getElementById('profile-save-btn');
  const profileMessageBtn = document.getElementById('profile-message-btn');

  const bellBadge = document.getElementById('bell-badge');
  const notifList = document.getElementById('notifications-list');
  const notifMarkReadBtn = document.getElementById('notif-mark-read');
  const notifClearBtn = document.getElementById('notif-clear');
  const sidebarNotifItem = document.getElementById('sidebar-notif-item');

  const pageSections = document.querySelectorAll('[id^="page-"]');
  const sidebarItems = document.querySelectorAll('.sidebar-item');

  const subjectsTableBody = document.getElementById('subjects-table-body');
  const subjectListDiv = document.getElementById('subject-list');

  const ratingTableBody = document.getElementById('rating-table-body');
  const ratingRefreshBtn = document.getElementById('rating-refresh-btn');
  const ratingHistoryDiv = document.getElementById('rating-history');

  const subjectSelect = document.getElementById('subject-input');
  const typeInput = document.getElementById('type-input');
  const daySelect = document.getElementById('day-select');
  const markInput = document.getElementById('mark-input');
  const addBtn = document.getElementById('add-grade-btn');

  const scheduleDayTabs = document.getElementById('schedule-day-tabs');
  const scheduleContainer = document.getElementById('schedule-container');

  const tasksDayTabs = document.getElementById('tasks-day-tabs');
  const tasksContainer = document.getElementById('tasks-container');
  const tasksFilterSelect = document.getElementById('tasks-filter-select');

  // admin DOM
  const adminVisitsBody = document.getElementById('admin-visits-body');
  const adminWarning = document.getElementById('admin-warning');
  const adminStatsTodayDiv = document.getElementById('admin-stats-today');
  const adminStatsOnlineDiv = document.getElementById('admin-stats-online');
  const adminStatsWeekDiv = document.getElementById('admin-stats-week');
  const adminStatsTopUsersDiv = document.getElementById('admin-stats-top-users');
  const adminStatsDevicesDiv = document.getElementById('admin-stats-devices');
  const adminStatsAlertsDiv = document.getElementById('admin-stats-alerts');
  const adminPeriodSelect = document.getElementById('admin-period-select');
  const adminClassFilterInput = document.getElementById('admin-class-filter');
  const adminEmailFilterInput = document.getElementById('admin-email-filter');
  const adminApplyFiltersBtn = document.getElementById('admin-apply-filters');

  // --- Theme ---
  const THEME_KEY = 'venik-theme';
  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    if (theme === 'light') {
      themeToggleIcon.textContent = '‚òÄÔ∏è';
      themeToggleText.textContent = '–°–≤–µ—Ç–ª–∞—è';
    } else {
      themeToggleIcon.textContent = 'üåô';
      themeToggleText.textContent = '–¢—ë–º–Ω–∞—è';
    }
  }
  function loadTheme() {
    const saved = localStorage.getItem(THEME_KEY);
    const theme = saved === 'light' || saved === 'dark' ? saved : 'dark';
    applyTheme(theme);
  }
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    localStorage.setItem(THEME_KEY, next);
  }
  themeToggleBtn.addEventListener('click', toggleTheme);

  // --- Notifications ---
  const NOTIF_KEY = 'venik-notifications';
  let notifications = [];
  let unreadCount = 0;

  function loadNotifications() {
    const raw = localStorage.getItem(NOTIF_KEY);
    notifications = raw ? JSON.parse(raw) : [];
    unreadCount = notifications.filter(n => !n.read).length;
    updateNotifUI();
  }
  function saveNotifications() {
    localStorage.setItem(NOTIF_KEY, JSON.stringify(notifications));
  }
  function formatTime(date) {
    const d = new Date(date);
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return hh + ':' + mm;
  }
  function addNotification(text, type) {
    const newNotif = {
      id: Date.now().toString() + Math.random().toString(16).slice(2),
      text,
      type,
      createdAt: new Date().toISOString(),
      read: false
    };
    notifications.unshift(newNotif);
    unreadCount++;
    saveNotifications();
    updateNotifUI();
  }
  window.addNotification = addNotification;

  function updateNotifUI() {
    if (unreadCount > 0) {
      bellBadge.classList.remove('hidden');
      bellBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
    } else {
      bellBadge.classList.add('hidden');
    }

    notifList.innerHTML = '';
    if (!notifications.length) {
      const p = document.createElement('p');
      p.style.fontSize = '12px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–ü–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç.';
      notifList.appendChild(p);
      return;
    }
    notifications.forEach(n => {
      const item = document.createElement('div');
      item.className = 'notif-item' + (n.read ? '' : ' new');
      const main = document.createElement('div');
      main.className = 'notif-main';
      const txt = document.createElement('div');
      txt.className = 'notif-text';
      txt.textContent = n.text;
      const time = document.createElement('div');
      time.className = 'notif-time';
      time.textContent = formatTime(n.createdAt);
      main.appendChild(txt);
      main.appendChild(time);
      item.appendChild(main);
      notifList.appendChild(item);
    });
  }

  notifMarkReadBtn.addEventListener('click', () => {
    notifications.forEach(n => n.read = true);
    unreadCount = 0;
    saveNotifications();
    updateNotifUI();
  });
  notifClearBtn.addEventListener('click', () => {
    notifications = [];
    unreadCount = 0;
    saveNotifications();
    updateNotifUI();
  });

  if (sidebarNotifItem) {
    sidebarNotifItem.addEventListener('click', () => {
      showPage('notifications');
    });
  }

  // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è ---
  function showPage(pageName) {
    pageSections.forEach(sec => {
      sec.classList.toggle('hidden', sec.id !== 'page-' + pageName);
    });
    sidebarItems.forEach(i => {
      const isNotif = pageName === 'notifications' && i.id === 'sidebar-notif-item';
      i.classList.toggle('active', i.dataset.page === pageName || isNotif);
    });

    if (pageName === 'schedule') renderSchedule();
    if (pageName === 'tasks') renderTasksForDay(currentTasksDay);
    if (pageName === 'rating') { renderRating(); renderRatingHistory(); }
    if (pageName === 'admin') loadAdminVisits();
  }

  document.querySelectorAll('[data-page]').forEach(el => {
    el.addEventListener('click', () => {
      const page = el.dataset.page;
      if (!page) return;
      if (page === 'profile') {
        viewedProfileUid = null;
        applyProfileToUI();
      }
      showPage(page);
    });
  });

  // --- –ü—Ä–æ—Ñ–∏–ª—å ---
  const PROFILE_KEY = 'venik-profile';
  let profile = {
    avatarUrl: 'https://media.tenor.com/Bn0kC0Fd03MAAAAd/pixel-cat.gif', // –ø—Ä–∏–º–µ—Ä gif, –ø–æ—Å—Ç–∞–≤—å —Å–≤–æ–π
    name: '–í–µ–Ω–∏–∫ –í–µ–Ω–∏–∫–æ–≤',
    city: '–û—Ä–µ—Ö–æ–≤–æ-–ó—É–µ–≤–æ',
    className: '8–ë',
    favSubjects: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'
  };
  let currentUser = null;
  let viewedProfileUid = null;

  function validateName(raw) {
    const name = (raw || '').trim();
    if (name.length < 2 || name.length > 24) {
      return { ok: false, reason: '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 24 —Å–∏–º–≤–æ–ª–æ–≤.' };
    }
    const allowedRe = /^[A-Za-z–ê-–Ø–∞-—è–Å—ë \-]+$/u;
    if (!allowedRe.test(name)) {
      return { ok: false, reason: '–ò–º—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, –ø—Ä–æ–±–µ–ª –∏ –¥–µ—Ñ–∏—Å.' };
    }
    const badWords = [
      '—Ö—É–π','—Ö—É–µ','—Ö–µ—Ä','–ø–∏–∑–¥','–µ–±–∞','–µ–±–ª','–º—É–¥–∞–∫','—Å—É–∫–∞','–±–ª—è–¥','–ª–æ—Ö',
      'idiot','fuck','shit','bitch','asshole'
    ];
    const lower = name.toLowerCase();
    if (badWords.some(w => lower.includes(w))) {
      return { ok: false, reason: '–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –º–∞—Ç –≤ –∏–º–µ–Ω–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.' };
    }
    return { ok: true, reason: '' };
  }

  function applyProfileToUI() {
    const isOwn = !viewedProfileUid || !currentUser || viewedProfileUid === currentUser.uid;
    const avatar = profile.avatarUrl || 'teacher.jpg';

    avatarSmallImg.src = avatar;
    sidebarAvatarImg.src = avatar;
    if (isOwn) profileAvatarImg.src = avatar;

    topbarTitle.textContent = '–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞';
    sidebarName.textContent = '–î–Ω–µ–≤–Ω–∏–∫ –í–µ–Ω–∏–∫–∞';

    topbarName.textContent = (profile.name || '–ü—Ä–æ—Ñ–∏–ª—å') + ' ‚ñæ';
    sidebarClass.textContent = profile.className + ' –∫–ª–∞—Å—Å';

    if (isOwn) {
      profileNameDisplay.textContent = profile.name;
      profileClassDisplay.textContent = `–£—á–µ–Ω–∏–∫ ${profile.className} –∫–ª–∞—Å—Å–∞`;
      profileNameInfo.textContent = profile.name;
      profileCityInfo.textContent = profile.city;
      profileClassInfo.textContent = profile.className;
      profileFavInfo.textContent = profile.favSubjects;
      profileEmailInfo.textContent = currentUser ? (currentUser.email || '–±–µ–∑ –ø–æ—á—Ç—ã') : '‚Äî';
    }

    avatarInput.value = profile.avatarUrl;
    nameInput.value = profile.name;
    cityInput.value = profile.city;
    classInput.value = profile.className;
    favInput.value = profile.favSubjects;

    const profileForm = document.querySelector('.profile-form');
    if (profileForm) profileForm.style.display = isOwn ? 'block' : 'none';

    if (profileMessageBtn) {
      profileMessageBtn.style.display = (!isOwn && currentUser) ? 'inline-flex' : 'none';
    }
  }
  window.applyProfileToUI = applyProfileToUI;

  async function loadUserQuarterDoc(uid, quarter) {
    const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      return {
        grades_w1: [],
        grades_w2: [],
        grades_w3: [],
        grades_w4: [],
        profile,
        tasksDone,
        ratingHistory: loadRatingHistory(),
        avgByWeek: {}
      };
    }
    const data = snap.data();
    return {
      grades_w1: data.grades_w1 || [],
      grades_w2: data.grades_w2 || [],
      grades_w3: data.grades_w3 || [],
      grades_w4: data.grades_w4 || [],
      profile: data.profile || profile,
      tasksDone: data.tasksDone || tasksDone,
      ratingHistory: data.ratingHistory || [],
      avgByWeek: data.avgByWeek || {}
    };
  }

  async function saveUserQuarterDoc(uid, quarter) {
    const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
    const avgThisWeek = getMyAverage();
    const payload = {
      profile,
      tasksDone,
      ratingHistory: loadRatingHistory(),
      avgByWeek: {
        [currentWeek]: avgThisWeek || 0
      }
    };
    payload['grades_w' + currentWeek] = grades;
    await setDoc(ref, payload, { merge: true });
  }

  async function loadProfile() {
    const raw = localStorage.getItem(PROFILE_KEY);
    if (raw) {
      try { profile = Object.assign(profile, JSON.parse(raw)); } catch(e){}
    }
    if (currentUser) {
      const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
      profile = Object.assign(profile, data.profile || {});
    }
    if (currentUser) {
      await setDoc(doc(db, 'users', currentUser.uid), {
        uid: currentUser.uid,
        email: currentUser.email || null,
        name: profile.name,
        avatarUrl: profile.avatarUrl || '',
        className: profile.className || '',
        city: profile.city || '',
        lastSeen: serverTimestamp()
      }, { merge: true });
    }
  }

  async function saveProfile() {
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    if (!currentUser) return;
    await saveUserQuarterDoc(currentUser.uid, currentQuarter);
    await setDoc(doc(db, 'users', currentUser.uid), {
      uid: currentUser.uid,
      email: currentUser.email || null,
      name: profile.name,
      avatarUrl: profile.avatarUrl || '',
      className: profile.className || '',
      city: profile.city || '',
      lastSeen: serverTimestamp()
    }, { merge: true });
  }

  profileSaveBtn.addEventListener('click', async () => {
    const rawName = nameInput.value.trim();
    const check = validateName(rawName);
    if (!check.ok) {
      alert(check.reason);
      return;
    }
    profile.avatarUrl = avatarInput.value.trim();
    profile.name = rawName;
    profile.city = cityInput.value.trim() || '–û—Ä–µ—Ö–æ–≤–æ-–ó—É–µ–≤–æ';
    profile.className = classInput.value.trim() || '–ö–ª–∞—Å—Å';
    profile.favSubjects = favInput.value.trim() || '–ù–µ—Ç';

    await saveProfile();
    applyProfileToUI();
    renderAllByDate();
    addNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'profile');
    alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  });

  async function loadProfileOfUser(uid, quarter) {
    const ref = doc(db, 'users', uid, 'quarters', 'q' + quarter);
    const snap = await getDoc(ref);
    if (!snap.exists()) return null;
    const data = snap.data() || {};
    const prof = data.profile || {};
    return {
      profile: {
        avatarUrl: prof.avatarUrl || 'teacher.jpg',
        name: prof.name || '–£—á–µ–Ω–∏–∫',
        city: prof.city || '–ì–æ—Ä–æ–¥',
        className: prof.className || '–ö–ª–∞—Å—Å',
        favSubjects: prof.favSubjects || '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞'
      }
    };
  }

  async function openProfileForUser(uid) {
    if (!uid || !currentUser) return;
    viewedProfileUid = uid;
    const foreign = await loadProfileOfUser(uid, currentQuarter);
    if (!foreign) {
      alert('–ü—Ä–æ—Ñ–∏–ª—å —ç—Ç–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –µ—â—ë –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω.');
      return;
    }
    const p = foreign.profile;
    const avatar = p.avatarUrl || 'teacher.jpg';
    profileAvatarImg.src = avatar;
    profileNameDisplay.textContent = p.name;
    profileClassDisplay.textContent = `–£—á–µ–Ω–∏–∫ ${p.className} –∫–ª–∞—Å—Å–∞`;
    profileNameInfo.textContent = p.name;
    profileCityInfo.textContent = p.city;
    profileClassInfo.textContent = p.className;
    profileFavInfo.textContent = p.favSubjects;
    profileEmailInfo.textContent = (currentUser && uid === currentUser.uid)
      ? (currentUser.email || '–±–µ–∑ –ø–æ—á—Ç—ã')
      : '–°–∫—Ä—ã—Ç–æ';

    const profileForm = document.querySelector('.profile-form');
    if (profileForm) {
      profileForm.style.display = (currentUser && uid === currentUser.uid) ? 'block' : 'none';
    }

    if (profileMessageBtn) {
      const isOwn = currentUser && uid === currentUser.uid;
      profileMessageBtn.style.display = (!isOwn && currentUser) ? 'inline-flex' : 'none';
      profileMessageBtn.onclick = () => {
        if (!currentUser) return;
        if (typeof window.openChatForUid === 'function') {
          window.openChatForUid(uid);
        }
        showPage('chat');
      };
    }

    showPage('profile');
  }
  window.openProfileForUser = openProfileForUser;

  // --- –û—Ü–µ–Ω–∫–∏ / —á–µ—Ç–≤–µ—Ä—Ç–∏ / –Ω–µ–¥–µ–ª–∏ ---
  const GRADES_PREFIX = 'venik-grades-q';
  let currentQuarter = 1;
  let currentWeek = 1;
  let grades = [];

  const quarterBtns = document.querySelectorAll('.quarter-btn');
  const weekBtns = document.querySelectorAll('.week-btn');
  const currentQuarterLabel = document.getElementById('current-quarter-label');
  const currentWeekLabel = document.getElementById('current-week-label');

  function storageKeyFor(quarter, week) {
    return `${GRADES_PREFIX}${quarter}-w${week}`;
  }

  async function loadGrades() {
    if (!currentUser) {
      const raw = localStorage.getItem(storageKeyFor(currentQuarter, currentWeek));
      grades = raw ? JSON.parse(raw) : [];
      return;
    }
    const data = await loadUserQuarterDoc(currentUser.uid, currentQuarter);
    grades = data['grades_w' + currentWeek] || [];
  }
  window.loadGrades = loadGrades;

  async function saveGrades() {
    localStorage.setItem(storageKeyFor(currentQuarter, currentWeek), JSON.stringify(grades));
    if (!currentUser) return;
    await saveUserQuarterDoc(currentUser.uid, currentQuarter);
  }
  window.saveGrades = saveGrades;

  async function switchQuarter(q) {
    currentQuarter = q;
    quarterBtns.forEach(b => b.classList.toggle('active', Number(b.dataset.quarter) === q));
    currentQuarterLabel.textContent = q + ' —á–µ—Ç–≤–µ—Ä—Ç—å';
    await switchWeek(1);
  }
  async function switchWeek(w) {
    currentWeek = w;
    weekBtns.forEach(b => b.classList.toggle('active', Number(b.dataset.week) === w));
    currentWeekLabel.textContent = w + ' –Ω–µ–¥–µ–ª—è';
    await loadGrades();
    renderAllByDate();
    renderSubjectsTable();
    renderSubjectList();
    await renderRating();
    renderRatingHistory();
  }
  window.switchQuarter = switchQuarter;
  window.switchWeek = switchWeek;

  quarterBtns.forEach(btn => btn.addEventListener('click', () => switchQuarter(Number(btn.dataset.quarter))));
  weekBtns.forEach(btn => btn.addEventListener('click', () => switchWeek(Number(btn.dataset.week))));

  const dayBlocksMap = {
    mon: document.getElementById('mon-block'),
    tue: document.getElementById('tue-block'),
    wed: document.getElementById('wed-block'),
    thu: document.getElementById('thu-block'),
    fri: document.getElementById('fri-block'),
    sat: document.getElementById('sat-block'),
    sun: document.getElementById('sun-block'),
  };
  function blockByDay(day) {
    return dayBlocksMap[day] || dayBlocksMap.mon;
  }
  function clearDayBlocks() {
    Object.values(dayBlocksMap).forEach(block => {
      block.querySelectorAll('.lesson-card').forEach(c => c.remove());
    });
  }

  function subjectBadgeClass(subject) {
    if (/–∞–ª–≥–µ–±—Ä–∞|–≥–µ–æ–º–µ—Ç—Ä–∏—è|—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫/i.test(subject)) return 'badge-math';
    if (/—Ä—É—Å—Å–∫–∏–π/i.test(subject)) return 'badge-ru';
    if (/–∞–Ω–≥–ª–∏–π/i.test(subject)) return 'badge-eng';
    if (/–∏–Ω—Ñ–æ—Ä–º–∞—Ç|–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç/i.test(subject)) return 'badge-it';
    if (/—Ñ–∏–∑–∏–∫–∞|—Ö–∏–º–∏—è|–±–∏–æ–ª–æ–≥/i.test(subject)) return 'badge-sci';
    if (/–≥–µ–æ–≥—Ä–∞—Ñ/i.test(subject)) return 'badge-geo';
    if (/–∏—Å—Ç–æ—Ä|–æ–±—â–µ/i.test(subject)) return 'badge-hist';
    if (/—Ñ–∏–∑–∏—á–µ—Å–∫/i.test(subject)) return 'badge-pe';
    return 'badge-other';
  }

  function createLessonCard(grade) {
    const card = document.createElement('article');
    card.className = 'lesson-card';
    card.dataset.id = grade.id;
    const badgeClass = subjectBadgeClass(grade.subject);
    card.innerHTML = `
      <div class="lesson-teacher">
        <img src="${profile.avatarUrl || 'teacher.jpg'}" alt="teacher">
      </div>
      <div class="lesson-main">
        <div class="lesson-subject">
          <span>${grade.subject} ‚Äî ${grade.mark}</span>
          <span class="badge ${badgeClass}">–æ—Ü–µ–Ω–∫–∞</span>
        </div>
        <div class="lesson-type">${grade.type}</div>
      </div>
      <div class="lesson-more" title="–£–¥–∞–ª–∏—Ç—å">‚úï</div>
    `;
    card.querySelector('.lesson-more').addEventListener('click', async () => {
      grades = grades.filter(g => g.id !== grade.id);
      await saveGrades();
      card.remove();
      renderSubjectsTable();
      renderSubjectList();
      await renderRating();
      saveRatingHistoryEntry();
      addNotification(`–£–¥–∞–ª–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞ ${grade.mark} –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${grade.subject}`, 'grade-delete');
    });
    return card;
  }
  function renderAllByDate() {
    clearDayBlocks();
    grades.forEach(g => {
      const block = blockByDay(g.day);
      block.appendChild(createLessonCard(g));
    });
  }
  window.renderAllByDate = renderAllByDate;

  addBtn.addEventListener('click', async () => {
    const subject = subjectSelect.value;
    const type = typeInput.value.trim();
    const mark = Number(markInput.value) || 0;
    const day = daySelect.value;
    if (!mark || mark < 1 || mark > 5) {
      alert('–í–≤–µ–¥–∏ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5');
      return;
    }
    const newGrade = {
      id: Date.now().toString() + '-' + Math.random().toString(16).slice(2),
      subject,
      type: type || '–†–∞–±–æ—Ç–∞',
      mark,
      day,
      quarter: currentQuarter,
      week: currentWeek
    };
    grades.push(newGrade);
    await saveGrades();
    blockByDay(day).appendChild(createLessonCard(newGrade));
    markInput.value = '';
    typeInput.value = '';
    renderSubjectsTable();
    renderSubjectList();
    await renderRating();
    saveRatingHistoryEntry();
    addNotification(`–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞ ${newGrade.mark} –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ${newGrade.subject}`, 'grade-add');
  });

  // --- –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º ---
  function calcAverage(arr) {
    if (!arr.length) return 0;
    const sum = arr.reduce((a, b) => a + b, 0);
    return sum / arr.length;
  }
  function groupBySubject() {
    const map = {};
    grades.forEach(g => {
      if (!map[g.subject]) map[g.subject] = [];
      map[g.subject].push(g.mark);
    });
    return map;
  }
  function renderSubjectsTable() {
    const groups = groupBySubject();
    subjectsTableBody.innerHTML = '';
    Object.keys(groups).forEach(subj => {
      const marks = groups[subj];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${subj}</td>
        <td>${marks.join(', ')}</td>
        <td>${calcAverage(marks).toFixed(2)}</td>
      `;
      subjectsTableBody.appendChild(tr);
    });
  }
  window.renderSubjectsTable = renderSubjectsTable;

  function renderSubjectList() {
    const groups = groupBySubject();
    subjectListDiv.innerHTML = '';
    const keys = Object.keys(groups);
    if (!keys.length) {
      subjectListDiv.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫ –¥–ª—è —ç—Ç–æ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ –∏ –Ω–µ–¥–µ–ª–∏.';
      return;
    }
    keys.forEach(subj => {
      const marks = groups[subj];
      const p = document.createElement('p');
      p.textContent = `${subj}: ${marks.join(', ')} (—Å—Ä. ${calcAverage(marks).toFixed(2)})`;
      subjectListDiv.appendChild(p);
    });
  }
  window.renderSubjectList = renderSubjectList;

  function getMyAverage() {
    const marks = grades.map(g => g.mark).filter(m => m > 0);
    return calcAverage(marks) || 0;
  }
  window.getMyAverage = getMyAverage;

  // --- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ---
  const SCHEDULE = {
    '–ü–Ω': [
      { id: 'mon-1', num: 1, time: '08:30 - 09:00', subject: '–†–∞–∑–≥–æ–≤–æ—Ä—ã –æ –≤–∞–∂–Ω–æ–º', room: '–î–ë / –∫–æ—Ä–ø—É—Å 1' },
      { id: 'mon-2', num: 2, time: '09:10 - 09:55', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 28' },
      { id: 'mon-3', num: 3, time: '10:05 - 10:50', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 28' },
      { id: 'mon-4', num: 4, time: '11:05 - 11:50', subject: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', room: '–∫–∞–±. 38' },
      { id: 'mon-5', num: 5, time: '‚Äî', subject: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', room: '–∫–∞–±. 59' },
      { id: 'mon-6', num: 6, time: '13:00 - 13:45', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 27' },
      { id: 'mon-7', num: 7, time: '14:00 - 14:40', subject: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç', room: '–∫–∞–±. 48' }
    ],
    '–í—Ç': [
      { id: 'tue-1', num: 1, time: '08:30 - 09:15', subject: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', room: '–∫–∞–±. 38' },
      { id: 'tue-2', num: 2, time: '09:25 - 10:10', subject: '–ê–ª–≥–µ–±—Ä–∞', room: '–∫–∞–±. 38' },
      { id: 'tue-3', num: 3, time: '10:20 - 11:05', subject: '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', room: '–∫–∞–±. 53' },
      { id: 'tue-4', num: 4, time: '11:20 - 12:05', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 49' },
      { id: 'tue-5', num: 5, time: '12:25 - 13:10', subject: '–ò—Å—Ç–æ—Ä–∏—è', room: '–∫–∞–±. 11' },
      { id: 'tue-6', num: 6, time: '13:20 - 14:05', subject: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞', room: '—Å–ø–æ—Ä—Ç–∑–∞–ª' }
    ],
    '–°—Ä': [
      { id: 'wed-1', num: 1, time: '08:30 - 09:15', subject: '–ê–ª–≥–µ–±—Ä–∞', room: '–∫–∞–±. 38' },
      { id: 'wed-2', num: 2, time: '09:25 - 10:10', subject: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', room: '–∫–∞–±. 48' },
      { id: 'wed-3', num: 3, time: '10:20 - 11:05', subject: '–§–∏–∑–∏–∫–∞', room: '–∫–∞–±. 52' },
      { id: 'wed-4', num: 4, time: '11:20 - 12:05', subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', room: '–∫–∞–±. 28' },
      { id: 'wed-5', num: 5, time: '12:25 - 13:10', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 27' }
    ],
    '–ß—Ç': [
      { id: 'thu-1', num: 1, time: '08:30 - 09:15', subject: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', room: '–∫–∞–±. 38' },
      { id: 'thu-2', num: 2, time: '09:25 - 10:10', subject: '–ë–∏–æ–ª–æ–≥–∏—è', room: '–∫–∞–±. 47' },
      { id: 'thu-3', num: 3, time: '10:20 - 11:05', subject: '–ò—Å—Ç–æ—Ä–∏—è', room: '–∫–∞–±. 11' },
      { id: 'thu-4', num: 4, time: '11:20 - 12:05', subject: '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ', room: '–∫–∞–±. 11' },
      { id: 'thu-5', num: 5, time: '12:25 - 13:10', subject: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞', room: '—Å–ø–æ—Ä—Ç–∑–∞–ª' }
    ],
    '–ü—Ç': [
      { id: 'fri-1', num: 1, time: '08:30 - 09:15', subject: '–ê–ª–≥–µ–±—Ä–∞', room: '–∫–∞–±. 38' },
      { id: 'fri-2', num: 2, time: '09:25 - 10:10', subject: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', room: '–∫–∞–±. 48' },
      { id: 'fri-3', num: 3, time: '10:20 - 11:05', subject: '–•–∏–º–∏—è', room: '–∫–∞–±. 49' },
      { id: 'fri-4', num: 4, time: '11:20 - 12:05', subject: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π) —è–∑—ã–∫', room: '–∫–∞–±. 27' },
      { id: 'fri-5', num: 5, time: '12:25 - 13:10', subject: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞', room: '—Å–ø–æ—Ä—Ç–∑–∞–ª' }
    ],
    '–°–±': [],
    '–í—Å': []
  };

  function renderScheduleTabs() {
    scheduleDayTabs.innerHTML = '';
    const days = Object.keys(SCHEDULE);
    days.forEach((day, idx) => {
      const btn = document.createElement('button');
      btn.className = 'day-tab' + (idx === 0 ? ' active' : '');
      btn.textContent = day;
      btn.dataset.day = day;
      btn.addEventListener('click', () => {
        document.querySelectorAll('#schedule-day-tabs .day-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderSchedule(day);
      });
      scheduleDayTabs.appendChild(btn);
    });
  }

  function renderSchedule(dayName) {
    const day = dayName || (document.querySelector('#schedule-day-tabs .day-tab.active')?.dataset.day || '–ü–Ω');
    scheduleContainer.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'day-title';
    title.innerHTML = `<div class="day-icon">üìö</div><span>${day}</span>`;
    scheduleContainer.appendChild(title);

    const list = SCHEDULE[day] || [];
    if (!list.length) {
      const p = document.createElement('p');
      p.style.fontSize = '13px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–í —ç—Ç–æ—Ç –¥–µ–Ω—å —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç.';
      scheduleContainer.appendChild(p);
      return;
    }

    list.forEach(lesson => {
      const row = document.createElement('div');
      row.className = 'task-row';
      row.innerHTML = `
        <div style="font-size:12px;font-weight:500;">${lesson.num} —É—Ä–æ–∫</div>
        <div style="flex:1;">
          <div style="font-size:13px;">${lesson.subject}</div>
          <div class="task-meta">${lesson.time} ¬∑ ${lesson.room}</div>
        </div>
      `;
      scheduleContainer.appendChild(row);
    });
  }

  // --- –î–æ–º–∞—à–∫–∞ ---
  const tasksByDay = {};
  const TASKS_KEY = 'venik-tasks';
  let tasksDone = {};
  let currentTasksDay = '–ü–Ω';

  function initTasksStructure() {
    Object.keys(SCHEDULE).forEach(day => {
      tasksByDay[day] = [];
    });
  }

  function loadTasks() {
    const raw = localStorage.getItem(TASKS_KEY);
    if (raw) {
      try {
        const data = JSON.parse(raw);
        Object.assign(tasksByDay, data.tasksByDay || {});
        tasksDone = data.tasksDone || {};
      } catch(e){}
    }
  }

  function saveTasks() {
    localStorage.setItem(TASKS_KEY, JSON.stringify({ tasksByDay, tasksDone }));
    if (currentUser) {
      saveUserQuarterDoc(currentUser.uid, currentQuarter);
    }
  }

  function renderTasksTabs() {
    tasksDayTabs.innerHTML = '';
    Object.keys(SCHEDULE).forEach((day, idx) => {
      const btn = document.createElement('button');
      btn.className = 'day-tab' + (idx === 0 ? ' active' : '');
      btn.textContent = day;
      btn.dataset.day = day;
      btn.addEventListener('click', () => {
        currentTasksDay = day;
        document.querySelectorAll('#tasks-day-tabs .day-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderTasksForDay(day);
      });
      tasksDayTabs.appendChild(btn);
    });
  }

  function renderTasksForDay(dayName) {
    const day = dayName || currentTasksDay;
    tasksContainer.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'day-title';
    title.innerHTML = `<div class="day-icon">üìò</div><span>${day}</span>`;
    tasksContainer.appendChild(title);

    const list = tasksByDay[day] || [];
    if (!list.length) {
      const p = document.createElement('p');
      p.style.fontSize = '13px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–î–æ–º–∞—à–∫–∏ –ø–æ–∫–∞ –Ω–µ—Ç. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é –≤ –∫–æ–¥–µ.';
      tasksContainer.appendChild(p);
      return;
    }

    const filter = tasksFilterSelect.value;

    list.forEach(task => {
      const key = task.id;
      const done = !!tasksDone[key];
      if (filter === 'todo' && done) return;
      if (filter === 'done' && !done) return;

      const row = document.createElement('div');
      row.className = 'task-row' + (done ? ' done' : '');
      row.innerHTML = `
        <input type="checkbox" ${done ? 'checked' : ''}>
        <div style="flex:1;">
          <div>${task.subject}: ${task.text}</div>
          <div class="task-meta">–ù–∞ ${task.due || '–∑–∞–≤—Ç—Ä–∞'}</div>
        </div>
      `;
      const checkbox = row.querySelector('input');
      checkbox.addEventListener('change', () => {
        tasksDone[key] = checkbox.checked;
        saveTasks();
        renderTasksForDay(day);
      });
      tasksContainer.appendChild(row);
    });
  }

  tasksFilterSelect.addEventListener('change', () => renderTasksForDay(currentTasksDay));

  // --- –†–µ–π—Ç–∏–Ω–≥ ---
  const RATING_HISTORY_KEY = 'venik-rating-history';
  function loadRatingHistory() {
    const raw = localStorage.getItem(RATING_HISTORY_KEY);
    if (!raw) return [];
    try { return JSON.parse(raw); } catch(e){ return []; }
  }
  function saveRatingHistory(history) {
    localStorage.setItem(RATING_HISTORY_KEY, JSON.stringify(history));
  }
  function saveRatingHistoryEntry() {
    const history = loadRatingHistory();
    history.push({
      ts: new Date().toISOString(),
      avg: getMyAverage()
    });
    saveRatingHistory(history);
  }
  function renderRatingHistory() {
  const history = loadRatingHistory();
  if (!history.length) {
    ratingHistoryDiv.textContent = '–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞.';
    return;
  }

  // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏, –≥–¥–µ avg ‚Äî —á–∏—Å–ª–æ
  const cleaned = history
    .filter(h => typeof h.avg === 'number' && !isNaN(h.avg));

  if (!cleaned.length) {
    ratingHistoryDiv.textContent = '–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞.';
    return;
  }


  const last = cleaned.slice(-5);
  ratingHistoryDiv.textContent =
    '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: ' +
    last
      .map(h => {
        const avg = (typeof h.avg === 'number' && !isNaN(h.avg)) ? h.avg : 0;
        return `${new Date(h.ts).toLocaleString()} ‚Äî —Å—Ä. ${avg.toFixed(2)}`;
      })
      .join('; ');
}


  async function renderRating() {
    if (!ratingTableBody) return;
    ratingTableBody.innerHTML = '';
    const avg = getMyAverage();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>1</td>
      <td>${profile.name}</td>
      <td>${avg.toFixed(2)}</td>
    `;
    ratingTableBody.appendChild(tr);
  }
  ratingRefreshBtn.addEventListener('click', async () => {
    await renderRating();
    renderRatingHistory();
  });

  // --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ---
  function detectDeviceType(ua) {
    const s = (ua || '').toLowerCase();
    if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(s)) return '–ü–ª–∞–Ω—à–µ—Ç';
    if (/mobile|iphone|ipod|android|blackberry|iemobile/i.test(s)) return '–ú–æ–±–∏–ª–∫–∞';
    return '–ü–ö';
  }

  function detectDeviceName(ua) {
    if (!ua) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    if (ua.includes('Windows NT 10')) return 'Windows 10 –ü–ö';
    if (ua.includes('Windows NT 11')) return 'Windows 11 –ü–ö';
    if (ua.includes('Macintosh')) return 'Mac';
    if (ua.includes('iPhone')) return 'iPhone';
    if (ua.includes('iPad')) return 'iPad';
    if (ua.includes('Android')) return 'Android —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
    return ua.split(')')[0] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  }

  // --- –ê–¥–º–∏–Ω –≤–∏–∑–∏—Ç—ã + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---
  let adminPeriod = '7d';
  let adminFilterClass = '';
  let adminFilterEmail = '';

  function getPeriodBounds(period) {
    const now = new Date();
    let start = new Date(0);
    let end = new Date(now);

    if (period === 'today') {
      start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (period === 'yesterday') {
      const y = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      end = new Date(y.getTime() - 1);
      start = new Date(y.getTime() - 24 * 60 * 60 * 1000);
    } else if (period === '7d') {
      start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (period === '30d') {
      start = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    }
    return { start, end };
  }

  function passTextFilters(v) {
    if (adminFilterEmail) {
      const email = (v.email || '').toLowerCase();
      if (!email.includes(adminFilterEmail.toLowerCase())) return false;
    }
    if (adminFilterClass) {
      const cls = (v.className || '').toLowerCase();
      if (!cls.includes(adminFilterClass.toLowerCase())) return false;
    }
    return true;
  }

  async function logVisit(user) {
    try {
      const ua = navigator.userAgent || '';
      const deviceType = detectDeviceType(ua);
      const deviceName = detectDeviceName(ua);
      await addDoc(collection(db, 'visits'), {
        uid: user ? user.uid : null,
        email: user ? user.email : null,
        userAgent: ua,
        language: navigator.language,
        screen: `${window.screen.width}x${window.screen.height}`,
        className: profile.className || '',
        deviceType,
        deviceName,
        createdAt: serverTimestamp()
      });
    } catch (e) {
      console.error('logVisit error', e);
    }
  }

  async function computeTodayStats(allVisits) {
    const now = new Date();
    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let totalVisitsToday = 0;
    const uniqUsersToday = new Set();
    let maxPerHour = 0;
    const byHour = {};

    allVisits.forEach(v => {
      if (!v.createdAt) return;
      const d = v.createdAt.toDate ? v.createdAt.toDate() : new Date(v.createdAt);
      if (d < startOfDay) return;
      totalVisitsToday++;
      if (v.uid) uniqUsersToday.add(v.uid);
      const h = d.getHours();
      byHour[h] = (byHour[h] || 0) + 1;
    });

    Object.values(byHour).forEach(cnt => {
      if (cnt > maxPerHour) maxPerHour = cnt;
    });

    return {
      totalVisitsToday,
      uniqueToday: uniqUsersToday.size,
      maxPerHour,
      byHour
    };
  }

  async function computePeriodStats(allVisits, start, end) {
    const byDate = {};
    allVisits.forEach(v => {
      if (!v.createdAt) return;
      const d = v.createdAt.toDate ? v.createdAt.toDate() : new Date(v.createdAt);
      if (d < start || d > end) return;
      const key = d.toISOString().slice(0, 10);
      if (!byDate[key]) byDate[key] = { visits: 0, uniq: new Set() };
      byDate[key].visits++;
      if (v.uid) byDate[key].uniq.add(v.uid);
    });

    const rows = Object.keys(byDate).sort().map(date => {
      const obj = byDate[date];
      return {
        date,
        visits: obj.visits,
        unique: obj.uniq.size
      };
    });

    let maxUsersDay = 0;
    rows.forEach(r => {
      if (r.unique > maxUsersDay) maxUsersDay = r.unique;
    });

    return { rows, maxUsersDay };
  }

  async function computeTopUsers(allVisits, start, end) {
    const map = {};
    allVisits.forEach(v => {
      if (!v.createdAt) return;
      const d = v.createdAt.toDate ? v.createdAt.toDate() : new Date(v.createdAt);
      if (d < start || d > end) return;

      const uid = v.uid || 'anon';
      if (!map[uid]) {
        map[uid] = { count: 0, email: v.email || '' };
      }
      map[uid].count++;
    });

    const list = Object.entries(map).map(([uid, obj]) => ({
      uid,
      email: obj.email,
      count: obj.count
    }));

    list.sort((a, b) => b.count - a.count);
    return list.slice(0, 10);
  }

  function computeDevicesStats(allVisits, start, end) {
    const uaCounts = {};
    const langCounts = {};
    const screenCounts = {};

    allVisits.forEach(v => {
      if (!v.createdAt) return;
      const d = v.createdAt.toDate ? v.createdAt.toDate() : new Date(v.createdAt);
      if (d < start || d > end) return;

      const type = v.deviceType || '–î—Ä—É–≥–æ–µ';
      const lang = (v.language || 'unknown');
      const scr = (v.screen || 'unknown');

      uaCounts[type] = (uaCounts[type] || 0) + 1;
      langCounts[lang] = (langCounts[lang] || 0) + 1;
      screenCounts[scr] = (screenCounts[scr] || 0) + 1;
    });

    return { uaCounts, langCounts, screenCounts };
  }

  async function computeOnlineNow() {
    const now = new Date();
    const ONLINE_WINDOW_MS = 60 * 1000;
    const usersSnap = await getDocs(collection(db, 'users'));
    let onlineCount = 0;

    usersSnap.forEach(uDoc => {
      const u = uDoc.data();
      if (!u.lastSeen) return;
      const last = u.lastSeen.toDate ? u.lastSeen.toDate() : new Date(u.lastSeen);
      if (now - last <= ONLINE_WINDOW_MS) {
        onlineCount++;
      }
    });

    return onlineCount;
  }

  async function renderAdminStatsFromVisits(allVisits) {
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) {
      if (adminWarning) {
        adminWarning.textContent = '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.';
      }
      if (adminStatsTodayDiv) {
        adminStatsTodayDiv.textContent = '';
        adminStatsOnlineDiv.textContent = '';
        adminStatsWeekDiv.textContent = '';
        adminStatsTopUsersDiv.textContent = '';
        adminStatsDevicesDiv.textContent = '';
        adminStatsAlertsDiv.textContent = '';
      }
      return;
    }

    if (adminWarning) adminWarning.textContent = '';

    const { start, end } = getPeriodBounds(adminPeriod);

    const todayStats = await computeTodayStats(allVisits);
    if (adminStatsTodayDiv) {
      adminStatsTodayDiv.textContent =
        `–≤–∏–∑–∏—Ç–æ–≤ ${todayStats.totalVisitsToday}, —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ${todayStats.uniqueToday}, –º–∞–∫—Å–∏–º—É–º –∑–∞ —á–∞—Å: ${todayStats.maxPerHour}`;
    }

    const onlineNow = await computeOnlineNow();
    if (adminStatsOnlineDiv) {
      adminStatsOnlineDiv.textContent = `${onlineNow}`;
    }

    const periodStats = await computePeriodStats(allVisits, start, end);
    if (adminStatsWeekDiv) {
      if (!periodStats.rows.length) {
        adminStatsWeekDiv.textContent = '–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –µ—â—ë –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
      } else {
        const txt = periodStats.rows
          .map(r => `${r.date}: –≤–∏–∑–∏—Ç–æ–≤ ${r.visits}, —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ${r.unique}`)
          .join('; ');
        adminStatsWeekDiv.textContent =
          `${txt}. –ú–∞–∫—Å. —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤ –¥–µ–Ω—å: ${periodStats.maxUsersDay}`;
      }
    }

    const topUsers = await computeTopUsers(allVisits, start, end);
    if (adminStatsTopUsersDiv) {
      if (!topUsers.length) {
        adminStatsTopUsersDiv.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
      } else {
        const line = topUsers
          .map((u, i) => `${i + 1}) ${u.email || u.uid} ‚Äî ${u.count} –≤–∏–∑–∏—Ç–æ–≤`)
          .join('; ');
        adminStatsTopUsersDiv.textContent = line;
      }
    }

    const devStats = computeDevicesStats(allVisits, start, end);
    if (adminStatsDevicesDiv) {
      const uaPart = Object.entries(devStats.uaCounts)
        .map(([k, v]) => `${k}: ${v}`)
        .join(', ');
      const langPart = Object.entries(devStats.langCounts)
        .map(([k, v]) => `${k}: ${v}`)
        .join(', ');
      const scrPart = Object.entries(devStats.screenCounts)
        .slice(0, 5)
        .map(([k, v]) => `${k}: ${v}`)
        .join(', ');

      adminStatsDevicesDiv.textContent =
        `${uaPart ? `–¢–∏–ø—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${uaPart}. ` : ''}${langPart ? `–Ø–∑—ã–∫–∏: ${langPart}. ` : ''}${scrPart ? `–¢–æ–ø —ç–∫—Ä–∞–Ω–æ–≤: ${scrPart}` : ''}`;
    }

    if (adminStatsAlertsDiv) {
      const alerts = [];
      if (todayStats.totalVisitsToday === 0) {
        alerts.push('–°–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ –±—ã–ª–æ –≤–∏–∑–∏—Ç–æ–≤.');
      }
      if (onlineNow === 0) {
        alerts.push('–°–µ–π—á–∞—Å –Ω–∞ —Å–∞–π—Ç–µ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç.');
      }
      if (periodStats.maxUsersDay > 0 && todayStats.uniqueToday > periodStats.maxUsersDay) {
        alerts.push('–°–µ–≥–æ–¥–Ω—è —Ä–µ–∫–æ—Ä–¥ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥!');
      }
      adminStatsAlertsDiv.textContent = alerts.join(' ');
    }
  }

  async function loadAdminVisits() {
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) {
      if (adminWarning) {
        adminWarning.textContent = '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.';
      }
      if (adminVisitsBody) adminVisitsBody.innerHTML = '';
      return;
    }
    if (adminWarning) adminWarning.textContent = '';

    adminVisitsBody.innerHTML = '';

    const visitsRef = collection(db, 'visits');
    const qRef = query(visitsRef, orderBy('createdAt', 'desc'));
    const snap = await getDocs(qRef);

    const allVisits = [];
    let i = 1;

    snap.forEach(docSnap => {
      const v = docSnap.data();
      if (!v.createdAt) return;
      const d = v.createdAt.toDate ? v.createdAt.toDate() : new Date(v.createdAt);
      const { start, end } = getPeriodBounds(adminPeriod);
      if (d < start || d > end) return;
      if (!passTextFilters(v)) return;

      allVisits.push(v);

      const deviceInfo = v.deviceName || '-';
      const deviceType = v.deviceType || '‚Äî';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i++}</td>
        <td>${d.toLocaleString()}</td>
        <td>${v.uid || '-'}<br>${v.email || '-'}</td>
        <td style="max-width:200px;word-break:break-all;">${deviceInfo}</td>
        <td>${deviceType}</td>
        <td>${v.language || '-'}</td>
        <td>${v.screen || '-'}</td>
        <td><button class="btn secondary" data-id="${docSnap.id}">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;
      tr.querySelector('button').addEventListener('click', async () => {
        await deleteDoc(doc(db, 'visits', docSnap.id));
        loadAdminVisits();
      });
      adminVisitsBody.appendChild(tr);
    });

    await renderAdminStatsFromVisits(allVisits);
  }
  window.loadAdminVisits = loadAdminVisits;

  if (adminApplyFiltersBtn) {
    adminApplyFiltersBtn.addEventListener('click', () => {
      adminPeriod = adminPeriodSelect ? adminPeriodSelect.value : '7d';
      adminFilterClass = adminClassFilterInput ? adminClassFilterInput.value.trim() : '';
      adminFilterEmail = adminEmailFilterInput ? adminEmailFilterInput.value.trim() : '';
      loadAdminVisits();
    });
  }

  // --- Auth ---
  async function doLogin() {
    authError.textContent = '';
    try {
      const userCred = await signInWithEmailAndPassword(auth, emailInput.value, passInput.value);
      currentUser = userCred.user;
    } catch (e) {
      authError.textContent = e.message;
    }
  }
  async function doSignup() {
    authError.textContent = '';
    try {
      const userCred = await createUserWithEmailAndPassword(auth, emailInput.value, passInput.value);
      currentUser = userCred.user;
    } catch (e) {
      authError.textContent = e.message;
    }
  }
  async function doLogout() {
    await signOut(auth);
  }

  loginBtn.addEventListener('click', doLogin);
  signupBtn.addEventListener('click', doSignup);
  logoutBtn.addEventListener('click', doLogout);

  // --- onAuthStateChanged ---
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (!user) {
      authPanel.classList.remove('hidden');
      appRoot.classList.add('hidden');
      return;
    }
    await setDoc(doc(db, 'users', user.uid), {
      lastSeen: serverTimestamp()
    }, { merge: true });

    authPanel.classList.add('hidden');
    appRoot.classList.remove('hidden');

    await loadProfile();
    loadTheme();
    loadNotifications();
    initTasksStructure();
    loadTasks();
    renderScheduleTabs();
    renderTasksTabs();
    await loadGrades();
    renderAllByDate();
    renderSubjectsTable();
    renderSubjectList();
    await renderRating();
    renderRatingHistory();
    showPage('journal');

    await logVisit(user);
  });

  // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —é–∑–µ—Ä —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
  loadTheme();
  loadNotifications();
</script>

       <script type="module">
  import {
    collection,
    doc,
    setDoc,
    addDoc,
    getDoc,
    getDocs,
    query,
    orderBy,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const auth = getAuth();
  const db = getFirestore();

  const chatDialogsList = document.getElementById('chat-dialogs-list');
  const chatMessagesDiv = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const chatCurrentName = document.getElementById('chat-current-name');
  const chatCurrentStatus = document.getElementById('chat-current-status');

  let chatUnsubMessages = null;
  let currentChatId = null;
  let currentChatPartner = null;

  function getCurrentUser() {
    return auth.currentUser || null;
  }

  function normalizeChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
  }

  function formatTimeShort(ts) {
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return hh + ':' + mm;
  }

  function clearMessages() {
    chatMessagesDiv.innerHTML = '';
  }

  function appendMessage(msg, isMine) {
    const bubble = document.createElement('div');
    bubble.className = 'chat-message' + (isMine ? ' me' : '');
    const textDiv = document.createElement('div');
    textDiv.textContent = msg.text;
    const metaDiv = document.createElement('div');
    metaDiv.className = 'chat-message-meta';
    metaDiv.textContent = formatTimeShort(msg.createdAt);
    bubble.appendChild(textDiv);
    bubble.appendChild(metaDiv);
    chatMessagesDiv.appendChild(bubble);
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
  }

  function setChatEnabled(enabled) {
    chatInput.disabled = !enabled;
    chatSendBtn.disabled = !enabled;
  }

  // ===== –°–ü–ò–°–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –î–õ–Ø –ß–ê–¢–ê =====

  async function loadChatUsersList() {
    const me = getCurrentUser();
    chatDialogsList.innerHTML = '';

    if (!me) {
      const p = document.createElement('p');
      p.style.fontSize = '12px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤.';
      chatDialogsList.appendChild(p);
      setChatEnabled(false);
      return;
    }

    const usersSnap = await getDocs(collection(db, 'users'));
    const items = [];
    usersSnap.forEach(uDoc => {
      const data = uDoc.data();
      if (!data.uid || data.uid === me.uid) return;
      items.push({
        uid: data.uid,
        name: data.name || '–£—á–µ–Ω–∏–∫',
        avatarUrl: data.avatarUrl || 'teacher.jpg',
        className: data.className || ''
      });
    });

    if (!items.length) {
      const p = document.createElement('p');
      p.style.fontSize = '12px';
      p.style.color = 'var(--text-muted)';
      p.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ó–∞–π–¥–∏ –ø–æ–¥ –¥—Ä—É–≥–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∞—Ç.';
      chatDialogsList.appendChild(p);
      setChatEnabled(false);
      return;
    }

    items.forEach(user => {
      const item = document.createElement('div');
      item.className = 'chat-dialog-item';
      item.dataset.uid = user.uid;

      const av = document.createElement('div');
      av.className = 'chat-dialog-avatar';
      av.innerHTML = `<img src="${user.avatarUrl}" alt="">`;

      const nameDiv = document.createElement('div');
      nameDiv.className = 'chat-dialog-name';
      nameDiv.textContent = user.name;

      const lastDiv = document.createElement('div');
      lastDiv.className = 'chat-dialog-last';
      lastDiv.textContent = '';

      item.appendChild(av);
      item.appendChild(nameDiv);
      item.appendChild(lastDiv);

      item.addEventListener('click', () => {
        document.querySelectorAll('.chat-dialog-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        openChatWith(user);
      });

      chatDialogsList.appendChild(item);
    });

    setChatEnabled(false);
    chatCurrentName.textContent = '–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–ª–µ–≤–∞';
    chatCurrentStatus.textContent = '';
  }
  window.loadChatUsersList = loadChatUsersList;

  // ===== –°–û–ó–î–ê–ù–ò–ï / –û–¢–ö–†–´–¢–ò–ï –ß–ê–¢–ê =====

  async function ensureChatDocument(uid1, uid2) {
    const chatId = normalizeChatId(uid1, uid2);
    const ref = doc(db, 'chats', chatId);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        users: [uid1, uid2],
        createdAt: serverTimestamp(),
        lastMessageAt: serverTimestamp()
      });
    }
    return { chatId, ref };
  }

  async function openChatWith(user) {
    const me = getCurrentUser();
    if (!me) return;

    if (chatUnsubMessages) {
      chatUnsubMessages();
      chatUnsubMessages = null;
    }

    const { chatId, ref } = await ensureChatDocument(me.uid, user.uid);
    currentChatId = chatId;
    currentChatPartner = user;

    chatCurrentName.textContent = user.name;
    chatCurrentStatus.textContent = user.className ? `–ö–ª–∞—Å—Å: ${user.className}` : '';
    setChatEnabled(true);
    clearMessages();

    const messagesRef = collection(ref, 'messages');
    const qRef = query(messagesRef, orderBy('createdAt', 'asc'));
    chatUnsubMessages = onSnapshot(qRef, (snapshot) => {
      clearMessages();
      snapshot.forEach(docSnap => {
        const m = docSnap.data();
        appendMessage(m, m.from === me.uid);
      });
    });

    updateLastMessageForDialog(user.uid);
  }
  window.openChatWith = openChatWith;

  async function updateLastMessageForDialog(partnerUid) {
    try {
      const me = getCurrentUser();
      if (!me) return;
      const chatId = normalizeChatId(me.uid, partnerUid);
      const ref = doc(db, 'chats', chatId);
      const messagesRef = collection(ref, 'messages');
      const qRef = query(messagesRef, orderBy('createdAt', 'desc'));
      const snap = await getDocs(qRef);
      let lastText = '';
      if (!snap.empty) {
        const m = snap.docs[0].data();
        lastText = (m.text || '').slice(0, 24);
      }

      const item = chatDialogsList.querySelector(`.chat-dialog-item[data-uid="${partnerUid}"]`);
      if (item) {
        const lastDiv = item.querySelector('.chat-dialog-last');
        if (lastDiv) lastDiv.textContent = lastText;
      }
    } catch (e) {
      console.error('updateLastMessageForDialog error', e);
    }
  }

  // ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =====

  async function sendMessage() {
    const me = getCurrentUser();
    if (!me || !currentChatId || !currentChatPartner) return;
    const text = chatInput.value.trim();
    if (!text) return;

    try {
      const chatRef = doc(db, 'chats', currentChatId);
      const messagesRef = collection(chatRef, 'messages');
      await addDoc(messagesRef, {
        from: me.uid,
        to: currentChatPartner.uid,
        text,
        createdAt: serverTimestamp()
      });
      await setDoc(chatRef, {
        lastMessageAt: serverTimestamp()
      }, { merge: true });

      chatInput.value = '';
      updateLastMessageForDialog(currentChatPartner.uid);
    } catch (e) {
      console.error('sendMessage error', e);
    }
  }

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ===== –û–¢–ö–†–´–¢–ò–ï –ß–ê–¢–ê –ò–ó –ü–†–û–§–ò–õ–Ø =====

  window.openChatForUid = async function (uid) {
    const me = getCurrentUser();
    if (!me || me.uid === uid) return;

    const uRef = doc(db, 'users', uid);
    const snap = await getDoc(uRef);
    if (!snap.exists()) {
      alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.');
      return;
    }
    const data = snap.data();
    const user = {
      uid: data.uid || uid,
      name: data.name || '–£—á–µ–Ω–∏–∫',
      avatarUrl: data.avatarUrl || 'teacher.jpg',
      className: data.className || ''
    };

    await loadChatUsersList();
    const item = chatDialogsList.querySelector(`.chat-dialog-item[data-uid="${user.uid}"]`);
    if (item) {
      document.querySelectorAll('.chat-dialog-item').forEach(el => el.classList.remove('active'));
      item.classList.add('active');
    }
    await openChatWith(user);
  };

  // ===== –†–ï–ê–ö–¶–ò–Ø –ù–ê –í–•–û–î / –í–´–•–û–î =====

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      if (chatUnsubMessages) {
        chatUnsubMessages();
        chatUnsubMessages = null;
      }
      currentChatId = null;
      currentChatPartner = null;
      chatDialogsList.innerHTML = '';
      clearMessages();
      setChatEnabled(false);
      chatCurrentName.textContent = '–í—ã–±–µ—Ä–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å–ª–µ–≤–∞';
      chatCurrentStatus.textContent = '';
      return;
    }

    await loadChatUsersList();
  });
</script>


</body>
</html>

